<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="Vert.x | Reactive applications on the JVM"/><meta name="robots" content="index,follow"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet"/><link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300,400" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&amp;display=swap" rel="stylesheet"/><link rel="shortcut icon" href="/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="48x48" href="/favicons/favicon-48x48.png"/><link rel="alternate" type="application/rss+xml" href="/feed/rss.xml"/><link rel="alternate" type="application/atom+xml" href="/feed/atom.xml"/><link rel="alternate" type="application/json" href="/feed/feed.json"/><title>Kotlin 协程 | Eclipse Vert.x</title><link rel="preload" href="https://api.github.com/repos/vert-x3/vertx-lang-kotlin" as="fetch" crossorigin="anonymous"/><meta name="next-head-count" content="17"/><link rel="preload" href="/_next/static/css/styles.f20dca63.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/styles.f20dca63.chunk.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-b6e20584df76f29b6f35.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-d7b2fb72fb7257504a38.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.fcef98db13e2318579fb.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.5b8771ac6e8a338f82f1.js" as="script"/><link rel="preload" href="/_next/static/chunks/styles.7064a0f84b2a7c13404a.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-3dbbc9c041333077c167.js" as="script"/><link rel="preload" href="/_next/static/chunks/5df0631eea625b022d3730b3f1bf573e1b8deb37.3b9874ba65db13e7d868.js" as="script"/><link rel="preload" href="/_next/static/chunks/31acfd8439b7c9eee4abe9f59c7500d6c943ee0d.7cf166b02b2c6c50cd71.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/docs/%5B%5B...slug%5D%5D-f144718c033f8d0b431b.js" as="script"/></head><body><div id="__next"><main class="page docs"><header><div class="navbar"><div class="navbar-content container"><div class="navbar-logo"><a href="/"><img src="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjAiIHk9IjAiIHZpZXdCb3g9IjAgMCAxMTI1LjYgMzE1LjIiIHhtbDpzcGFjZT0icHJlc2VydmUiPjxzdHlsZT4uc3Qwe2ZpbGw6Izc4MmE5MX08L3N0eWxlPjxwYXRoIGQ9Ik0xMjAuOSAyMTQuMkwxOTAuNSAwaDUyLjNsLTk4LjUgMjczLjhIOTguMkwwIDBoNTIuMWw2OC44IDIxNC4yem0yOTEuMi02Mi42SDI5OS42djg0LjJINDMxdjM4SDI1MlYwaDE3Ny43djM4LjRIMjk5LjZWMTE0aDExMi41djM3LjZ6bTgzLjctMTEzLjJINTQ2YzE2LjUuMyAyOSA0LjQgMzcuMyAxMi40IDguMyA4IDEyLjUgMTkuNCAxMi41IDM0IDAgMTQtNC41IDI1LjEtMTMuNSAzMy4yLTkgOC4xLTIxLjYgMTIuMS0zNy42IDEyLjFoLTI3LjF2MjQuMmw4Ni4xIDExOS41aDUxdi0yLjRsLTc3LjItMTA2LjdjMjQuOS01LjUgNDMuMy0yMS43IDUyLjYtMzUuOSA4LjItMTIuNiAxMy4zLTI3LjcgMTMuMy00NiAwLTI2LjgtOC42LTQ3LjQtMjUuOC02MS41QzYwMC41IDcuMSA1NzYuMSAwIDU0NC41IDBoLTk2LjN2MjczLjhoNDcuNiIvPjxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0xMDUyLjMgMTU3LjdsLTQxLjUgNjIuNyAyOS43IDUzLjRoODUuMXoiLz48Y2lyY2xlIGNsYXNzPSJzdDAiIGN4PSI4MjcuOSIgY3k9IjI3NC43IiByPSI0MC41Ii8+PHBhdGggY2xhc3M9InN0MCIgZD0iTTEwMzcgMGwtNDcuNiA3NC4yTDk0OSAwaC04NGw4NS4zIDEzNS44LTY3LjEgMTA1LjdjNS43IDkuNSA5LjEgMjAuNSA5LjIgMzIuNGg1MC4xTDExMjEuMyAwSDEwMzd6Ii8+PHBhdGggZD0iTTc2My41IDI3My44Yy4xLTkuOSAyLjUtMTkuMiA2LjYtMjcuNVYzOC40aDg1LjRWMEg2MzguMnYzOC40aDg0LjZ2MjM1LjRoNDAuN3oiLz48L3N2Zz4=" alt="Vert.x Logo"/></a></div><div class="navbar-collapse-button"><span></span><span></span><span></span></div><div class="navbar-right"><div class="navbar-menu"><span class="navbar-menu-item with-drop-down"><div class="dropdown"><a class="dropdown-title">开始<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></a><ul class="dropdown-menu"><a href="/introduction-to-vertx-and-reactive/"><li class="dropdown-item">简介</li></a><a href="/get-started/"><li class="dropdown-item">开始</li></a><a href="https://start.vertx.io/" target="_blank" rel="noreferrer"><li class="dropdown-item">App generator <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-link-icon"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></li></a></ul></div></span><a class="navbar-menu-item" href="/docs/">文档</a><span class="navbar-menu-item with-drop-down"><div class="dropdown"><a class="dropdown-title">资源<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></a><ul class="dropdown-menu"><a href="/faq/"><li class="dropdown-item">答疑</li></a><a href="/channels/"><li class="dropdown-item">Channels</li></a><a href="https://how-to.vertx.io/" target="_blank" rel="noreferrer"><li class="dropdown-item">How-To’s <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-link-icon"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></li></a><a href="https://github.com/vert-x3/vertx-eventbus-bridge-clients" target="_blank" rel="noreferrer"><li class="dropdown-item">EventBus Bridge Clients <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-link-icon"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></li></a></ul></div></span><a class="navbar-menu-item" href="/blog/">博客</a><a class="navbar-menu-item" href="/community/">社区</a><a class="navbar-menu-item" href="/translation/">翻译团队</a></div><div class="navbar-social"><a href="https://github.com/vert-x3/vertx-awesome" class="navbar-social-link" title="Awesome Vert.x" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="List of awesome Vert.x projects"><title>Awesome Vert.x</title><path d="M24 11.438l-6.154-5.645-.865.944 5.128 4.7H1.895l5.128-4.705-.865-.943-6.154 5.649H0v3.72c0 1.683 1.62 3.053 3.61 3.053h3.795c1.99 0 3.61-1.37 3.61-3.051v-2.446h1.97v2.446c0 1.68 1.62 3.051 3.61 3.051h3.794c1.99 0 3.61-1.37 3.61-3.051v-3.721z"></path></svg></a><a href="https://stackoverflow.com/questions/tagged/vert.x" class="navbar-social-link" title="Stack Overflow" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="Stack Overflow questions related to Vert.x"><title>Stack Overflow</title><path d="M18.986 21.865v-6.404h2.134V24H1.844v-8.539h2.13v6.404h15.012zM6.111 19.731H16.85v-2.137H6.111v2.137zm.259-4.852l10.48 2.189.451-2.07-10.478-2.187-.453 2.068zm1.359-5.056l9.705 4.53.903-1.95-9.706-4.53-.902 1.936v.014zm2.715-4.785l8.217 6.855 1.359-1.62-8.216-6.853-1.35 1.617-.01.001zM15.751 0l-1.746 1.294 6.405 8.604 1.746-1.294L15.749 0h.002z"></path></svg></a><a href="https://www.youtube.com/channel/UCGN6L3tRhs92Uer3c6VxOSA" class="navbar-social-link" title="YouTube" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="YouTube channel of Vert.x"><title>YouTube</title><path d="M23.499 6.203a3.008 3.008 0 00-2.089-2.089c-1.87-.501-9.4-.501-9.4-.501s-7.509-.01-9.399.501a3.008 3.008 0 00-2.088 2.09A31.258 31.26 0 000 12.01a31.258 31.26 0 00.523 5.785 3.008 3.008 0 002.088 2.089c1.869.502 9.4.502 9.4.502s7.508 0 9.399-.502a3.008 3.008 0 002.089-2.09 31.258 31.26 0 00.5-5.784 31.258 31.26 0 00-.5-5.808zm-13.891 9.4V8.407l6.266 3.604z"></path></svg></a><a href="https://discord.gg/KzEMwP2" class="navbar-social-link" title="Discord" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="Eclipse Vert.x channel on Discord"><title>Discord</title><path d="M20.222 0c1.406 0 2.54 1.137 2.607 2.475V24l-2.677-2.273-1.47-1.338-1.604-1.398.67 2.205H3.71c-1.402 0-2.54-1.065-2.54-2.476V2.48C1.17 1.142 2.31.003 3.715.003h16.5L20.222 0zm-6.118 5.683h-.03l-.202.2c2.073.6 3.076 1.537 3.076 1.537-1.336-.668-2.54-1.002-3.744-1.137-.87-.135-1.74-.064-2.475 0h-.2c-.47 0-1.47.2-2.81.735-.467.203-.735.336-.735.336s1.002-1.002 3.21-1.537l-.135-.135s-1.672-.064-3.477 1.27c0 0-1.805 3.144-1.805 7.02 0 0 1 1.74 3.743 1.806 0 0 .4-.533.805-1.002-1.54-.468-2.14-1.404-2.14-1.404s.134.066.335.2h.06c.03 0 .044.015.06.03v.006c.016.016.03.03.06.03.33.136.66.27.93.4.466.202 1.065.403 1.8.536.93.135 1.996.2 3.21 0 .6-.135 1.2-.267 1.8-.535.39-.2.87-.4 1.397-.737 0 0-.6.936-2.205 1.404.33.466.795 1 .795 1 2.744-.06 3.81-1.8 3.87-1.726 0-3.87-1.815-7.02-1.815-7.02-1.635-1.214-3.165-1.26-3.435-1.26l.056-.02zm.168 4.413c.703 0 1.27.6 1.27 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334.002-.74.573-1.338 1.27-1.338zm-4.543 0c.7 0 1.266.6 1.266 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334 0-.74.57-1.338 1.27-1.338z"></path></svg></a><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx" class="navbar-social-link" title="Vert.x User Group" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="A Google group for Vert.x users"><title>Vert.x User Group</title><path d="M.92 3.332c-.776 0-1.216.67-.692 1.383l2.537 4.403v7.86c0 2.013 1.467 3.69 3.459 3.69H20.31a3.75 3.75 0 003.69-3.69V7.043a3.723 3.723 0 00-3.668-3.71zm5.786 3.71H20.1c.587 0 1.153.357 1.153.923 0 .566-.566.922-1.153.922H6.706c-.587 0-1.153-.356-1.153-.922 0-.566.566-.923 1.153-.923zm0 3.69H20.1c.587 0 1.153.356 1.153.922 0 .566-.566.922-1.153.922H6.706c-.587 0-1.153-.356-1.153-.922 0-.566.566-.922 1.153-.922zm-.021 3.71h9.705c.587 0 1.153.356 1.153.922 0 .566-.566.923-1.153.923H6.685c-.587 0-1.153-.357-1.153-.923 0-.566.566-.922 1.153-.922Z"></path></svg></a><a href="https://shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad" class="navbar-social-link" title="Vert.x中国用户组QQ群" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="Vert.x中国用户组QQ群"><title>Vert.x中国用户组QQ群</title><path d="M21.395 15.035a39.548 39.548 0 0 0-.803-2.264l-1.079-2.695c.001-.032.014-.562.014-.836C19.526 4.632 17.351 0 12 0S4.474 4.632 4.474 9.241c0 .274.013.804.014.836l-1.08 2.695a38.97 38.97 0 0 0-.802 2.264c-1.021 3.283-.69 4.643-.438 4.673.54.065 2.103-2.472 2.103-2.472 0 1.469.756 3.387 2.394 4.771-.612.188-1.363.479-1.845.835-.434.32-.379.646-.301.778.343.578 5.883.369 7.482.189 1.6.18 7.14.389 7.483-.189.078-.132.132-.458-.301-.778-.483-.356-1.233-.646-1.846-.836 1.637-1.384 2.393-3.302 2.393-4.771 0 0 1.563 2.537 2.103 2.472.251-.03.581-1.39-.438-4.673zM12.662 4.846c.039-1.052.659-1.878 1.385-1.846s1.281.912 1.242 1.964c-.039 1.051-.659 1.878-1.385 1.846s-1.282-.912-1.242-1.964zM9.954 3c.725-.033 1.345.794 1.384 1.846.04 1.052-.517 1.931-1.242 1.963-.726.033-1.346-.794-1.385-1.845C8.672 3.912 9.228 3.033 9.954 3zM7.421 8.294c.194-.43 2.147-.908 4.566-.908h.026c2.418 0 4.372.479 4.566.908a.14.14 0 0 1 .014.061c0 .031-.01.059-.026.083-.163.238-2.333 1.416-4.553 1.416h-.026c-2.221 0-4.39-1.178-4.553-1.416a.136.136 0 0 1-.014-.144zm10.422 8.622c-.22 3.676-2.403 5.987-5.774 6.021h-.137c-3.37-.033-5.554-2.345-5.773-6.021-.081-1.35.001-2.496.147-3.43.318.063.638.122.958.176v3.506s1.658.334 3.318.103v-3.225c.488.027.96.04 1.406.034h.025c1.678.021 3.714-.204 5.683-.594.146.934.227 2.08.147 3.43zM10.48 5.804c.313-.041.542-.409.508-.825-.033-.415-.314-.72-.629-.679-.313.04-.541.409-.508.824.034.417.315.72.629.68zM14.479 5.156c.078.037.221.042.289-.146.035-.095.025-.165-.009-.214-.023-.033-.133-.118-.371-.176-.904-.22-1.341.384-1.405.499-.04.072-.012.176.056.227.067.051.139.037.179-.006.58-.628 1.21-.208 1.261-.184z"></path></svg></a></div></div></div></div></header><div class="page-content docs-content"><div class="container"><div class="docs-content-wrapper"><aside class=""><div class="docs-content-wrapper-sidebar"><div class="search-panel"><div class="search"><input type="text" placeholder="Search..." value=""/><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="search-icon-delete"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></div><ul class="search-results"></ul><div class="search-results-none">No results.</div></div><div class="docs-content-toc"><div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_introduction">Introduction</a></li>
<li><a href="#_running_a_coroutine_from_a_vert_x_context">Running a coroutine from a Vert.x context</a></li>
<li><a href="#_extending_coroutineverticle">Extending CoroutineVerticle</a></li>
<li><a href="#_getting_one_shot_asynchronous_results">Getting one-shot asynchronous results</a></li>
<li><a href="#_getting_one_shot_events">Getting one-shot events</a></li>
<li><a href="#_getting_one_shot_worker_results">Getting one-shot worker results</a></li>
<li><a href="#_streams_of_events">Streams of events</a></li>
<li><a href="#_awaiting_the_completion_of_vert_x_asynchronous_results">Awaiting the completion of Vert.x asynchronous results</a></li>
<li><a href="#_suspending_extension_methods">Suspending extension methods</a></li>
<li><a href="#_channels">Channels</a>
<ul class="sectlevel2">
<li><a href="#_receiving_data">Receiving data</a></li>
<li><a href="#_sending_data">Sending data</a></li>
</ul>
</li>
<li><a href="#_delay_cancellation_and_timeouts">Delay, cancellation and timeouts</a></li>
<li><a href="#_coroutine_builders">Coroutine builders</a></li>
<li><a href="#_coroutine_interoperability">Coroutine interoperability</a></li>
<li><a href="#_rxjava_interoperability">RxJava interoperability</a></li>
</ul>
</div></div></div></aside><div class="docs-content-sidebar-toggle"><div style="position:relative"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-list"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div></div><div class="docs-content-inner"><div class="docs-content-metadata"><div class="docs-content-metadata-left"><div class="docs-content-metadata-repo"><div class="github-stars"><a href="https://github.com/vert-x3/vertx-lang-kotlin"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>null stars</a></div></div><div><a href="https://vertx.io/docs/apidocs"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg> API</a></div><div class="docs-content-metadata-examples"><a href="https://github.com/vert-x3/vertx-examples/tree/4.x/kotlin-examples/coroutines"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg> Examples</a></div><div class="docs-content-metadata-edit"><a href="https://github.com/vertx-china/vertx-web-site/edit/master/docs/translation/vertx-lang-kotlin-coroutines/kotlin/index.adoc"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg> 改进翻译</a></div><span class="docs-content-metadata-version"><div class="dropdown"><a class="dropdown-title">v4.0.3<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></a><ul class="dropdown-menu align-right"><a href="/docs/vertx-lang-kotlin-coroutines/kotlin/"><li class="dropdown-item active has-active-siblings"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dropdown-check-icon"><polyline points="20 6 9 17 4 12"></polyline></svg>Latest (v<!-- -->4.0.3<!-- -->)</li></a><a href="/docs/3.9.6/vertx-lang-kotlin-coroutines/kotlin/"><li class="dropdown-item has-active-siblings">v<!-- -->3.9.6</li></a></ul></div></span></div></div><div><h1>vertx-lang-kotlin-coroutines</h1>

<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The <code>vertx-lang-kotlin-coroutines</code> integrates Kotlin <em>coroutines</em> for performing asynchronous operations and processing events.
This results in using a programming model that looks like sequential code, yet it does not block kernel threads.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>One of the key advantages of Vert.x over many legacy application platforms is that it is almost entirely non-blocking
(of kernel threads).
This allows Vert.x-based applications to handle a lot of concurrency (e.g., many connections and messages) using a very
small number of kernel threads, which in turns unlocks great scalability.</p>
</div>
<div class="paragraph">
<p>The non-blocking nature of Vert.x leads to asynchronous APIs. Asynchronous APIs can take various forms including
callbacks, promises, fibers or reactive extensions. Vert.x uses the callback style for the core APIs but it
also supports other models like RxJava 1 and 2.</p>
</div>
<div class="paragraph">
<p>In some cases, programming using asynchronous APIs can be more challenging than using a classic / sequential style
of code, in particular with several operations need to be done in sequence. Also, error propagation is often more
complex when using asynchronous APIs.</p>
</div>
<div class="paragraph">
<p><code>vertx-lang-kotlin-coroutines</code> uses <em>coroutines</em>. Coroutines are very lightweight threads that do not correspond
to underlying kernel threads, so that when a <em>coroutine</em> needs to <em>"block</em>" it gets <em>suspended</em> and frees
its current kernel thread so that another coroutine can process events.</p>
</div>
<div class="paragraph">
<p><code>vertx-lang-kotlin-coroutines</code> uses <a href="https://github.com/Kotlin/kotlinx.coroutines">kotlinx.coroutines</a> to implement the Coroutines.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">注意</div>
</td>
<td class="content">
<code>vertx-lang-kotlin-coroutines</code> currently only works with Kotlin and will be out of the <a href="https://kotlinlang.org/docs/reference/coroutines.html#experimental-status-of-coroutines">experimental</a> status
in Kotlin 1.3
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_running_a_coroutine_from_a_vert_x_context"><a class="anchor" href="#_running_a_coroutine_from_a_vert_x_context"></a>Running a coroutine from a Vert.x context</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Having imported <code>io.vertx.kotlin.coroutines.VertxCoroutine</code>, the <code>GlobalScope.launch</code> method allows to run a block of code as a
coroutine in the "Global" application scope (bounded on the lifetime of the application):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">val</span> vertx = Vertx.vertx()

GlobalScope.launch(vertx.dispatcher()) {
  <span class="hljs-keyword">val</span> timerId = awaitEvent&lt;<span class="hljs-built_in">Long</span>&gt; { handler -&gt;
    vertx.setTimer(<span class="hljs-number">1000</span>, handler)
  }
  println(<span class="hljs-string">"Event fired from timer with id <span class="hljs-variable">$timerId</span>"</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>vertx.dispatcher()</code> returns a coroutine dispatcher that execute coroutines using the Vert.x event loop.</p>
</div>
<div class="paragraph">
<p>The <code>awaitEvent</code> function suspends the execution of the coroutine until the timer fires and resumes the coroutines
 with the value that was given to the handler.</p>
</div>
<div class="paragraph">
<p>More details are given in the next sections on handlers, events and stream of events.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_extending_coroutineverticle"><a class="anchor" href="#_extending_coroutineverticle"></a>Extending CoroutineVerticle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You can deploy your code as instances of <code>io.vertx.kotlin.coroutines.CoroutineVerticle</code>, a specialized type of verticle
for Kotlin coroutines. The <code>CoroutineVerticle</code> class implements the <code>kotlinx.coroutines.experimental.CoroutineScope</code> interface,
making all coroutines builder methods bounded by default to the verticle context. You should override the suspending <code>start()</code>
and (optionally) the suspending <code>stop()</code> methods of the verticle:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyVerticle</span> : <span class="hljs-type">CoroutineVerticle</span></span>() {
  <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">start</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// ...</span>
  }

  <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">stop</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// ...</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>All code examples below assume to be run inside a <code>CoroutineVerticle</code> implementation, but you can replace all <code>&lt;builder&gt; { .. }</code>
calls with <code>GlobalScope.&lt;builder&gt; { .. }</code> to use the application scope instead.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_one_shot_asynchronous_results"><a class="anchor" href="#_getting_one_shot_asynchronous_results"></a>Getting one-shot asynchronous results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Many asynchronous operations in Vert.x take a <code>Handler&lt;AsyncResult&lt;T&gt;&gt;</code> as the last argument.
An example would be executing an object retrieval using the Vert.x Mongo client, or sending an event bus message then
awaiting for a reply.</p>
</div>
<div class="paragraph">
<p>This is achieved by using the <code>awaitResult</code> method which returns the value or throws an exception.</p>
</div>
<div class="paragraph">
<p>The coroutine is being suspended until the event is being processed, and no kernel thread is being blocked.</p>
</div>
<div class="paragraph">
<p>The method is executed by specifying the asynchronous operation that needs to be executed in the form of a block that
is passed to the handler at run-time.</p>
</div>
<div class="paragraph">
<p>Here is an example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">awaitResultExample</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">val</span> consumer = vertx.eventBus().localConsumer&lt;String&gt;(<span class="hljs-string">"a.b.c"</span>)
  consumer.handler { message -&gt;
    println(<span class="hljs-string">"Consumer received: <span class="hljs-subst">${message.body()}</span>"</span>)
    message.reply(<span class="hljs-string">"pong"</span>)
  }

  <span class="hljs-comment">// Send a message and wait for a reply</span>
  <span class="hljs-keyword">val</span> reply = awaitResult&lt;Message&lt;String&gt;&gt; { h -&gt;
    vertx.eventBus().send(<span class="hljs-string">"a.b.c"</span>, <span class="hljs-string">"ping"</span>, h)
  }
  println(<span class="hljs-string">"Reply received: <span class="hljs-subst">${reply.body()}</span>"</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the block produces a failure, the caller can handle it as an exception using the usual exception
<code>try</code>/<code>catch</code> constructs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">awaitResultFailureExample</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">val</span> consumer = vertx.eventBus().localConsumer&lt;String&gt;(<span class="hljs-string">"a.b.c"</span>)
  consumer.handler { message -&gt;
    <span class="hljs-comment">// The consumer will get a failure</span>
    message.fail(<span class="hljs-number">0</span>, <span class="hljs-string">"it failed!!!"</span>)
  }

  <span class="hljs-comment">// Send a message and wait for a reply</span>
  <span class="hljs-keyword">try</span> {
    awaitResult&lt;Message&lt;String&gt;&gt; { h -&gt;
      vertx.eventBus().send(<span class="hljs-string">"a.b.c"</span>, <span class="hljs-string">"ping"</span>, h)
    }
  } <span class="hljs-keyword">catch</span> (e: ReplyException) {
    <span class="hljs-comment">// Handle specific reply exception here</span>
    println(<span class="hljs-string">"Reply failure: <span class="hljs-subst">${e.message}</span>"</span>)
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_one_shot_events"><a class="anchor" href="#_getting_one_shot_events"></a>Getting one-shot events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Processing a one-shot event (and not the next occurrences, if any) is achieved using the <code>awaitEvent</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">awaitEventExample</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">val</span> id = awaitEvent&lt;<span class="hljs-built_in">Long</span>&gt; { h -&gt; vertx.setTimer(<span class="hljs-number">2000L</span>, h) }
  println(<span class="hljs-string">"This should be fired in 2s by some time with id=<span class="hljs-variable">$id</span>"</span>)
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_getting_one_shot_worker_results"><a class="anchor" href="#_getting_one_shot_worker_results"></a>Getting one-shot worker results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Processing a blocking computation is achieved using the <code>awaitBlocking</code> function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">awaitBlockingExample</span><span class="hljs-params">()</span></span> {
  awaitBlocking {
    Thread.sleep(<span class="hljs-number">1000</span>)
    <span class="hljs-string">"some-string"</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_streams_of_events"><a class="anchor" href="#_streams_of_events"></a>Streams of events</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In many places in Vert.x APIs, streams of events are processed through handlers.
Examples include event bus message consumers and HTTP server requests.</p>
</div>
<div class="paragraph">
<p>The <code>ReceiveChannelHandler</code> class allows receiving events through the (suspendable) <code>receive</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">streamExample</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">val</span> adapter = vertx.receiveChannelHandler&lt;Message&lt;<span class="hljs-built_in">Int</span>&gt;&gt;()
  vertx.eventBus().localConsumer&lt;<span class="hljs-built_in">Int</span>&gt;(<span class="hljs-string">"a.b.c"</span>).handler(adapter)

  <span class="hljs-comment">// Send 15 messages</span>
  <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">15</span>) vertx.eventBus().send(<span class="hljs-string">"a.b.c"</span>, i)

  <span class="hljs-comment">// Receive the first 10 messages</span>
  <span class="hljs-keyword">for</span> (i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..<span class="hljs-number">10</span>) {
    <span class="hljs-keyword">val</span> message = adapter.receive()
    println(<span class="hljs-string">"Received: <span class="hljs-subst">${message.body()}</span>"</span>)
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_awaiting_the_completion_of_vert_x_asynchronous_results"><a class="anchor" href="#_awaiting_the_completion_of_vert_x_asynchronous_results"></a>Awaiting the completion of Vert.x asynchronous results</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The <code>await</code> extension method on instances of Vert.x asynchronous results suspend coroutines until they have completed, in
which case the method returns the corresponding <code>AsyncResult&lt;T&gt;</code> object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">awaitingFuture</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">val</span> httpServerFuture = Future.future&lt;HttpServer&gt;()
  vertx.createHttpServer()
    .requestHandler { req -&gt; req.response().end(<span class="hljs-string">"Hello!"</span>) }
    .listen(<span class="hljs-number">8000</span>, httpServerFuture)

  <span class="hljs-keyword">val</span> httpServer = httpServerFuture.await()
  println(<span class="hljs-string">"HTTP server port: <span class="hljs-subst">${httpServer.actualPort()}</span>"</span>)

  <span class="hljs-keyword">val</span> result = CompositeFuture.all(httpServerFuture, httpServerFuture).await()
  <span class="hljs-keyword">if</span> (result.succeeded()) {
    println(<span class="hljs-string">"The server is now running!"</span>)
  } <span class="hljs-keyword">else</span> {
    result.cause().printStackTrace()
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_suspending_extension_methods"><a class="anchor" href="#_suspending_extension_methods"></a>Suspending extension methods</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since <code>3.6.0</code>, Vert.x generates suspending extension methods for all its asynchronous methods.</p>
</div>
<div class="paragraph">
<p>It relieves the user from using the idiomatic <code>awaitResult</code> and makes the code more natural and readable.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">generatedSuspendingExtensionMethod</span><span class="hljs-params">()</span></span> {
  <span class="hljs-comment">// Suspending extension method</span>
  <span class="hljs-comment">// This function has been automatically generated from the [io.vertx.core.net.NetClient original] using Vert.x codegen.</span>
  <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> NetClient.<span class="hljs-title">connectAwait</span><span class="hljs-params">(port : <span class="hljs-type">Int</span>, host : <span class="hljs-type">String</span>)</span></span> : NetSocket {
    <span class="hljs-keyword">return</span> awaitResult{
      <span class="hljs-keyword">this</span>.connect(port, host, it)
    }
  }

  <span class="hljs-comment">// Use the extension instead of wrapping with awaitResult</span>
  <span class="hljs-keyword">val</span> client = vertx.createNetClient();
  <span class="hljs-keyword">val</span> socket = client.connectAwait(<span class="hljs-number">1234</span>, <span class="hljs-string">"localhost"</span>);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each asynchronous method has a suspending counterpart, e.g <code>xyz(1, 2, handler)</code> &#8658; <code>xyzAwait(1, 2)</code>.</p>
</div>
<div class="paragraph">
<p>Such extensions are provided by the <code>io.vertx:vertx-lang-kotlin</code> dependency and covers the Vert.x stack:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>vertx-web</p>
</li>
<li>
<p>vertx-jdbc-client</p>
</li>
<li>
<p>vertx-cassandra-client</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_channels"><a class="anchor" href="#_channels"></a>Channels</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Channels are similar to Java <code>BlockingQueue</code> except that they do not block and instead suspend the coroutine
instead of blocking:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>sending a value to full channel suspends the coroutine</p>
</li>
<li>
<p>receving a value from an empty channels also suspends the coroutine</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vert.x <code>ReadStream</code> and <code>WriteStream</code> can be adapted to channels with the <code>toChannel</code> extension method.</p>
</div>
<div class="paragraph">
<p>These adapters take care of managing the back-pressure and the stream termination</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>ReadStream&lt;T&gt;</code> is adapted to a <code>ReceiveChannel&lt;T&gt;</code></p>
</li>
<li>
<p><code>WriteStream&lt;T&gt;</code> is adapted to a <code>SendChannel&lt;T&gt;</code></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_receiving_data"><a class="anchor" href="#_receiving_data"></a>Receiving data</h3>
<div class="paragraph">
<p>Channel can be really useful when you need to handle a stream of correlated values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handleTemperatureStream</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">val</span> stream = vertx.eventBus().consumer&lt;<span class="hljs-built_in">Double</span>&gt;(<span class="hljs-string">"temperature"</span>)
  <span class="hljs-keyword">val</span> channel = stream.toChannel(vertx)

  <span class="hljs-keyword">var</span> min = <span class="hljs-built_in">Double</span>.MAX_VALUE
  <span class="hljs-keyword">var</span> max = <span class="hljs-built_in">Double</span>.MIN_VALUE

  <span class="hljs-comment">// Iterate until the stream is closed</span>
  <span class="hljs-comment">// Non-blocking</span>
  <span class="hljs-keyword">for</span> (msg <span class="hljs-keyword">in</span> channel) {
    <span class="hljs-keyword">val</span> temperature = msg.body()
    min = Math.min(min, temperature)
    max = Math.max(max, temperature)
  }

  <span class="hljs-comment">// The stream is now closed</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can also be useful for parsing protocols. We will build a non blocking HTTP request parser to show
the power of channels.</p>
</div>
<div class="paragraph">
<p>We will rely on the <a href="http://vertx.io/docs/apidocs/io/vertx/core/parsetools/RecordParser.html"><code>RecordParser</code></a>
to slice the stream of buffer to a stream of buffer delimited by <code>\r\n</code>.</p>
</div>
<div class="paragraph">
<p>Here is the initial version of the parser, that handles only the HTTP request-line</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">vertx.createNetServer().connectHandler { socket -&gt;

  <span class="hljs-comment">// The record parser provides a stream of buffers delimited by \r\n</span>
  <span class="hljs-keyword">val</span> stream = RecordParser.newDelimited(<span class="hljs-string">"\r\n"</span>, socket)

  <span class="hljs-comment">// Convert the stream to a Kotlin channel</span>
  <span class="hljs-keyword">val</span> channel = stream.toChannel(vertx)

  <span class="hljs-comment">// Run the coroutine</span>
  launch {

    <span class="hljs-comment">// Receive the request-line</span>
    <span class="hljs-comment">// Non-blocking</span>
    <span class="hljs-keyword">val</span> line = channel.receive().toString().split(<span class="hljs-string">" "</span>)
    <span class="hljs-keyword">val</span> method = line[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">val</span> uri = line[<span class="hljs-number">1</span>]

    println(<span class="hljs-string">"Received HTTP request (<span class="hljs-variable">$method</span>, <span class="hljs-variable">$uri</span>)"</span>)

    <span class="hljs-comment">// Still need to parse headers and body...</span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Parsing the request-line is as simple as calling <code>receive</code> on the channel.</p>
</div>
<div class="paragraph">
<p>The next step parses HTTP headers by receiving chunks until we get an empty one</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-comment">// Receive HTTP headers</span>
<span class="hljs-keyword">val</span> headers = HashMap&lt;String, String&gt;()
<span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {

  <span class="hljs-comment">// Non-blocking</span>
  <span class="hljs-keyword">val</span> header = channel.receive().toString()

  <span class="hljs-comment">// Done with parsing headers</span>
  <span class="hljs-keyword">if</span> (header.isEmpty()) {
    <span class="hljs-keyword">break</span>
  }

  <span class="hljs-keyword">val</span> pos = header.indexOf(<span class="hljs-string">':'</span>)
  headers[header.substring(<span class="hljs-number">0</span>, pos).toLowerCase()] = header.substring(pos + <span class="hljs-number">1</span>).trim()
}

println(<span class="hljs-string">"Received HTTP request (<span class="hljs-variable">$method</span>, <span class="hljs-variable">$uri</span>) with headers <span class="hljs-subst">${headers.keys}</span>"</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally we terminate the parser by handling optional request bodies</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-comment">// Receive the request body</span>
<span class="hljs-keyword">val</span> transferEncoding = headers[<span class="hljs-string">"transfer-encoding"</span>]
<span class="hljs-keyword">val</span> contentLength = headers[<span class="hljs-string">"content-length"</span>]

<span class="hljs-keyword">val</span> body: Buffer?
<span class="hljs-keyword">if</span> (transferEncoding == <span class="hljs-string">"chunked"</span>) {

  <span class="hljs-comment">// Handle chunked encoding, e.g</span>
  <span class="hljs-comment">// 5\r\n</span>
  <span class="hljs-comment">// HELLO\r\n</span>
  <span class="hljs-comment">// 0\r\n</span>
  <span class="hljs-comment">// \r\n</span>

  body = Buffer.buffer()
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {

    <span class="hljs-comment">// Parse length chunk</span>
    <span class="hljs-comment">// Non-blocking</span>
    <span class="hljs-keyword">val</span> len = channel.receive().toString().toInt(<span class="hljs-number">16</span>)
    <span class="hljs-keyword">if</span> (len == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">break</span>
    }

    <span class="hljs-comment">// The stream is flipped to parse a chunk of the exact size</span>
    stream.fixedSizeMode(len + <span class="hljs-number">2</span>)

    <span class="hljs-comment">// Receive the chunk and append it</span>
    <span class="hljs-comment">// Non-blocking</span>
    <span class="hljs-keyword">val</span> chunk = channel.receive()
    body.appendBuffer(chunk, <span class="hljs-number">0</span>, chunk.length() - <span class="hljs-number">2</span>)

    <span class="hljs-comment">// The stream is flipped back to the \r\n delimiter to parse the next chunk</span>
    stream.delimitedMode(<span class="hljs-string">"\r\n"</span>)
  }
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contentLength != <span class="hljs-literal">null</span>) {

  <span class="hljs-comment">// The stream is flipped to parse a body of the exact size</span>
  stream.fixedSizeMode(contentLength.toInt())

  <span class="hljs-comment">// Non-blocking</span>
  body = channel.receive()
} <span class="hljs-keyword">else</span> {
  body = <span class="hljs-literal">null</span>
}

<span class="hljs-keyword">val</span> bodySize = body?.length() ?: <span class="hljs-number">0</span>
println(<span class="hljs-string">"Received HTTP request (<span class="hljs-variable">$method</span>, <span class="hljs-variable">$uri</span>) with headers <span class="hljs-subst">${headers.keys}</span> and body with size <span class="hljs-variable">$bodySize</span>"</span>)</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_data"><a class="anchor" href="#_sending_data"></a>Sending data</h3>
<div class="paragraph">
<p>Using a channel to send data is quite straightforward:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sendChannel</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">val</span> stream = vertx.eventBus().publisher&lt;<span class="hljs-built_in">Double</span>&gt;(<span class="hljs-string">"temperature"</span>)
  <span class="hljs-keyword">val</span> channel = stream.toChannel(vertx)

  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">val</span> temperature = readTemperatureSensor()

    <span class="hljs-comment">// Broadcast the temperature</span>
    <span class="hljs-comment">// Non-blocking but could be suspended</span>
    channel.send(temperature)

    <span class="hljs-comment">// Wait for one second</span>
    awaitEvent&lt;<span class="hljs-built_in">Long</span>&gt; { vertx.setTimer(<span class="hljs-number">1000</span>, it) }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both <code>SendChannel#send</code> and <code>WriteStream#write</code> are non blocking operations, however unlike <code>SendChannel#send</code>
can suspend the execution when the channel is full, the equivalent without a channel would look like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">sendChannel</span><span class="hljs-params">()</span></span> {
  <span class="hljs-keyword">val</span> stream = vertx.eventBus().publisher&lt;<span class="hljs-built_in">Double</span>&gt;(<span class="hljs-string">"temperature"</span>)
  <span class="hljs-keyword">val</span> channel = stream.toChannel(vertx)

  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    <span class="hljs-keyword">val</span> temperature = readTemperatureSensor()

    <span class="hljs-comment">// Broadcast the temperature</span>
    <span class="hljs-comment">// Non-blocking but could be suspended</span>
    channel.send(temperature)

    <span class="hljs-comment">// Wait for one second</span>
    awaitEvent&lt;<span class="hljs-built_in">Long</span>&gt; { vertx.setTimer(<span class="hljs-number">1000</span>, it) }
  }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_delay_cancellation_and_timeouts"><a class="anchor" href="#_delay_cancellation_and_timeouts"></a>Delay, cancellation and timeouts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vertx dispatcher fully supports coroutine <code>delay</code> function via Vert.x timers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">launch {
  <span class="hljs-comment">// Set a one second Vertx timer</span>
  delay(<span class="hljs-number">1000</span>)
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Timers support cancellation</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
  <span class="hljs-comment">// Set a one second Vertx timer</span>
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
    delay(<span class="hljs-number">1000</span>)
    <span class="hljs-comment">// Do something periodically</span>
  }
}

<span class="hljs-comment">// Sometimes later</span>
job.cancel()</code></pre>
</div>
</div>
<div class="paragraph">
<p>cancellation is <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/coroutines-guide.md#cancellation-is-cooperative">cooperative</a></p>
</div>
<div class="paragraph">
<p>You can also schedule timeout with the <code>withTimeout</code> function</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-kotlin" data-lang="kotlin">launch {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">val</span> id = withTimeout&lt;String&gt;(<span class="hljs-number">1000</span>) {
      awaitEvent { anAsyncMethod(it) }
    }
  } <span class="hljs-keyword">catch</span> (e: TimeoutCancellationException) {
    <span class="hljs-comment">// Cancelled</span>
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coroutine_builders"><a class="anchor" href="#_coroutine_builders"></a>Coroutine builders</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vert.x works will all coroutine builders, as long as an instance of <code>CoroutineScope</code> is available: <code>launch</code>, <code>async</code>,
`produce', &#8230;&#8203; . A couple of important things to remember:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>runBlocking</code> doesn&#8217;t need a <code>CoroutineScope</code> and must not be used from a Vert.x event loop thread.</p>
</li>
<li>
<p>To avoid memory leaks, always use <code>coroutineScope {..}</code> to define a child scope. In this way, if a coroutine fails
inside the scope, all the others, defined inside that scope, will be cancelled too.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_coroutine_interoperability"><a class="anchor" href="#_coroutine_interoperability"></a>Coroutine interoperability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vert.x integration has been designed to be fully interoperable with Kotlin coroutines</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>kotlinx.coroutines.experimental.sync.Mutex</code> are executed on the event loop thread when using the vertx dispatcher</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rxjava_interoperability"><a class="anchor" href="#_rxjava_interoperability"></a>RxJava interoperability</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The module <code>vertx-lang-kotlin-coroutines</code> does not have specific integration with RxJava however Kotlin coroutines
provide integration with RxJava, which works out nicely with <code>vertx-lang-kotlin-coroutines</code>.</p>
</div>
<div class="paragraph">
<p>You can read about it in the <a href="https://github.com/Kotlin/kotlinx.coroutines/blob/master/reactive/coroutines-guide-reactive.md">Guide to reactive streams with coroutines</a></p>
</div>
</div>
</div></div></div></div></div></div><footer><div class="container"><div class="footer-nav-section"><div class="footer-nav-list footer-logo"><a href="/"><img src="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjAiIHk9IjAiIHZpZXdCb3g9IjAgMCAxMTI1LjYgMzE1LjIiIHhtbDpzcGFjZT0icHJlc2VydmUiPjxzdHlsZT4uc3Qwe2ZpbGw6Izc4MmE5MX08L3N0eWxlPjxwYXRoIGQ9Ik0xMjAuOSAyMTQuMkwxOTAuNSAwaDUyLjNsLTk4LjUgMjczLjhIOTguMkwwIDBoNTIuMWw2OC44IDIxNC4yem0yOTEuMi02Mi42SDI5OS42djg0LjJINDMxdjM4SDI1MlYwaDE3Ny43djM4LjRIMjk5LjZWMTE0aDExMi41djM3LjZ6bTgzLjctMTEzLjJINTQ2YzE2LjUuMyAyOSA0LjQgMzcuMyAxMi40IDguMyA4IDEyLjUgMTkuNCAxMi41IDM0IDAgMTQtNC41IDI1LjEtMTMuNSAzMy4yLTkgOC4xLTIxLjYgMTIuMS0zNy42IDEyLjFoLTI3LjF2MjQuMmw4Ni4xIDExOS41aDUxdi0yLjRsLTc3LjItMTA2LjdjMjQuOS01LjUgNDMuMy0yMS43IDUyLjYtMzUuOSA4LjItMTIuNiAxMy4zLTI3LjcgMTMuMy00NiAwLTI2LjgtOC42LTQ3LjQtMjUuOC02MS41QzYwMC41IDcuMSA1NzYuMSAwIDU0NC41IDBoLTk2LjN2MjczLjhoNDcuNiIvPjxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0xMDUyLjMgMTU3LjdsLTQxLjUgNjIuNyAyOS43IDUzLjRoODUuMXoiLz48Y2lyY2xlIGNsYXNzPSJzdDAiIGN4PSI4MjcuOSIgY3k9IjI3NC43IiByPSI0MC41Ii8+PHBhdGggY2xhc3M9InN0MCIgZD0iTTEwMzcgMGwtNDcuNiA3NC4yTDk0OSAwaC04NGw4NS4zIDEzNS44LTY3LjEgMTA1LjdjNS43IDkuNSA5LjEgMjAuNSA5LjIgMzIuNGg1MC4xTDExMjEuMyAwSDEwMzd6Ii8+PHBhdGggZD0iTTc2My41IDI3My44Yy4xLTkuOSAyLjUtMTkuMiA2LjYtMjcuNVYzOC40aDg1LjRWMEg2MzguMnYzOC40aDg0LjZ2MjM1LjRoNDAuN3oiLz48L3N2Zz4=" alt="Vert.x Logo"/></a></div><div class="footer-nav-list"><h5>Eclipse Vert.x</h5><ul class=""><li><a class="navbar-menu-item" href="/docs/">文档</a></li><li><a href="/download/">下载</a></li><li><a href="/blog/">博客</a></li><li><a href="/community/">社区</a></li><li><a href="/translation/">翻译团队</a></li><li><a href="https://github.com/eclipse-vertx/vert.x">GitHub</a></li><li><a href="https://github.com/vertx-china/vertx-web-site">翻译GitHub</a></li></ul></div><div class="footer-nav-list"><h5>资源</h5><ul class=""><li><a href="/faq/">答疑</a></li><li><a href="/channels/">Channels</a></li><li><a href="https://how-to.vertx.io/">How-To’s</a></li><li><a href="https://start.vertx.io/">App Generator</a></li></ul></div><div class="footer-nav-list"><h5>Eclipse</h5><ul class=""><li><a href="https://www.eclipse.org/">Eclipse Foundation</a></li><li><a href="https://www.eclipse.org/legal/privacy.php">Privacy Policy</a></li><li><a href="https://www.eclipse.org/legal/termsofuse.php">Terms of Use</a></li><li><a href="https://www.eclipse.org/legal/copyright.php">Copyright Agent</a></li><li><a href="https://www.eclipse.org/legal/">Legal Resources</a></li></ul></div></div><div class="footer-copyright"><div class="footer-copyright-remarks">© <!-- -->2021<!-- --> Eclipse Vert.x<br/>Eclipse Vert.x is open source and dual-licensed under the <a href="https://creativecommons.org/licenses/by-sa/3.0/" target="_blank" rel="noopener noreferrer">Eclipse Public License 2.0</a> and the <a href="https://www.apache.org/licenses/LICENSE-2.0.html" target="_blank" rel="noopener noreferrer">Apache License 2.0</a>. <br class="footer-copyright-break"/>Website design by <a href="https://michelkraemer.com" target="_blank" rel="noopener noreferrer">Michel Krämer</a>.</div><div class="footer-copyright-eclipse-logo"><a href="https://www.eclipse.org/" target="_blank" rel="noopener noreferrer"><img src="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjAiIHk9IjAiIHZpZXdCb3g9IjAgMCAyODEuMyA5MS4xIiB4bWw6c3BhY2U9InByZXNlcnZlIj48c3R5bGU+LnN0MHtmaWxsOiNmNzk0MjJ9LnN0MXtmaWxsOiMzZDNjM2J9PC9zdHlsZT48ZyBpZD0iTGF5ZXJfMV8xXyI+PHBhdGggY2xhc3M9InN0MCIgZD0iTTI2NS43IDg0TDI1NyA3M2gtMi43djE3LjdoMy4zdi0xMmw5LjMgMTJoMi4xVjczaC0zLjN2MTF6bS0zMi40LTguM2M0LjIgMCA1LjggMy4zIDUuOCA2LjNzLTEuNiA2LTUuOCA2LTUuNy0zLjEtNS44LTYgMS43LTYuMyA1LjgtNi4zem0wLTNjLTYuMSAwLTkuMSA0LjctOS4xIDkuMyAwIDQuNyAyLjkgOS4xIDkuMSA5LjFzOS00LjYgOS4xLTkuMi0zLTkuMi05LjEtOS4yem0tMjEuMiAxOFY3M2gtMy4zdjE3LjdoMy4zem0tMjMuNiAwaDMuM1Y3Nmg1LjZ2LTNoLTE0LjZ2M2g1LjZsLjEgMTQuN3ptLTE4LjktNi41SDE2M2wzLjMtNy42IDMuMyA3LjZ6bTIuOCA2LjVoMy42TDE2OC4yIDczaC0zLjZsLTggMTcuN2gzLjZsMS41LTMuM2g5LjNsMS40IDMuM3ptLTM4LTE0LjZoMy42YzMuOSAwIDUuNSAyLjggNS41IDUuNS4xIDIuOC0xLjUgNS44LTUuNSA1LjhoLTMuNlY3Ni4xem0zLjctMy4xaC02Ljl2MTcuN2g2LjljNi4yIDAgOC45LTQuNSA4LjktOXMtMi44LTguNy04LjktOC43em0tMjIuNCAxMUwxMDcgNzNoLTIuN3YxNy43aDMuM3YtMTJsOS4zIDEyaDIuMVY3M2gtMy4zdjExek04OC4yIDczdjEwLjJjMCAzLTEuNiA0LjktNC4zIDQuOXMtNC42LTEuNy00LjYtNC45VjczSDc2djEwLjFjMCA1LjMgMy42IDcuOSA3LjkgNy45IDQuNCAwIDcuNy0yLjcgNy43LTcuOVY3M2gtMy40em0tMzMgMi43YzQuMiAwIDUuOCAzLjMgNS44IDYuM3MtMS42IDYtNS44IDYtNS43LTMuMS01LjgtNiAxLjctNi4zIDUuOC02LjN6bTAtM2MtNi4xIDAtOS4xIDQuNy05LjEgOS4zczIuOSA5LjEgOS4xIDkuMSA5LTQuNiA5LjEtOS4yLTMtOS4yLTkuMS05LjJ6bS0yOS43IDE4di02LjVoOC45di0zLjFoLTguOXYtNC44aDkuNFY3M0gyMi4ydjE3LjZoMy4zeiIvPjxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0yNjkuNCA1NC40aC0yMi4ydi04LjloMjEuNHYtNi45aC0yMS40di05LjFoMjIuMnYtNy4yaC0yOS42djM5LjVoMjkuNnYtNy40em0tNDAtMjUuNmMtMy02LjEtOS40LTcuOC0xNS41LTcuOC03LjMgMC0xNS4zIDMuNC0xNS4zIDExLjUgMCA4LjkgNy40IDExIDE1LjUgMTIgNS4yLjYgOS4xIDIuMSA5LjEgNS44IDAgNC4zLTQuNCA1LjktOS4xIDUuOXMtOS40LTEuOS0xMS4xLTYuM2wtNi4yIDMuMmMyLjkgNy4yIDkuMSA5LjcgMTcuMiA5LjcgOC44IDAgMTYuNi0zLjggMTYuNi0xMi42IDAtOS40LTcuNy0xMS42LTE1LjktMTIuNi00LjctLjYtOC44LTEuNS04LjgtNSAwLTIuOSAyLjYtNS4yIDguMi01LjIgNC4zIDAgOCAyLjIgOS40IDQuNGw1LjktM3pNMTc2IDIyLjJjLTYuMi0uMS0xMi40IDAtMTguNiAwdjM5LjVoNy40VjUwLjFIMTc2YzE5LjQgMCAxOS40LTI3LjkgMC0yNy45em0tMTEuMSA3LjFIMTc2YzkuNSAwIDkuNSAxNCAwIDE0aC0xMS4ybC4xLTE0em0tMTggMzIuNVYyMi4yaC03LjR2MzkuNWw3LjQuMXptLTQ0LTM5LjZ2MzkuNWgyNy43di02LjloLTIwLjNWMjIuMmgtNy40ek05MC43IDUxLjdjLTIuNyAyLjUtNi4yIDQtOS45IDQtOS44IDAtMTMuNS02LjgtMTMuNi0xMy40czQuMS0xMy43IDEzLjYtMTMuN2MzLjUtLjEgNyAxLjMgOS41IDMuN2w1LTQuOGMtMy44LTMuOS05LjEtNi0xNC41LTYtMTQuMyAwLTIxIDEwLjUtMjAuOSAyMC44czYuMyAyMC4zIDIwLjkgMjAuM2M1LjYuMSAxMS0yIDE1LTUuOWwtNS4xLTV6bS0zOSAyLjdIMjkuNXYtOC45aDIxLjR2LTYuOUgyOS41di05LjFoMjIuMnYtNy4ySDIyLjJ2MzkuNWgyOS42bC0uMS03LjR6Ii8+PHBhdGggY2xhc3M9InN0MCIgZD0iTTkuOCAxOC4yQzE4LjggNC4xIDM2LjktLjggNTIuMSA2bC0xLS43QzM1LjctNC42IDE1LjItLjEgNS4zIDE1LjNzLTUuNCAzNS45IDEwIDQ1LjhsMS4xLjZDMy44IDUwLjguOCAzMi4zIDkuOCAxOC4yeiIvPjxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0yNzIuMiAyNi4xYzAtMi41IDIuMS00LjYgNC42LTQuNiAyLjUgMCA0LjYgMi4xIDQuNiA0LjYgMCAyLjUtMi4xIDQuNi00LjYgNC42LTIuNiAwLTQuNi0yLjEtNC42LTQuNnptOC42IDBjMC0yLjItMS44LTQuMS00LTQuMXMtNC4xIDEuOC00LjEgNC4xYzAgMi4yIDEuNyA0IDMuOSA0LjFoLjFjMi4zIDAgNC4xLTEuOCA0LjEtNC4xem0tNi0yLjVoMi4zYzEuMSAwIDEuOS41IDEuOSAxLjYgMCAuNy0uNCAxLjMtMS4xIDEuNWwxLjIgMS43aC0xLjRsLTEtMS41aC0uN3YxLjVoLTEuMWwtLjEtNC44em0yLjIgMi4zYy41IDAgLjgtLjMuOC0uN3MtLjMtLjctLjgtLjdoLTF2MS4zbDEgLjF6Ii8+PC9nPjwvc3ZnPg==" alt="Eclipse foundation Logo"/></a></div></div></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"3.8.4/vertx-lang-kotlin-coroutines/kotlin","title":"vertx-lang-kotlin-coroutines","fallbackGitHubStars":null,"toc":"\u003cdiv id=\"toc\" class=\"toc\"\u003e\n\u003cdiv id=\"toctitle\"\u003eTable of Contents\u003c/div\u003e\n\u003cul class=\"sectlevel1\"\u003e\n\u003cli\u003e\u003ca href=\"#_introduction\"\u003eIntroduction\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_running_a_coroutine_from_a_vert_x_context\"\u003eRunning a coroutine from a Vert.x context\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_extending_coroutineverticle\"\u003eExtending CoroutineVerticle\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_getting_one_shot_asynchronous_results\"\u003eGetting one-shot asynchronous results\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_getting_one_shot_events\"\u003eGetting one-shot events\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_getting_one_shot_worker_results\"\u003eGetting one-shot worker results\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_streams_of_events\"\u003eStreams of events\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_awaiting_the_completion_of_vert_x_asynchronous_results\"\u003eAwaiting the completion of Vert.x asynchronous results\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_suspending_extension_methods\"\u003eSuspending extension methods\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_channels\"\u003eChannels\u003c/a\u003e\n\u003cul class=\"sectlevel2\"\u003e\n\u003cli\u003e\u003ca href=\"#_receiving_data\"\u003eReceiving data\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_sending_data\"\u003eSending data\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_delay_cancellation_and_timeouts\"\u003eDelay, cancellation and timeouts\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_coroutine_builders\"\u003eCoroutine builders\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_coroutine_interoperability\"\u003eCoroutine interoperability\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#_rxjava_interoperability\"\u003eRxJava interoperability\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/div\u003e","contents":"\u003ch1\u003evertx-lang-kotlin-coroutines\u003c/h1\u003e\n\n\u003cdiv id=\"preamble\"\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe \u003ccode\u003evertx-lang-kotlin-coroutines\u003c/code\u003e integrates Kotlin \u003cem\u003ecoroutines\u003c/em\u003e for performing asynchronous operations and processing events.\nThis results in using a programming model that looks like sequential code, yet it does not block kernel threads.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_introduction\"\u003e\u003ca class=\"anchor\" href=\"#_introduction\"\u003e\u003c/a\u003eIntroduction\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eOne of the key advantages of Vert.x over many legacy application platforms is that it is almost entirely non-blocking\n(of kernel threads).\nThis allows Vert.x-based applications to handle a lot of concurrency (e.g., many connections and messages) using a very\nsmall number of kernel threads, which in turns unlocks great scalability.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe non-blocking nature of Vert.x leads to asynchronous APIs. Asynchronous APIs can take various forms including\ncallbacks, promises, fibers or reactive extensions. Vert.x uses the callback style for the core APIs but it\nalso supports other models like RxJava 1 and 2.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eIn some cases, programming using asynchronous APIs can be more challenging than using a classic / sequential style\nof code, in particular with several operations need to be done in sequence. Also, error propagation is often more\ncomplex when using asynchronous APIs.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003e\u003ccode\u003evertx-lang-kotlin-coroutines\u003c/code\u003e uses \u003cem\u003ecoroutines\u003c/em\u003e. Coroutines are very lightweight threads that do not correspond\nto underlying kernel threads, so that when a \u003cem\u003ecoroutine\u003c/em\u003e needs to \u003cem\u003e\"block\u003c/em\u003e\" it gets \u003cem\u003esuspended\u003c/em\u003e and frees\nits current kernel thread so that another coroutine can process events.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003e\u003ccode\u003evertx-lang-kotlin-coroutines\u003c/code\u003e uses \u003ca href=\"https://github.com/Kotlin/kotlinx.coroutines\"\u003ekotlinx.coroutines\u003c/a\u003e to implement the Coroutines.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"admonitionblock note\"\u003e\n\u003ctable\u003e\n\u003ctr\u003e\n\u003ctd class=\"icon\"\u003e\n\u003cdiv class=\"title\"\u003e注意\u003c/div\u003e\n\u003c/td\u003e\n\u003ctd class=\"content\"\u003e\n\u003ccode\u003evertx-lang-kotlin-coroutines\u003c/code\u003e currently only works with Kotlin and will be out of the \u003ca href=\"https://kotlinlang.org/docs/reference/coroutines.html#experimental-status-of-coroutines\"\u003eexperimental\u003c/a\u003e status\nin Kotlin 1.3\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/table\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_running_a_coroutine_from_a_vert_x_context\"\u003e\u003ca class=\"anchor\" href=\"#_running_a_coroutine_from_a_vert_x_context\"\u003e\u003c/a\u003eRunning a coroutine from a Vert.x context\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eHaving imported \u003ccode\u003eio.vertx.kotlin.coroutines.VertxCoroutine\u003c/code\u003e, the \u003ccode\u003eGlobalScope.launch\u003c/code\u003e method allows to run a block of code as a\ncoroutine in the \"Global\" application scope (bounded on the lifetime of the application):\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e vertx = Vertx.vertx()\n\nGlobalScope.launch(vertx.dispatcher()) {\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e timerId = awaitEvent\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eLong\u003c/span\u003e\u0026gt; { handler -\u0026gt;\n    vertx.setTimer(\u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e, handler)\n  }\n  println(\u003cspan class=\"hljs-string\"\u003e\"Event fired from timer with id \u003cspan class=\"hljs-variable\"\u003e$timerId\u003c/span\u003e\"\u003c/span\u003e)\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe \u003ccode\u003evertx.dispatcher()\u003c/code\u003e returns a coroutine dispatcher that execute coroutines using the Vert.x event loop.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe \u003ccode\u003eawaitEvent\u003c/code\u003e function suspends the execution of the coroutine until the timer fires and resumes the coroutines\n with the value that was given to the handler.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eMore details are given in the next sections on handlers, events and stream of events.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_extending_coroutineverticle\"\u003e\u003ca class=\"anchor\" href=\"#_extending_coroutineverticle\"\u003e\u003c/a\u003eExtending CoroutineVerticle\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eYou can deploy your code as instances of \u003ccode\u003eio.vertx.kotlin.coroutines.CoroutineVerticle\u003c/code\u003e, a specialized type of verticle\nfor Kotlin coroutines. The \u003ccode\u003eCoroutineVerticle\u003c/code\u003e class implements the \u003ccode\u003ekotlinx.coroutines.experimental.CoroutineScope\u003c/code\u003e interface,\nmaking all coroutines builder methods bounded by default to the verticle context. You should override the suspending \u003ccode\u003estart()\u003c/code\u003e\nand (optionally) the suspending \u003ccode\u003estop()\u003c/code\u003e methods of the verticle:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-class\"\u003e\u003cspan class=\"hljs-keyword\"\u003eclass\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eMyVerticle\u003c/span\u003e : \u003cspan class=\"hljs-type\"\u003eCoroutineVerticle\u003c/span\u003e\u003c/span\u003e() {\n  \u003cspan class=\"hljs-keyword\"\u003eoverride\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003estart\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003eoverride\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003estop\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eAll code examples below assume to be run inside a \u003ccode\u003eCoroutineVerticle\u003c/code\u003e implementation, but you can replace all \u003ccode\u003e\u0026lt;builder\u0026gt; { .. }\u003c/code\u003e\ncalls with \u003ccode\u003eGlobalScope.\u0026lt;builder\u0026gt; { .. }\u003c/code\u003e to use the application scope instead.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_getting_one_shot_asynchronous_results\"\u003e\u003ca class=\"anchor\" href=\"#_getting_one_shot_asynchronous_results\"\u003e\u003c/a\u003eGetting one-shot asynchronous results\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eMany asynchronous operations in Vert.x take a \u003ccode\u003eHandler\u0026lt;AsyncResult\u0026lt;T\u0026gt;\u0026gt;\u003c/code\u003e as the last argument.\nAn example would be executing an object retrieval using the Vert.x Mongo client, or sending an event bus message then\nawaiting for a reply.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThis is achieved by using the \u003ccode\u003eawaitResult\u003c/code\u003e method which returns the value or throws an exception.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe coroutine is being suspended until the event is being processed, and no kernel thread is being blocked.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe method is executed by specifying the asynchronous operation that needs to be executed in the form of a block that\nis passed to the handler at run-time.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eHere is an example:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eawaitResultExample\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e consumer = vertx.eventBus().localConsumer\u0026lt;String\u0026gt;(\u003cspan class=\"hljs-string\"\u003e\"a.b.c\"\u003c/span\u003e)\n  consumer.handler { message -\u0026gt;\n    println(\u003cspan class=\"hljs-string\"\u003e\"Consumer received: \u003cspan class=\"hljs-subst\"\u003e${message.body()}\u003c/span\u003e\"\u003c/span\u003e)\n    message.reply(\u003cspan class=\"hljs-string\"\u003e\"pong\"\u003c/span\u003e)\n  }\n\n  \u003cspan class=\"hljs-comment\"\u003e// Send a message and wait for a reply\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e reply = awaitResult\u0026lt;Message\u0026lt;String\u0026gt;\u0026gt; { h -\u0026gt;\n    vertx.eventBus().send(\u003cspan class=\"hljs-string\"\u003e\"a.b.c\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"ping\"\u003c/span\u003e, h)\n  }\n  println(\u003cspan class=\"hljs-string\"\u003e\"Reply received: \u003cspan class=\"hljs-subst\"\u003e${reply.body()}\u003c/span\u003e\"\u003c/span\u003e)\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eWhen the block produces a failure, the caller can handle it as an exception using the usual exception\n\u003ccode\u003etry\u003c/code\u003e/\u003ccode\u003ecatch\u003c/code\u003e constructs:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eawaitResultFailureExample\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e consumer = vertx.eventBus().localConsumer\u0026lt;String\u0026gt;(\u003cspan class=\"hljs-string\"\u003e\"a.b.c\"\u003c/span\u003e)\n  consumer.handler { message -\u0026gt;\n    \u003cspan class=\"hljs-comment\"\u003e// The consumer will get a failure\u003c/span\u003e\n    message.fail(\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"it failed!!!\"\u003c/span\u003e)\n  }\n\n  \u003cspan class=\"hljs-comment\"\u003e// Send a message and wait for a reply\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n    awaitResult\u0026lt;Message\u0026lt;String\u0026gt;\u0026gt; { h -\u0026gt;\n      vertx.eventBus().send(\u003cspan class=\"hljs-string\"\u003e\"a.b.c\"\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"ping\"\u003c/span\u003e, h)\n    }\n  } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (e: ReplyException) {\n    \u003cspan class=\"hljs-comment\"\u003e// Handle specific reply exception here\u003c/span\u003e\n    println(\u003cspan class=\"hljs-string\"\u003e\"Reply failure: \u003cspan class=\"hljs-subst\"\u003e${e.message}\u003c/span\u003e\"\u003c/span\u003e)\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_getting_one_shot_events\"\u003e\u003ca class=\"anchor\" href=\"#_getting_one_shot_events\"\u003e\u003c/a\u003eGetting one-shot events\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eProcessing a one-shot event (and not the next occurrences, if any) is achieved using the \u003ccode\u003eawaitEvent\u003c/code\u003e function:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eawaitEventExample\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e id = awaitEvent\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eLong\u003c/span\u003e\u0026gt; { h -\u0026gt; vertx.setTimer(\u003cspan class=\"hljs-number\"\u003e2000L\u003c/span\u003e, h) }\n  println(\u003cspan class=\"hljs-string\"\u003e\"This should be fired in 2s by some time with id=\u003cspan class=\"hljs-variable\"\u003e$id\u003c/span\u003e\"\u003c/span\u003e)\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_getting_one_shot_worker_results\"\u003e\u003ca class=\"anchor\" href=\"#_getting_one_shot_worker_results\"\u003e\u003c/a\u003eGetting one-shot worker results\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eProcessing a blocking computation is achieved using the \u003ccode\u003eawaitBlocking\u003c/code\u003e function:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eawaitBlockingExample\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  awaitBlocking {\n    Thread.sleep(\u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e)\n    \u003cspan class=\"hljs-string\"\u003e\"some-string\"\u003c/span\u003e\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_streams_of_events\"\u003e\u003ca class=\"anchor\" href=\"#_streams_of_events\"\u003e\u003c/a\u003eStreams of events\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eIn many places in Vert.x APIs, streams of events are processed through handlers.\nExamples include event bus message consumers and HTTP server requests.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe \u003ccode\u003eReceiveChannelHandler\u003c/code\u003e class allows receiving events through the (suspendable) \u003ccode\u003ereceive\u003c/code\u003e method:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003estreamExample\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e adapter = vertx.receiveChannelHandler\u0026lt;Message\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eInt\u003c/span\u003e\u0026gt;\u0026gt;()\n  vertx.eventBus().localConsumer\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eInt\u003c/span\u003e\u0026gt;(\u003cspan class=\"hljs-string\"\u003e\"a.b.c\"\u003c/span\u003e).handler(adapter)\n\n  \u003cspan class=\"hljs-comment\"\u003e// Send 15 messages\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (i \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e..\u003cspan class=\"hljs-number\"\u003e15\u003c/span\u003e) vertx.eventBus().send(\u003cspan class=\"hljs-string\"\u003e\"a.b.c\"\u003c/span\u003e, i)\n\n  \u003cspan class=\"hljs-comment\"\u003e// Receive the first 10 messages\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (i \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e..\u003cspan class=\"hljs-number\"\u003e10\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e message = adapter.receive()\n    println(\u003cspan class=\"hljs-string\"\u003e\"Received: \u003cspan class=\"hljs-subst\"\u003e${message.body()}\u003c/span\u003e\"\u003c/span\u003e)\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_awaiting_the_completion_of_vert_x_asynchronous_results\"\u003e\u003ca class=\"anchor\" href=\"#_awaiting_the_completion_of_vert_x_asynchronous_results\"\u003e\u003c/a\u003eAwaiting the completion of Vert.x asynchronous results\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe \u003ccode\u003eawait\u003c/code\u003e extension method on instances of Vert.x asynchronous results suspend coroutines until they have completed, in\nwhich case the method returns the corresponding \u003ccode\u003eAsyncResult\u0026lt;T\u0026gt;\u003c/code\u003e object.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003eawaitingFuture\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e httpServerFuture = Future.future\u0026lt;HttpServer\u0026gt;()\n  vertx.createHttpServer()\n    .requestHandler { req -\u0026gt; req.response().end(\u003cspan class=\"hljs-string\"\u003e\"Hello!\"\u003c/span\u003e) }\n    .listen(\u003cspan class=\"hljs-number\"\u003e8000\u003c/span\u003e, httpServerFuture)\n\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e httpServer = httpServerFuture.await()\n  println(\u003cspan class=\"hljs-string\"\u003e\"HTTP server port: \u003cspan class=\"hljs-subst\"\u003e${httpServer.actualPort()}\u003c/span\u003e\"\u003c/span\u003e)\n\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e result = CompositeFuture.all(httpServerFuture, httpServerFuture).await()\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (result.succeeded()) {\n    println(\u003cspan class=\"hljs-string\"\u003e\"The server is now running!\"\u003c/span\u003e)\n  } \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n    result.cause().printStackTrace()\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_suspending_extension_methods\"\u003e\u003ca class=\"anchor\" href=\"#_suspending_extension_methods\"\u003e\u003c/a\u003eSuspending extension methods\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eSince \u003ccode\u003e3.6.0\u003c/code\u003e, Vert.x generates suspending extension methods for all its asynchronous methods.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eIt relieves the user from using the idiomatic \u003ccode\u003eawaitResult\u003c/code\u003e and makes the code more natural and readable.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003egeneratedSuspendingExtensionMethod\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-comment\"\u003e// Suspending extension method\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// This function has been automatically generated from the [io.vertx.core.net.NetClient original] using Vert.x codegen.\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e NetClient.\u003cspan class=\"hljs-title\"\u003econnectAwait\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(port : \u003cspan class=\"hljs-type\"\u003eInt\u003c/span\u003e, host : \u003cspan class=\"hljs-type\"\u003eString\u003c/span\u003e)\u003c/span\u003e\u003c/span\u003e : NetSocket {\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e awaitResult{\n      \u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e.connect(port, host, it)\n    }\n  }\n\n  \u003cspan class=\"hljs-comment\"\u003e// Use the extension instead of wrapping with awaitResult\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e client = vertx.createNetClient();\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e socket = client.connectAwait(\u003cspan class=\"hljs-number\"\u003e1234\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\"localhost\"\u003c/span\u003e);\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eEach asynchronous method has a suspending counterpart, e.g \u003ccode\u003exyz(1, 2, handler)\u003c/code\u003e \u0026#8658; \u003ccode\u003exyzAwait(1, 2)\u003c/code\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eSuch extensions are provided by the \u003ccode\u003eio.vertx:vertx-lang-kotlin\u003c/code\u003e dependency and covers the Vert.x stack:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"ulist\"\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003evertx-web\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003evertx-jdbc-client\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003evertx-cassandra-client\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eetc\u0026#8230;\u0026#8203;\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_channels\"\u003e\u003ca class=\"anchor\" href=\"#_channels\"\u003e\u003c/a\u003eChannels\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eChannels are similar to Java \u003ccode\u003eBlockingQueue\u003c/code\u003e except that they do not block and instead suspend the coroutine\ninstead of blocking:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"ulist\"\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003esending a value to full channel suspends the coroutine\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003ereceving a value from an empty channels also suspends the coroutine\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eVert.x \u003ccode\u003eReadStream\u003c/code\u003e and \u003ccode\u003eWriteStream\u003c/code\u003e can be adapted to channels with the \u003ccode\u003etoChannel\u003c/code\u003e extension method.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThese adapters take care of managing the back-pressure and the stream termination\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"ulist\"\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eReadStream\u0026lt;T\u0026gt;\u003c/code\u003e is adapted to a \u003ccode\u003eReceiveChannel\u0026lt;T\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003eWriteStream\u0026lt;T\u0026gt;\u003c/code\u003e is adapted to a \u003ccode\u003eSendChannel\u0026lt;T\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect2\"\u003e\n\u003ch3 id=\"_receiving_data\"\u003e\u003ca class=\"anchor\" href=\"#_receiving_data\"\u003e\u003c/a\u003eReceiving data\u003c/h3\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eChannel can be really useful when you need to handle a stream of correlated values:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ehandleTemperatureStream\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e stream = vertx.eventBus().consumer\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eDouble\u003c/span\u003e\u0026gt;(\u003cspan class=\"hljs-string\"\u003e\"temperature\"\u003c/span\u003e)\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e channel = stream.toChannel(vertx)\n\n  \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e min = \u003cspan class=\"hljs-built_in\"\u003eDouble\u003c/span\u003e.MAX_VALUE\n  \u003cspan class=\"hljs-keyword\"\u003evar\u003c/span\u003e max = \u003cspan class=\"hljs-built_in\"\u003eDouble\u003c/span\u003e.MIN_VALUE\n\n  \u003cspan class=\"hljs-comment\"\u003e// Iterate until the stream is closed\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// Non-blocking\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003efor\u003c/span\u003e (msg \u003cspan class=\"hljs-keyword\"\u003ein\u003c/span\u003e channel) {\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e temperature = msg.body()\n    min = Math.min(min, temperature)\n    max = Math.max(max, temperature)\n  }\n\n  \u003cspan class=\"hljs-comment\"\u003e// The stream is now closed\u003c/span\u003e\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eIt can also be useful for parsing protocols. We will build a non blocking HTTP request parser to show\nthe power of channels.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eWe will rely on the \u003ca href=\"http://vertx.io/docs/apidocs/io/vertx/core/parsetools/RecordParser.html\"\u003e\u003ccode\u003eRecordParser\u003c/code\u003e\u003c/a\u003e\nto slice the stream of buffer to a stream of buffer delimited by \u003ccode\u003e\\r\\n\u003c/code\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eHere is the initial version of the parser, that handles only the HTTP request-line\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003evertx.createNetServer().connectHandler { socket -\u0026gt;\n\n  \u003cspan class=\"hljs-comment\"\u003e// The record parser provides a stream of buffers delimited by \\r\\n\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e stream = RecordParser.newDelimited(\u003cspan class=\"hljs-string\"\u003e\"\\r\\n\"\u003c/span\u003e, socket)\n\n  \u003cspan class=\"hljs-comment\"\u003e// Convert the stream to a Kotlin channel\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e channel = stream.toChannel(vertx)\n\n  \u003cspan class=\"hljs-comment\"\u003e// Run the coroutine\u003c/span\u003e\n  launch {\n\n    \u003cspan class=\"hljs-comment\"\u003e// Receive the request-line\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// Non-blocking\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e line = channel.receive().toString().split(\u003cspan class=\"hljs-string\"\u003e\" \"\u003c/span\u003e)\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e method = line[\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e]\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e uri = line[\u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e]\n\n    println(\u003cspan class=\"hljs-string\"\u003e\"Received HTTP request (\u003cspan class=\"hljs-variable\"\u003e$method\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$uri\u003c/span\u003e)\"\u003c/span\u003e)\n\n    \u003cspan class=\"hljs-comment\"\u003e// Still need to parse headers and body...\u003c/span\u003e\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eParsing the request-line is as simple as calling \u003ccode\u003ereceive\u003c/code\u003e on the channel.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe next step parses HTTP headers by receiving chunks until we get an empty one\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-comment\"\u003e// Receive HTTP headers\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e headers = HashMap\u0026lt;String, String\u0026gt;()\n\u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (\u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e) {\n\n  \u003cspan class=\"hljs-comment\"\u003e// Non-blocking\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e header = channel.receive().toString()\n\n  \u003cspan class=\"hljs-comment\"\u003e// Done with parsing headers\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (header.isEmpty()) {\n    \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e\n  }\n\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e pos = header.indexOf(\u003cspan class=\"hljs-string\"\u003e':'\u003c/span\u003e)\n  headers[header.substring(\u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, pos).toLowerCase()] = header.substring(pos + \u003cspan class=\"hljs-number\"\u003e1\u003c/span\u003e).trim()\n}\n\nprintln(\u003cspan class=\"hljs-string\"\u003e\"Received HTTP request (\u003cspan class=\"hljs-variable\"\u003e$method\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$uri\u003c/span\u003e) with headers \u003cspan class=\"hljs-subst\"\u003e${headers.keys}\u003c/span\u003e\"\u003c/span\u003e)\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eFinally we terminate the parser by handling optional request bodies\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-comment\"\u003e// Receive the request body\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e transferEncoding = headers[\u003cspan class=\"hljs-string\"\u003e\"transfer-encoding\"\u003c/span\u003e]\n\u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e contentLength = headers[\u003cspan class=\"hljs-string\"\u003e\"content-length\"\u003c/span\u003e]\n\n\u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e body: Buffer?\n\u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (transferEncoding == \u003cspan class=\"hljs-string\"\u003e\"chunked\"\u003c/span\u003e) {\n\n  \u003cspan class=\"hljs-comment\"\u003e// Handle chunked encoding, e.g\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// 5\\r\\n\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// HELLO\\r\\n\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// 0\\r\\n\u003c/span\u003e\n  \u003cspan class=\"hljs-comment\"\u003e// \\r\\n\u003c/span\u003e\n\n  body = Buffer.buffer()\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (\u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e) {\n\n    \u003cspan class=\"hljs-comment\"\u003e// Parse length chunk\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// Non-blocking\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e len = channel.receive().toString().toInt(\u003cspan class=\"hljs-number\"\u003e16\u003c/span\u003e)\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (len == \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e) {\n      \u003cspan class=\"hljs-keyword\"\u003ebreak\u003c/span\u003e\n    }\n\n    \u003cspan class=\"hljs-comment\"\u003e// The stream is flipped to parse a chunk of the exact size\u003c/span\u003e\n    stream.fixedSizeMode(len + \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)\n\n    \u003cspan class=\"hljs-comment\"\u003e// Receive the chunk and append it\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// Non-blocking\u003c/span\u003e\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e chunk = channel.receive()\n    body.appendBuffer(chunk, \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e, chunk.length() - \u003cspan class=\"hljs-number\"\u003e2\u003c/span\u003e)\n\n    \u003cspan class=\"hljs-comment\"\u003e// The stream is flipped back to the \\r\\n delimiter to parse the next chunk\u003c/span\u003e\n    stream.delimitedMode(\u003cspan class=\"hljs-string\"\u003e\"\\r\\n\"\u003c/span\u003e)\n  }\n} \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (contentLength != \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e) {\n\n  \u003cspan class=\"hljs-comment\"\u003e// The stream is flipped to parse a body of the exact size\u003c/span\u003e\n  stream.fixedSizeMode(contentLength.toInt())\n\n  \u003cspan class=\"hljs-comment\"\u003e// Non-blocking\u003c/span\u003e\n  body = channel.receive()\n} \u003cspan class=\"hljs-keyword\"\u003eelse\u003c/span\u003e {\n  body = \u003cspan class=\"hljs-literal\"\u003enull\u003c/span\u003e\n}\n\n\u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e bodySize = body?.length() ?: \u003cspan class=\"hljs-number\"\u003e0\u003c/span\u003e\nprintln(\u003cspan class=\"hljs-string\"\u003e\"Received HTTP request (\u003cspan class=\"hljs-variable\"\u003e$method\u003c/span\u003e, \u003cspan class=\"hljs-variable\"\u003e$uri\u003c/span\u003e) with headers \u003cspan class=\"hljs-subst\"\u003e${headers.keys}\u003c/span\u003e and body with size \u003cspan class=\"hljs-variable\"\u003e$bodySize\u003c/span\u003e\"\u003c/span\u003e)\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect2\"\u003e\n\u003ch3 id=\"_sending_data\"\u003e\u003ca class=\"anchor\" href=\"#_sending_data\"\u003e\u003c/a\u003eSending data\u003c/h3\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eUsing a channel to send data is quite straightforward:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003esendChannel\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e stream = vertx.eventBus().publisher\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eDouble\u003c/span\u003e\u0026gt;(\u003cspan class=\"hljs-string\"\u003e\"temperature\"\u003c/span\u003e)\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e channel = stream.toChannel(vertx)\n\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (\u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e temperature = readTemperatureSensor()\n\n    \u003cspan class=\"hljs-comment\"\u003e// Broadcast the temperature\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// Non-blocking but could be suspended\u003c/span\u003e\n    channel.send(temperature)\n\n    \u003cspan class=\"hljs-comment\"\u003e// Wait for one second\u003c/span\u003e\n    awaitEvent\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eLong\u003c/span\u003e\u0026gt; { vertx.setTimer(\u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e, it) }\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eBoth \u003ccode\u003eSendChannel#send\u003c/code\u003e and \u003ccode\u003eWriteStream#write\u003c/code\u003e are non blocking operations, however unlike \u003ccode\u003eSendChannel#send\u003c/code\u003e\ncan suspend the execution when the channel is full, the equivalent without a channel would look like\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003esuspend\u003c/span\u003e \u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003efun\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003esendChannel\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e()\u003c/span\u003e\u003c/span\u003e {\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e stream = vertx.eventBus().publisher\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eDouble\u003c/span\u003e\u0026gt;(\u003cspan class=\"hljs-string\"\u003e\"temperature\"\u003c/span\u003e)\n  \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e channel = stream.toChannel(vertx)\n\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (\u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e) {\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e temperature = readTemperatureSensor()\n\n    \u003cspan class=\"hljs-comment\"\u003e// Broadcast the temperature\u003c/span\u003e\n    \u003cspan class=\"hljs-comment\"\u003e// Non-blocking but could be suspended\u003c/span\u003e\n    channel.send(temperature)\n\n    \u003cspan class=\"hljs-comment\"\u003e// Wait for one second\u003c/span\u003e\n    awaitEvent\u0026lt;\u003cspan class=\"hljs-built_in\"\u003eLong\u003c/span\u003e\u0026gt; { vertx.setTimer(\u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e, it) }\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_delay_cancellation_and_timeouts\"\u003e\u003ca class=\"anchor\" href=\"#_delay_cancellation_and_timeouts\"\u003e\u003c/a\u003eDelay, cancellation and timeouts\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eVertx dispatcher fully supports coroutine \u003ccode\u003edelay\u003c/code\u003e function via Vert.x timers:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003elaunch {\n  \u003cspan class=\"hljs-comment\"\u003e// Set a one second Vertx timer\u003c/span\u003e\n  delay(\u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e)\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eTimers support cancellation\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003e\u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e job = launch {\n  \u003cspan class=\"hljs-comment\"\u003e// Set a one second Vertx timer\u003c/span\u003e\n  \u003cspan class=\"hljs-keyword\"\u003ewhile\u003c/span\u003e (\u003cspan class=\"hljs-literal\"\u003etrue\u003c/span\u003e) {\n    delay(\u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e)\n    \u003cspan class=\"hljs-comment\"\u003e// Do something periodically\u003c/span\u003e\n  }\n}\n\n\u003cspan class=\"hljs-comment\"\u003e// Sometimes later\u003c/span\u003e\njob.cancel()\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003ecancellation is \u003ca href=\"https://github.com/Kotlin/kotlinx.coroutines/blob/master/coroutines-guide.md#cancellation-is-cooperative\"\u003ecooperative\u003c/a\u003e\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eYou can also schedule timeout with the \u003ccode\u003ewithTimeout\u003c/code\u003e function\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"listingblock\"\u003e\n\u003cdiv class=\"content\"\u003e\n\u003cpre class=\"highlight\"\u003e\u003ccode class=\"language-kotlin\" data-lang=\"kotlin\"\u003elaunch {\n  \u003cspan class=\"hljs-keyword\"\u003etry\u003c/span\u003e {\n    \u003cspan class=\"hljs-keyword\"\u003eval\u003c/span\u003e id = withTimeout\u0026lt;String\u0026gt;(\u003cspan class=\"hljs-number\"\u003e1000\u003c/span\u003e) {\n      awaitEvent { anAsyncMethod(it) }\n    }\n  } \u003cspan class=\"hljs-keyword\"\u003ecatch\u003c/span\u003e (e: TimeoutCancellationException) {\n    \u003cspan class=\"hljs-comment\"\u003e// Cancelled\u003c/span\u003e\n  }\n}\u003c/code\u003e\u003c/pre\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_coroutine_builders\"\u003e\u003ca class=\"anchor\" href=\"#_coroutine_builders\"\u003e\u003c/a\u003eCoroutine builders\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eVert.x works will all coroutine builders, as long as an instance of \u003ccode\u003eCoroutineScope\u003c/code\u003e is available: \u003ccode\u003elaunch\u003c/code\u003e, \u003ccode\u003easync\u003c/code\u003e,\n`produce', \u0026#8230;\u0026#8203; . A couple of important things to remember:\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"ulist\"\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eThe \u003ccode\u003erunBlocking\u003c/code\u003e doesn\u0026#8217;t need a \u003ccode\u003eCoroutineScope\u003c/code\u003e and must not be used from a Vert.x event loop thread.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eTo avoid memory leaks, always use \u003ccode\u003ecoroutineScope {..}\u003c/code\u003e to define a child scope. In this way, if a coroutine fails\ninside the scope, all the others, defined inside that scope, will be cancelled too.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_coroutine_interoperability\"\u003e\u003ca class=\"anchor\" href=\"#_coroutine_interoperability\"\u003e\u003c/a\u003eCoroutine interoperability\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eVert.x integration has been designed to be fully interoperable with Kotlin coroutines\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"ulist\"\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003ekotlinx.coroutines.experimental.sync.Mutex\u003c/code\u003e are executed on the event loop thread when using the vertx dispatcher\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003cdiv class=\"sect1\"\u003e\n\u003ch2 id=\"_rxjava_interoperability\"\u003e\u003ca class=\"anchor\" href=\"#_rxjava_interoperability\"\u003e\u003c/a\u003eRxJava interoperability\u003c/h2\u003e\n\u003cdiv class=\"sectionbody\"\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eThe module \u003ccode\u003evertx-lang-kotlin-coroutines\u003c/code\u003e does not have specific integration with RxJava however Kotlin coroutines\nprovide integration with RxJava, which works out nicely with \u003ccode\u003evertx-lang-kotlin-coroutines\u003c/code\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv class=\"paragraph\"\u003e\n\u003cp\u003eYou can read about it in the \u003ca href=\"https://github.com/Kotlin/kotlinx.coroutines/blob/master/reactive/coroutines-guide-reactive.md\"\u003eGuide to reactive streams with coroutines\u003c/a\u003e\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n\u003c/div\u003e"},"__N_SSG":true},"page":"/docs/[[...slug]]","query":{"slug":["3.8.4","vertx-lang-kotlin-coroutines","kotlin"]},"buildId":"gffg8fJmO9B83jNLnDyDY","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-9a5c89434732593ca2fd.js"></script><script src="/_next/static/chunks/main-b6e20584df76f29b6f35.js" async=""></script><script src="/_next/static/chunks/webpack-d7b2fb72fb7257504a38.js" async=""></script><script src="/_next/static/chunks/framework.fcef98db13e2318579fb.js" async=""></script><script src="/_next/static/chunks/commons.5b8771ac6e8a338f82f1.js" async=""></script><script src="/_next/static/chunks/styles.7064a0f84b2a7c13404a.js" async=""></script><script src="/_next/static/chunks/pages/_app-3dbbc9c041333077c167.js" async=""></script><script src="/_next/static/chunks/5df0631eea625b022d3730b3f1bf573e1b8deb37.3b9874ba65db13e7d868.js" async=""></script><script src="/_next/static/chunks/31acfd8439b7c9eee4abe9f59c7500d6c943ee0d.7cf166b02b2c6c50cd71.js" async=""></script><script src="/_next/static/chunks/pages/docs/%5B%5B...slug%5D%5D-f144718c033f8d0b431b.js" async=""></script><script src="/_next/static/gffg8fJmO9B83jNLnDyDY/_buildManifest.js" async=""></script><script src="/_next/static/gffg8fJmO9B83jNLnDyDY/_ssgManifest.js" async=""></script></body></html>