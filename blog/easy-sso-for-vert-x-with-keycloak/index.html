<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="description" content="Vert.x | Reactive applications on the JVM"/><meta name="robots" content="index,follow"/><link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet"/><link href="https://fonts.googleapis.com/css?family=Roboto+Condensed:300,400" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&amp;display=swap" rel="stylesheet"/><link rel="shortcut icon" href="/favicons/favicon.ico"/><link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png"/><link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="48x48" href="/favicons/favicon-48x48.png"/><link rel="alternate" type="application/rss+xml" href="/feed/rss.xml"/><link rel="alternate" type="application/atom+xml" href="/feed/atom.xml"/><link rel="alternate" type="application/json" href="/feed/feed.json"/><title>Easy SSO for Vert.x with Keycloak | 博客 | Eclipse Vert.x</title><meta name="next-head-count" content="16"/><link rel="preload" href="/_next/static/css/styles.f20dca63.chunk.css" as="style"/><link rel="stylesheet" href="/_next/static/css/styles.f20dca63.chunk.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-b6e20584df76f29b6f35.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-d7b2fb72fb7257504a38.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.fcef98db13e2318579fb.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.5b8771ac6e8a338f82f1.js" as="script"/><link rel="preload" href="/_next/static/chunks/styles.7064a0f84b2a7c13404a.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-3dbbc9c041333077c167.js" as="script"/><link rel="preload" href="/_next/static/chunks/5df0631eea625b022d3730b3f1bf573e1b8deb37.3b9874ba65db13e7d868.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/%5B%5B...slug%5D%5D-c36bc482402d8ffe42a5.js" as="script"/></head><body><div id="__next"><main class="page"><header><div class="navbar"><div class="navbar-content container"><div class="navbar-logo"><a href="/"><img src="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjAiIHk9IjAiIHZpZXdCb3g9IjAgMCAxMTI1LjYgMzE1LjIiIHhtbDpzcGFjZT0icHJlc2VydmUiPjxzdHlsZT4uc3Qwe2ZpbGw6Izc4MmE5MX08L3N0eWxlPjxwYXRoIGQ9Ik0xMjAuOSAyMTQuMkwxOTAuNSAwaDUyLjNsLTk4LjUgMjczLjhIOTguMkwwIDBoNTIuMWw2OC44IDIxNC4yem0yOTEuMi02Mi42SDI5OS42djg0LjJINDMxdjM4SDI1MlYwaDE3Ny43djM4LjRIMjk5LjZWMTE0aDExMi41djM3LjZ6bTgzLjctMTEzLjJINTQ2YzE2LjUuMyAyOSA0LjQgMzcuMyAxMi40IDguMyA4IDEyLjUgMTkuNCAxMi41IDM0IDAgMTQtNC41IDI1LjEtMTMuNSAzMy4yLTkgOC4xLTIxLjYgMTIuMS0zNy42IDEyLjFoLTI3LjF2MjQuMmw4Ni4xIDExOS41aDUxdi0yLjRsLTc3LjItMTA2LjdjMjQuOS01LjUgNDMuMy0yMS43IDUyLjYtMzUuOSA4LjItMTIuNiAxMy4zLTI3LjcgMTMuMy00NiAwLTI2LjgtOC42LTQ3LjQtMjUuOC02MS41QzYwMC41IDcuMSA1NzYuMSAwIDU0NC41IDBoLTk2LjN2MjczLjhoNDcuNiIvPjxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0xMDUyLjMgMTU3LjdsLTQxLjUgNjIuNyAyOS43IDUzLjRoODUuMXoiLz48Y2lyY2xlIGNsYXNzPSJzdDAiIGN4PSI4MjcuOSIgY3k9IjI3NC43IiByPSI0MC41Ii8+PHBhdGggY2xhc3M9InN0MCIgZD0iTTEwMzcgMGwtNDcuNiA3NC4yTDk0OSAwaC04NGw4NS4zIDEzNS44LTY3LjEgMTA1LjdjNS43IDkuNSA5LjEgMjAuNSA5LjIgMzIuNGg1MC4xTDExMjEuMyAwSDEwMzd6Ii8+PHBhdGggZD0iTTc2My41IDI3My44Yy4xLTkuOSAyLjUtMTkuMiA2LjYtMjcuNVYzOC40aDg1LjRWMEg2MzguMnYzOC40aDg0LjZ2MjM1LjRoNDAuN3oiLz48L3N2Zz4=" alt="Vert.x Logo"/></a></div><div class="navbar-collapse-button"><span></span><span></span><span></span></div><div class="navbar-right"><div class="navbar-menu"><span class="navbar-menu-item with-drop-down"><div class="dropdown"><a class="dropdown-title">开始<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></a><ul class="dropdown-menu"><a href="/introduction-to-vertx-and-reactive/"><li class="dropdown-item">简介</li></a><a href="/get-started/"><li class="dropdown-item">开始</li></a><a href="https://start.vertx.io/" target="_blank" rel="noreferrer"><li class="dropdown-item">App generator <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-link-icon"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></li></a></ul></div></span><a class="navbar-menu-item" href="/docs/">文档</a><span class="navbar-menu-item with-drop-down"><div class="dropdown"><a class="dropdown-title">资源<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg></a><ul class="dropdown-menu"><a href="/faq/"><li class="dropdown-item">答疑</li></a><a href="/channels/"><li class="dropdown-item">Channels</li></a><a href="https://how-to.vertx.io/" target="_blank" rel="noreferrer"><li class="dropdown-item">How-To’s <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-link-icon"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></li></a><a href="https://github.com/vert-x3/vertx-eventbus-bridge-clients" target="_blank" rel="noreferrer"><li class="dropdown-item">EventBus Bridge Clients <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="external-link-icon"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></li></a></ul></div></span><a class="navbar-menu-item" href="/blog/">博客</a><a class="navbar-menu-item" href="/community/">社区</a><a class="navbar-menu-item" href="/translation/">翻译团队</a></div><div class="navbar-social"><a href="https://github.com/vert-x3/vertx-awesome" class="navbar-social-link" title="Awesome Vert.x" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="List of awesome Vert.x projects"><title>Awesome Vert.x</title><path d="M24 11.438l-6.154-5.645-.865.944 5.128 4.7H1.895l5.128-4.705-.865-.943-6.154 5.649H0v3.72c0 1.683 1.62 3.053 3.61 3.053h3.795c1.99 0 3.61-1.37 3.61-3.051v-2.446h1.97v2.446c0 1.68 1.62 3.051 3.61 3.051h3.794c1.99 0 3.61-1.37 3.61-3.051v-3.721z"></path></svg></a><a href="https://stackoverflow.com/questions/tagged/vert.x" class="navbar-social-link" title="Stack Overflow" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="Stack Overflow questions related to Vert.x"><title>Stack Overflow</title><path d="M18.986 21.865v-6.404h2.134V24H1.844v-8.539h2.13v6.404h15.012zM6.111 19.731H16.85v-2.137H6.111v2.137zm.259-4.852l10.48 2.189.451-2.07-10.478-2.187-.453 2.068zm1.359-5.056l9.705 4.53.903-1.95-9.706-4.53-.902 1.936v.014zm2.715-4.785l8.217 6.855 1.359-1.62-8.216-6.853-1.35 1.617-.01.001zM15.751 0l-1.746 1.294 6.405 8.604 1.746-1.294L15.749 0h.002z"></path></svg></a><a href="https://www.youtube.com/channel/UCGN6L3tRhs92Uer3c6VxOSA" class="navbar-social-link" title="YouTube" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="YouTube channel of Vert.x"><title>YouTube</title><path d="M23.499 6.203a3.008 3.008 0 00-2.089-2.089c-1.87-.501-9.4-.501-9.4-.501s-7.509-.01-9.399.501a3.008 3.008 0 00-2.088 2.09A31.258 31.26 0 000 12.01a31.258 31.26 0 00.523 5.785 3.008 3.008 0 002.088 2.089c1.869.502 9.4.502 9.4.502s7.508 0 9.399-.502a3.008 3.008 0 002.089-2.09 31.258 31.26 0 00.5-5.784 31.258 31.26 0 00-.5-5.808zm-13.891 9.4V8.407l6.266 3.604z"></path></svg></a><a href="https://discord.gg/KzEMwP2" class="navbar-social-link" title="Discord" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="Eclipse Vert.x channel on Discord"><title>Discord</title><path d="M20.222 0c1.406 0 2.54 1.137 2.607 2.475V24l-2.677-2.273-1.47-1.338-1.604-1.398.67 2.205H3.71c-1.402 0-2.54-1.065-2.54-2.476V2.48C1.17 1.142 2.31.003 3.715.003h16.5L20.222 0zm-6.118 5.683h-.03l-.202.2c2.073.6 3.076 1.537 3.076 1.537-1.336-.668-2.54-1.002-3.744-1.137-.87-.135-1.74-.064-2.475 0h-.2c-.47 0-1.47.2-2.81.735-.467.203-.735.336-.735.336s1.002-1.002 3.21-1.537l-.135-.135s-1.672-.064-3.477 1.27c0 0-1.805 3.144-1.805 7.02 0 0 1 1.74 3.743 1.806 0 0 .4-.533.805-1.002-1.54-.468-2.14-1.404-2.14-1.404s.134.066.335.2h.06c.03 0 .044.015.06.03v.006c.016.016.03.03.06.03.33.136.66.27.93.4.466.202 1.065.403 1.8.536.93.135 1.996.2 3.21 0 .6-.135 1.2-.267 1.8-.535.39-.2.87-.4 1.397-.737 0 0-.6.936-2.205 1.404.33.466.795 1 .795 1 2.744-.06 3.81-1.8 3.87-1.726 0-3.87-1.815-7.02-1.815-7.02-1.635-1.214-3.165-1.26-3.435-1.26l.056-.02zm.168 4.413c.703 0 1.27.6 1.27 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334.002-.74.573-1.338 1.27-1.338zm-4.543 0c.7 0 1.266.6 1.266 1.335 0 .74-.57 1.34-1.27 1.34-.7 0-1.27-.6-1.27-1.334 0-.74.57-1.338 1.27-1.338z"></path></svg></a><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx" class="navbar-social-link" title="Vert.x User Group" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="A Google group for Vert.x users"><title>Vert.x User Group</title><path d="M.92 3.332c-.776 0-1.216.67-.692 1.383l2.537 4.403v7.86c0 2.013 1.467 3.69 3.459 3.69H20.31a3.75 3.75 0 003.69-3.69V7.043a3.723 3.723 0 00-3.668-3.71zm5.786 3.71H20.1c.587 0 1.153.357 1.153.923 0 .566-.566.922-1.153.922H6.706c-.587 0-1.153-.356-1.153-.922 0-.566.566-.923 1.153-.923zm0 3.69H20.1c.587 0 1.153.356 1.153.922 0 .566-.566.922-1.153.922H6.706c-.587 0-1.153-.356-1.153-.922 0-.566.566-.922 1.153-.922zm-.021 3.71h9.705c.587 0 1.153.356 1.153.922 0 .566-.566.923-1.153.923H6.685c-.587 0-1.153-.357-1.153-.923 0-.566.566-.922 1.153-.922Z"></path></svg></a><a href="https://shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad" class="navbar-social-link" title="Vert.x中国用户组QQ群" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24" aria-label="Vert.x中国用户组QQ群"><title>Vert.x中国用户组QQ群</title><path d="M21.395 15.035a39.548 39.548 0 0 0-.803-2.264l-1.079-2.695c.001-.032.014-.562.014-.836C19.526 4.632 17.351 0 12 0S4.474 4.632 4.474 9.241c0 .274.013.804.014.836l-1.08 2.695a38.97 38.97 0 0 0-.802 2.264c-1.021 3.283-.69 4.643-.438 4.673.54.065 2.103-2.472 2.103-2.472 0 1.469.756 3.387 2.394 4.771-.612.188-1.363.479-1.845.835-.434.32-.379.646-.301.778.343.578 5.883.369 7.482.189 1.6.18 7.14.389 7.483-.189.078-.132.132-.458-.301-.778-.483-.356-1.233-.646-1.846-.836 1.637-1.384 2.393-3.302 2.393-4.771 0 0 1.563 2.537 2.103 2.472.251-.03.581-1.39-.438-4.673zM12.662 4.846c.039-1.052.659-1.878 1.385-1.846s1.281.912 1.242 1.964c-.039 1.051-.659 1.878-1.385 1.846s-1.282-.912-1.242-1.964zM9.954 3c.725-.033 1.345.794 1.384 1.846.04 1.052-.517 1.931-1.242 1.963-.726.033-1.346-.794-1.385-1.845C8.672 3.912 9.228 3.033 9.954 3zM7.421 8.294c.194-.43 2.147-.908 4.566-.908h.026c2.418 0 4.372.479 4.566.908a.14.14 0 0 1 .014.061c0 .031-.01.059-.026.083-.163.238-2.333 1.416-4.553 1.416h-.026c-2.221 0-4.39-1.178-4.553-1.416a.136.136 0 0 1-.014-.144zm10.422 8.622c-.22 3.676-2.403 5.987-5.774 6.021h-.137c-3.37-.033-5.554-2.345-5.773-6.021-.081-1.35.001-2.496.147-3.43.318.063.638.122.958.176v3.506s1.658.334 3.318.103v-3.225c.488.027.96.04 1.406.034h.025c1.678.021 3.714-.204 5.683-.594.146.934.227 2.08.147 3.43zM10.48 5.804c.313-.041.542-.409.508-.825-.033-.415-.314-.72-.629-.679-.313.04-.541.409-.508.824.034.417.315.72.629.68zM14.479 5.156c.078.037.221.042.289-.146.035-.095.025-.165-.009-.214-.023-.033-.133-.118-.371-.176-.904-.22-1.341.384-1.405.499-.04.072-.012.176.056.227.067.051.139.037.179-.006.58-.628 1.21-.208 1.261-.184z"></path></svg></a></div></div></div></div></header><div class="page-content"><div class="container"><div class="blog-post"><div class="blog-navbar"><h2>Blog</h2><ul><li><a href="/blog/">All posts</a></li><li><a href="/blog/category/releases/">releases</a></li><li><a href="/blog/category/guides/">guides</a></li><li><a href="/blog/category/news/">news</a></li></ul><div class="feed-icons"><a href="/feed/atom.xml"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></div></div><div class="blog-post-main"><div class="blog-post-content"><h1>Easy SSO for Vert.x with Keycloak</h1><span><p><strong>TL;DR:</strong></p><p>In this blog post you’ll learn:</p><ul><li>How to im­ple­ment Sin­gle Sign-​on with OpenID Con­nect</li><li>How to use Key­cloak’s OpenID Dis­cov­ery to infer OpenID provider con­fig­u­ra­tion</li><li>How to ob­tain user in­for­ma­tion</li><li>How to check for au­tho­riza­tion</li><li>How to call a Bearer pro­tected ser­vice with an Ac­cess Token</li><li>How to im­ple­ment a form based lo­gout</li></ul><h2 id="hello-blog"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#hello-blog"></a>Hello Blog</h2><p>This is my first post in the Vert.x Blog and I must admit that up until now I have never used Vert.x in a real project.
“Why are you here?”, you might ask… Well I cur­rently have two main hob­bies, learn­ing new things and se­cur­ing apps with <a href="https://www.keycloak.org/">Key­cloak</a>.
So a few days ago, I stum­bled upon the <a href="https://www.youtube.com/watch?v=LsaXy7SRXMY&amp;list=PLkeCJDaCC2ZsnySdg04Aq9D9FpAZY6K5D">In­tro­duc­tion to Vert.x video se­ries on youtube</a> by <a href="https://twitter.com/infosec812">Deven Phillips</a> and I was im­me­di­ately hooked. Vert.x was a new thing for me, so the next log­i­cal step was to fig­ure out how to se­cure a Vert.x app with Key­cloak.</p><p>For this ex­am­ple I build a small web app with Vert.x that shows how to im­ple­ment Sin­gle Sign-​on (SSO) with Key­cloak
and OpenID Con­nect, ob­tain in­for­ma­tion about the cur­rent user, check for roles, call bearer pro­tected ser­vices and prop­erly han­dling lo­gout.</p><h2 id="keycloak"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#keycloak"></a>Keycloak</h2><p><a href="https://www.keycloak.org/">Key­cloak</a> is a Open Source Iden­tity and Ac­cess Man­age­ment so­lu­tion which pro­vides sup­port for OpenID Con­nect
based Singe-​Sign on, among many other things. I briefly looked for ways to se­cur­ing a Vert.x app with Key­cloak
and quickly found an <a href="/blog/vertx-3-and-keycloak-tutorial/">older Vert.x Key­cloak in­te­gra­tion ex­am­ple</a> in this very blog.
Whilst this is a good start for be­gin­ners, the ex­am­ple con­tains a few is­sues, e.g.:</p><ul><li>It uses hard­coded OpenID provider con­fig­u­ra­tion</li><li>Fea­tures a very sim­plis­tic in­te­gra­tion (for the sake of sim­plic­ity)</li><li>No user in­for­ma­tion used</li><li>No lo­gout func­tion­al­ity is shown</li></ul><p>That some­how nerd­sniped me a bit and so it came that, after a long day of con­sult­ing work, I sat down to cre­ate an ex­am­ple for a com­plete Key­cloak in­te­gra­tion based on <a href="/docs/vertx-auth-oauth2/java/">Vert.x OpenID Con­nect / OAuth2 Sup­port</a>.</p><p>So let’s get started!</p><h3 id="keycloak-setup"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#keycloak-setup"></a>Keycloak Setup</h3><p>To se­cure a Vert.x app with Key­cloak we of course need a Key­cloak in­stance. Al­though <a href="https://www.keycloak.org/docs/latest/getting_started/">Key­cloak has a great get­ting started guide</a> I wanted to make it a bit eas­ier to put every­thing to­gether, there­fore I pre­pared a local Key­cloak docker con­tainer <a href="https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx#start-keycloak-with-the-vertx-realm">as de­scribed here</a> that you can start eas­ily, which comes with all the re­quired con­fig­u­ra­tion in place.</p><p>The pre­con­fig­ured Key­cloak realm named <code>vertx</code> con­tains a <code>demo-client</code> for our Vert.x web app and a set
of users for test­ing.</p><pre><code class="hljs language-haml">docker run \
  -<span class="ruby">it \
</span>  -<span class="ruby">-name vertx-keycloak \
</span>  -<span class="ruby">-rm \
</span>  -<span class="ruby">e KEYCLOAK_USER=admin \
</span>  -<span class="ruby">e KEYCLOAK_PASSWORD=admin \
</span>  -<span class="ruby">e KEYCLOAK_IMPORT=<span class="hljs-regexp">/tmp/vertx</span>-realm.json \
</span>  -<span class="ruby">v $PWD/vertx-realm.<span class="hljs-symbol">json:</span>/tmp/vertx-realm.json \
</span>  -<span class="ruby">p <span class="hljs-number">8080</span><span class="hljs-symbol">:</span><span class="hljs-number">8080</span> \
</span>  quay.io/keycloak/keycloak:9.0.0
</code></pre><h2 id="vertx-web-app"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#vertx-web-app"></a>Vert.x Web App</h2><p>The sim­ple web app con­sists of a sin­gle <code>Verticle</code>, runs on <code>http://localhost:8090</code> and pro­vides a few routes with pro­tected re­sources. <a href="https://github.com/thomasdarimont/vertx-playground/blob/master/keycloak-vertx/src/main/java/demo/MainVerticle.java">You can find the com­plete ex­am­ple here</a>.</p><p>The web app con­tains the fol­low­ing routes with han­dlers:</p><ul><li><code>/</code> - The un­pro­tected index page</li><li><code>/protected</code> - The pro­tected page, which shows a greet­ing mes­sage, users need to login to ac­cess pages be­neath this path.</li><li><code>/protected/user</code> - The pro­tected user page, which shows some in­for­ma­tion about the user.</li><li><code>/protected/admin</code> - The pro­tected admin page, which shows some in­for­ma­tion about the admin, only users with role <code>admin</code> can ac­cess this page.</li><li><code>/protected/userinfo</code> - The pro­tected user­info page, ob­tains user in­for­ma­tion from the bearer token pro­tected user­info end­point in Key­cloak.</li><li><code>/logout</code> - The pro­tected lo­gout re­source, which trig­gers the user lo­gout.</li></ul><h3 id="running-the-app"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#running-the-app"></a>Running the app</h3><p>To run the app, we need to build our app via:</p><pre><code class="hljs language-bash"><span class="hljs-built_in">cd</span> keycloak-vertx
mvn clean package
</code></pre><p>This cre­ates a runnable jar, which we can run via:</p><pre><code class="hljs language-bash">java -jar target/*.jar
</code></pre><p>Note, that you need to start Key­cloak, since our app will try to fetch con­fig­u­ra­tion from Key­cloak.</p><p>If the ap­pli­ca­tion is run­ning, just browse to: <code>http://localhost:8090/</code>.</p><p>An ex­am­ple in­ter­ac­tion with the app can be seen in the fol­low­ing gif:</p><p><img src="/images/blog/vertx-keycloak-integration/2020-03-07-vertx-keycloak-integration.gif" alt="Vert.x Keycloak Integration Demo"/></p><h3 id="router-sessionstore-and-csrf-protection"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#router-sessionstore-and-csrf-protection"></a>Router, SessionStore and CSRF Protection</h3><p>We start the con­fig­u­ra­tion of our web app by cre­at­ing a <code>Router</code> where we can add cus­tom han­dler func­tions for our routes.
To prop­erly han­dle the au­then­ti­ca­tion state we need to cre­ate a <code>SessionStore</code> and at­tach it to the <code>Router</code>.
The <code>SessionStore</code> is used by our OAuth2/OpenID Con­nect in­fra­struc­ture to as­so­ciate au­then­ti­ca­tion in­for­ma­tion with a ses­sion.
By the way, the <code>SessionStore</code> can also be clus­tered if you need to dis­trib­ute the server-​side state.</p><p>Note that if you want to keep your server state­less but still want to sup­port clus­ter­ing,
then you could pro­vide your own im­ple­men­ta­tion of a <code>SessionStore</code> which stores the ses­sion in­for­ma­tion
as an en­crypted cookie on the Client.</p><pre><code class="hljs language-java">Router router = Router.router(vertx);

<span class="hljs-comment">// Store session information on the server side</span>
SessionStore sessionStore = LocalSessionStore.create(vertx);
SessionHandler sessionHandler = SessionHandler.create(sessionStore);
router.route().handler(sessionHandler);
</code></pre><p>In order to pro­tected against CSRF at­tacks it is good prac­tice to pro­tect HTML forms with a CSRF token.
We need this for our lo­gout form that we’ll see later.</p><p>To do this we con­fig­ure a <code>CSRFHandler</code> and add it to our <code>Router</code>:</p><pre><code class="hljs language-java"><span class="hljs-comment">// CSRF handler setup required for logout form</span>
String csrfSecret = <span class="hljs-string">&quot;zwiebelfische&quot;</span>;
CSRFHandler csrfHandler = CSRFHandler.create(csrfSecret);
router.route().handler(ctx -&gt; {
            <span class="hljs-comment">// Ensures that the csrf token request parameter is available for the CsrfHandler</span>
            <span class="hljs-comment">// after the logout form was submitted.</span>
            <span class="hljs-comment">// See &quot;Handling HTML forms&quot; https://vertx.io/docs/vertx-core/java/#_handling_requests</span>
            ctx.request().setExpectMultipart(<span class="hljs-keyword">true</span>);
            ctx.request().endHandler(v -&gt; csrfHandler.handle(ctx));
        }
);
</code></pre><h3 id="keycloak-setup-via-openid-connect-discovery"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#keycloak-setup-via-openid-connect-discovery"></a>Keycloak Setup via OpenID Connect Discovery</h3><p>Our app is reg­is­tered as a con­fi­den­tial OpenID Con­nect client with Au­tho­riza­tion Code Flow in Key­cloak,
thus we need to con­fig­ure <code>client_id</code> and <code>client_secret</code>. Con­fi­den­tial clients are typ­i­cally used
for server-​side web ap­pli­ca­tions, where one can se­curely store the <code>client_secret</code>. You can find out more
about<a href="https://www.keycloak.org/docs/latest/server_admin/index.html#_access-type">The dif­fer­ent Client Ac­cess Types</a> in the Key­cloak doc­u­men­ta­tion.</p><p>Since we don’t want to con­fig­ure things like OAuth2 / OpenID Con­nect End­points our­selves, we use Key­cloak’s OpenID Con­nect dis­cov­ery end­point to infer the nec­es­sary Oauth2 / OpenID Con­nect end­point URLs.</p><pre><code class="hljs language-java">String hostname = System.getProperty(<span class="hljs-string">&quot;http.host&quot;</span>, <span class="hljs-string">&quot;localhost&quot;</span>);
<span class="hljs-keyword">int</span> port = Integer.getInteger(<span class="hljs-string">&quot;http.port&quot;</span>, <span class="hljs-number">8090</span>);
String baseUrl = String.format(<span class="hljs-string">&quot;http://%s:%d&quot;</span>, hostname, port);
String oauthCallbackPath = <span class="hljs-string">&quot;/callback&quot;</span>;

OAuth2ClientOptions clientOptions = <span class="hljs-keyword">new</span> OAuth2ClientOptions()
    .setFlow(OAuth2FlowType.AUTH_CODE)
    .setSite(System.getProperty(<span class="hljs-string">&quot;oauth2.issuer&quot;</span>, <span class="hljs-string">&quot;http://localhost:8080/auth/realms/vertx&quot;</span>))
    .setClientID(System.getProperty(<span class="hljs-string">&quot;oauth2.client_id&quot;</span>, <span class="hljs-string">&quot;demo-client&quot;</span>))
    .setClientSecret(System.getProperty(<span class="hljs-string">&quot;oauth2.client_secret&quot;</span>, <span class="hljs-string">&quot;1f88bd14-7e7f-45e7-be27-d680da6e48d8&quot;</span>));

KeycloakAuth.discover(vertx, clientOptions, asyncResult -&gt; {

    OAuth2Auth oauth2Auth = asyncResult.result();

    <span class="hljs-keyword">if</span> (oauth2Auth == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<span class="hljs-string">&quot;Could not configure Keycloak integration via OpenID Connect Discovery Endpoint. Is Keycloak running?&quot;</span>);
    }

    AuthHandler oauth2 = OAuth2AuthHandler.create(oauth2Auth, baseUrl + oauthCallbackPath)
        .setupCallback(router.get(oauthCallbackPath))
        <span class="hljs-comment">// Additional scopes: openid for OpenID Connect</span>
        .addAuthority(<span class="hljs-string">&quot;openid&quot;</span>);

    <span class="hljs-comment">// session handler needs access to the authenticated user, otherwise we get an infinite redirect loop</span>
    sessionHandler.setAuthProvider(oauth2Auth);

    <span class="hljs-comment">// protect resources beneath /protected/* with oauth2 handler</span>
    router.route(<span class="hljs-string">&quot;/protected/*&quot;</span>).handler(oauth2);

    <span class="hljs-comment">// configure route handlers</span>
    configureRoutes(router, webClient, oauth2Auth);
});

getVertx().createHttpServer().requestHandler(router).listen(port);
</code></pre><h3 id="route-handlers"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#route-handlers"></a>Route handlers</h3><p>We con­fig­ure our route han­dlers via <code>configureRoutes</code>:</p><pre><code class="hljs language-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureRoutes</span><span class="hljs-params">(Router router, WebClient webClient, OAuth2Auth oauth2Auth)</span> </span>{

    router.get(<span class="hljs-string">&quot;/&quot;</span>).handler(<span class="hljs-keyword">this</span>::handleIndex);

    router.get(<span class="hljs-string">&quot;/protected&quot;</span>).handler(<span class="hljs-keyword">this</span>::handleGreet);
    router.get(<span class="hljs-string">&quot;/protected/user&quot;</span>).handler(<span class="hljs-keyword">this</span>::handleUserPage);
    router.get(<span class="hljs-string">&quot;/protected/admin&quot;</span>).handler(<span class="hljs-keyword">this</span>::handleAdminPage);

    <span class="hljs-comment">// extract discovered userinfo endpoint url</span>
    String userInfoUrl =  ((OAuth2AuthProviderImpl)oauth2Auth).getConfig().getUserInfoPath();
    router.get(<span class="hljs-string">&quot;/protected/userinfo&quot;</span>).handler(createUserInfoHandler(webClient, userInfoUrl));

    router.post(<span class="hljs-string">&quot;/logout&quot;</span>).handler(<span class="hljs-keyword">this</span>::handleLogout);
}
</code></pre><p>The index han­dler ex­poses an un­pro­tected re­source:</p><pre><code class="hljs language-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleIndex</span><span class="hljs-params">(RoutingContext ctx)</span> </span>{
    respondWithOk(ctx, <span class="hljs-string">&quot;text/html&quot;</span>, <span class="hljs-string">&quot;&lt;h1&gt;Welcome to Vert.x Keycloak Example&lt;/h1&gt;&lt;br&gt;&lt;a href=\&quot;/protected\&quot;&gt;Protected&lt;/a&gt;&quot;</span>);
}
</code></pre><h3 id="extract-user-information-from-the-openid-connect-id-token"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#extract-user-information-from-the-openid-connect-id-token"></a>Extract User Information from the OpenID Connect ID Token</h3><p>Our app ex­poses a sim­ple greet­ing page which shows some in­for­ma­tion about the user and pro­vides links to other pages.</p><p>The user greet­ing han­dler is pro­tected by the Key­cloak OAuth2 / OpenID Con­nect in­te­gra­tion. To show in­for­ma­tion about
the cur­rent user, we first need to call the <code>ctx.user()</code> method to get an user ob­ject we can work with.
To ac­cess the OAuth2 token in­for­ma­tion, we need to cast it to <code>OAuth2TokenImpl</code>.</p><p>We can ex­tract the user in­for­ma­tion like the user­name from the <code>IDToken</code> ex­posed by the user ob­ject via <code>user.idToken().getString(&quot;preferred_username&quot;)</code>.
Note, there are many more claims like (name, email, give­nanme, fam­i­ly­name etc.) avail­able. The <a href="https://openid.net/specs/openid-connect-core-1_0.html#Claims">OpenID Con­nect Core Spec­i­fi­ca­tion</a> con­tains a list of avail­able claims.</p><p>We also gen­er­ate a list with links to the other pages which are sup­ported:</p><pre><code class="hljs language-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleGreet</span><span class="hljs-params">(RoutingContext ctx)</span> </span>{

    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();

    String username = oAuth2Token.idToken().getString(<span class="hljs-string">&quot;preferred_username&quot;</span>);

    String greeting = String.format(<span class="hljs-string">&quot;&lt;h1&gt;Hi %s @%s&lt;/h1&gt;&lt;ul&gt;&quot;</span> +
            <span class="hljs-string">&quot;&lt;li&gt;&lt;a href=\&quot;/protected/user\&quot;&gt;User Area&lt;/a&gt;&lt;/li&gt;&quot;</span> +
            <span class="hljs-string">&quot;&lt;li&gt;&lt;a href=\&quot;/protected/admin\&quot;&gt;Admin Area&lt;/a&gt;&lt;/li&gt;&quot;</span> +
            <span class="hljs-string">&quot;&lt;li&gt;&lt;a href=\&quot;/protected/userinfo\&quot;&gt;User Info (Remote Call)&lt;/a&gt;&lt;/li&gt;&quot;</span> +
            <span class="hljs-string">&quot;&lt;/ul&gt;&quot;</span>, username, Instant.now());

    String logoutForm = createLogoutForm(ctx);

    respondWithOk(ctx, <span class="hljs-string">&quot;text/html&quot;</span>, greeting + logoutForm);
}
</code></pre><p>The user page han­dler shows in­for­ma­tion about the cur­rent user:</p><pre><code class="hljs language-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleUserPage</span><span class="hljs-params">(RoutingContext ctx)</span> </span>{

    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();

    String username = user.idToken().getString(<span class="hljs-string">&quot;preferred_username&quot;</span>);
    String displayName = oAuth2Token.idToken().getString(<span class="hljs-string">&quot;name&quot;</span>);

    String content = String.format(<span class="hljs-string">&quot;&lt;h1&gt;User Page: %s (%s) @%s&lt;/h1&gt;&lt;a href=\&quot;/protected\&quot;&gt;Protected Area&lt;/a&gt;&quot;</span>,
                                   username, displayName, Instant.now());
    respondWithOk(ctx, <span class="hljs-string">&quot;text/html&quot;</span>, content);
}
</code></pre><h3 id="authorization-checking-for-required-roles"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#authorization-checking-for-required-roles"></a>Authorization: Checking for Required Roles</h3><p>Our app ex­poses a sim­ple admin page which shows some in­for­ma­tion for ad­mins, which should only be vis­i­ble for ad­mins. Thus we re­quire that users must have the <code>admin</code> realm role in Key­cloak to be able to ac­cess the admin page.</p><p>This is done via a call to <code>user.isAuthorized(&quot;realm:admin&quot;, cb)</code>. The han­dler func­tion <code>cb</code> ex­poses
the re­sult of the au­tho­riza­tion check via the <code>AsyncResult&lt;Boolean&gt; res</code>. If the cur­rent user has the
<code>admin</code> role then the re­sult is <code>true</code> oth­er­wise <code>false</code>:</p><pre><code class="hljs language-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleAdminPage</span><span class="hljs-params">(RoutingContext ctx)</span> </span>{

    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();

    <span class="hljs-comment">// check for realm-role &quot;admin&quot;</span>
    user.isAuthorized(<span class="hljs-string">&quot;realm:admin&quot;</span>, res -&gt; {

        <span class="hljs-keyword">if</span> (!res.succeeded() || !res.result()) {
            respondWith(ctx, <span class="hljs-number">403</span>, <span class="hljs-string">&quot;text/html&quot;</span>, <span class="hljs-string">&quot;&lt;h1&gt;Forbidden&lt;/h1&gt;&quot;</span>);
            <span class="hljs-keyword">return</span>;
        }

        String username = user.idToken().getString(<span class="hljs-string">&quot;preferred_username&quot;</span>);

        String content = String.format(<span class="hljs-string">&quot;&lt;h1&gt;Admin Page: %s @%s&lt;/h1&gt;&lt;a href=\&quot;/protected\&quot;&gt;Protected Area&lt;/a&gt;&quot;</span>,
                                        username, Instant.now());
        respondWithOk(ctx, <span class="hljs-string">&quot;text/html&quot;</span>, content);
    });
}
</code></pre><h4 id="call-services-protected-with-bearer-token"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#call-services-protected-with-bearer-token"></a>Call Services protected with Bearer Token</h4><p>Often we need to call other ser­vices from our web app that are pro­tected via Bearer Au­then­ti­ca­tion. This means
that we need a valid <code>access token</code> to ac­cess a re­source pro­vided on an­other server.</p><p>To demon­strate this we use Key­cloak’s <code>/userinfo</code> end­point as a straw man to demon­strate back­end calls with a bearer token.</p><p>We can ob­tain the cur­rent valid <code>access token</code> via <code>user.opaqueAccessToken()</code>.
Since we use a <code>WebClient</code> to call the pro­tected end­point, we need to pass the <code>access token</code>
via the <code>Authorization</code> header by call­ing <code>bearerTokenAuthentication(user.opaqueAccessToken())</code>
in the cur­rent <code>HttpRequest</code> ob­ject:</p><pre><code class="hljs language-java"><span class="hljs-function"><span class="hljs-keyword">private</span> Handler&lt;RoutingContext&gt; <span class="hljs-title">createUserInfoHandler</span><span class="hljs-params">(WebClient webClient, String userInfoUrl)</span> </span>{

    <span class="hljs-keyword">return</span> (RoutingContext ctx) -&gt; {

        OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();

        URI userInfoEndpointUri = URI.create(userInfoUrl);
        webClient
            .get(userInfoEndpointUri.getPort(), userInfoEndpointUri.getHost(), userInfoEndpointUri.getPath())
            <span class="hljs-comment">// use the access token for calls to other services protected via JWT Bearer authentication</span>
            .bearerTokenAuthentication(user.opaqueAccessToken())
            .as(BodyCodec.jsonObject())
            .send(ar -&gt; {

                <span class="hljs-keyword">if</span> (!ar.succeeded()) {
                    respondWith(ctx, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;application/json&quot;</span>, <span class="hljs-string">&quot;{}&quot;</span>);
                    <span class="hljs-keyword">return</span>;
                }

                JsonObject body = ar.result().body();
                respondWithOk(ctx, <span class="hljs-string">&quot;application/json&quot;</span>, body.encode());
            });
    };
}
</code></pre><h3 id="handle-logout"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#handle-logout"></a>Handle logout</h3><p>Now that we got a work­ing SSO login with au­tho­riza­tion, it would be great if we would allow users to lo­gout again.
To do this we can lever­age the built-​in OpenID Con­nect lo­gout func­tion­al­ity which can be called via <code>oAuth2Token.logout(cb)</code>.</p><p>The han­dler func­tion <code>cb</code> ex­poses the re­sult of the lo­gout ac­tion via the <code>AsyncResult&lt;Void&gt; res</code>.
If the lo­gout was suc­cess­full we destory our ses­sion via <code>ctx.session().destroy()</code> and redi­rect the user to the index page.</p><p>The lo­gout form is gen­er­ated via the <code>createLogoutForm</code> method.</p><p>As men­tioned ear­lier, we need to pro­tect our lo­gout form with a CSRF token to pre­vent <a href="https://owasp.org/www-community/attacks/csrf">CSRF at­tacks</a>.</p><p>Note: If we had end­points that would ac­cept data sent to the server, then we’d need to guard those end­points with an CSRF token as well.</p><p>We need to ob­tain the gen­er­ated <code>CSRFToken</code> and ren­der it into a hid­den form input field that’s trans­fered via HTTP POST when the lo­gout form is sub­mit­ted:</p><pre><code class="hljs language-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleLogout</span><span class="hljs-params">(RoutingContext ctx)</span> </span>{

    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();
    oAuth2Token.logout(res -&gt; {

        <span class="hljs-keyword">if</span> (!res.succeeded()) {
            <span class="hljs-comment">// the user might not have been logged out, to know why:</span>
            respondWith(ctx, <span class="hljs-number">500</span>, <span class="hljs-string">&quot;text/html&quot;</span>, String.format(<span class="hljs-string">&quot;&lt;h1&gt;Logout failed %s&lt;/h1&gt;&quot;</span>, res.cause()));
            <span class="hljs-keyword">return</span>;
        }

        ctx.session().destroy();
        ctx.response().putHeader(<span class="hljs-string">&quot;location&quot;</span>, <span class="hljs-string">&quot;/?logout=true&quot;</span>).setStatusCode(<span class="hljs-number">302</span>).end();
    });
}

<span class="hljs-function"><span class="hljs-keyword">private</span> String <span class="hljs-title">createLogoutForm</span><span class="hljs-params">(RoutingContext ctx)</span> </span>{

    String csrfToken = ctx.get(CSRFHandler.DEFAULT_HEADER_NAME);

    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;form action=\&quot;/logout\&quot; method=\&quot;post\&quot;&gt;&quot;</span>
            + String.format(<span class="hljs-string">&quot;&lt;input type=\&quot;hidden\&quot; name=\&quot;%s\&quot; value=\&quot;%s\&quot;&gt;&quot;</span>, CSRFHandler.DEFAULT_HEADER_NAME, csrfToken)
            + <span class="hljs-string">&quot;&lt;button&gt;Logout&lt;/button&gt;&lt;/form&gt;&quot;</span>;
}
</code></pre><p>Some ad­di­tional plumb­ing:</p><pre><code class="hljs language-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">respondWithOk</span><span class="hljs-params">(RoutingContext ctx, String contentType, String content)</span> </span>{
    respondWith(ctx, <span class="hljs-number">200</span>, contentType, content);
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">respondWith</span><span class="hljs-params">(RoutingContext ctx, <span class="hljs-keyword">int</span> statusCode, String contentType, String content)</span> </span>{
    ctx.request().response() <span class="hljs-comment">//</span>
            .putHeader(<span class="hljs-string">&quot;content-type&quot;</span>, contentType) <span class="hljs-comment">//</span>
            .setStatusCode(statusCode)
            .end(content);
}
</code></pre><h2 id="more-examples"><a aria-hidden="true" tabindex="-1" class="heading-anchor" href="#more-examples"></a>More examples</h2><p>This con­cludes the Key­cloak in­te­gra­tion ex­am­ple.</p><p>Check out the com­plete ex­am­ple in <a href="https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx">keycloak-​vertx Ex­am­ples Repo</a>.</p><p>Thank you for your time, stay tuned for more up­dates! If you want to learn more about Key­cloak, feel free to reach out to me. You can find me via <a href="https://twitter.com/thomasdarimont">thomas­da­ri­mont on twit­ter</a>.</p><p>Happy Hack­ing!</p></span></div><div class="blog-post-sidebar"><div class="blog-post-author"><img class="blog-post-author-avatar" src="https://github.com/thomasdarimont.png?size=160"/><div class="blog-post-author-name">by <a href="https://github.com/thomasdarimont" target="_blank" rel="noopener noreferrer">Thomas Darimont</a></div></div><div class="blog-post-sidebar-date">Posted on <!-- -->16 March 2020</div>in <a class="blog-post-sidebar-category" href="/blog/category/guides/">guides</a><div class="blog-post-sidebar-reading-time"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <!-- -->11 min read</div><div class="blog-post-sidebar-share-icons"><a href="https://twitter.com/intent/tweet?text=Easy%20SSO%20for%20Vert.x%20with%20Keycloak&amp;url=https%3A%2F%2Fvertx-china.github.io%2Fblog%2Feasy-sso-for-vert-x-with-keycloak&amp;via=vertx_project" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><title>Twitter</title><path d="M23.954 4.569c-.885.389-1.83.654-2.825.775 1.014-.611 1.794-1.574 2.163-2.723-.951.555-2.005.959-3.127 1.184-.896-.959-2.173-1.559-3.591-1.559-2.717 0-4.92 2.203-4.92 4.917 0 .39.045.765.127 1.124C7.691 8.094 4.066 6.13 1.64 3.161c-.427.722-.666 1.561-.666 2.475 0 1.71.87 3.213 2.188 4.096-.807-.026-1.566-.248-2.228-.616v.061c0 2.385 1.693 4.374 3.946 4.827-.413.111-.849.171-1.296.171-.314 0-.615-.03-.916-.086.631 1.953 2.445 3.377 4.604 3.417-1.68 1.319-3.809 2.105-6.102 2.105-.39 0-.779-.023-1.17-.067 2.189 1.394 4.768 2.209 7.557 2.209 9.054 0 13.999-7.496 13.999-13.986 0-.209 0-.42-.015-.63.961-.689 1.8-1.56 2.46-2.548l-.047-.02z"></path></svg></a><a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fvertx-china.github.io%2Fblog%2Feasy-sso-for-vert-x-with-keycloak" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><title>LinkedIn</title><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a><a href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Fvertx-china.github.io%2Fblog%2Feasy-sso-for-vert-x-with-keycloak" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><title>Facebook</title><path d="M23.9981 11.9991C23.9981 5.37216 18.626 0 11.9991 0C5.37216 0 0 5.37216 0 11.9991C0 17.9882 4.38789 22.9522 10.1242 23.8524V15.4676H7.07758V11.9991H10.1242V9.35553C10.1242 6.34826 11.9156 4.68714 14.6564 4.68714C15.9692 4.68714 17.3424 4.92149 17.3424 4.92149V7.87439H15.8294C14.3388 7.87439 13.8739 8.79933 13.8739 9.74824V11.9991H17.2018L16.6698 15.4676H13.8739V23.8524C19.6103 22.9522 23.9981 17.9882 23.9981 11.9991Z"></path></svg></a></div></div></div><div class="blog-post-next-prev"><div class="blog-post-next-prev-entry"><h5>Next post</h5><div class="blog-entry"><div class="blog-entry-meta"><div class="blog-entry-meta-left"><span class="blog-entry-date">2 April 2020</span>​<a class="blog-entry-category" href="/blog/category/releases/">releases</a></div><div class="blog-entry-meta-right"></div></div><h3><a href="/blog/eclipse-vert-x-3-9-0-released/">Eclipse Vert.x 3.9.0 released!</a></h3><span class="blog-entry-authors"><ul><li class=""><img src="https://github.com/vietj.png?size=50"/><a href="https://github.com/vietj" target="_blank" rel="noopener noreferrer">Julien Viet</a></li></ul></span><p class="blog-entry-summary">New features include fluent queries in SQL clients, a new Redis client, an updated Kafka client, an improved Future API, and many more things.</p><span class="read-more-link"><a href="/blog/eclipse-vert-x-3-9-0-released/"> 阅读更多</a></span></div></div><div class="blog-post-next-prev-entry"><h5>Previous post</h5><div class="blog-entry"><div class="blog-entry-meta"><div class="blog-entry-meta-left"><span class="blog-entry-date">24 January 2020</span>​<a class="blog-entry-category" href="/blog/category/releases/">releases</a></div><div class="blog-entry-meta-right"></div></div><h3><a href="/blog/eclipse-vert-x-3-8-5/">Eclipse Vert.x 3.8.5</a></h3><span class="blog-entry-authors"><ul><li class=""><img src="https://github.com/vietj.png?size=50"/><a href="https://github.com/vietj" target="_blank" rel="noopener noreferrer">Julien Viet</a></li></ul></span><p class="blog-entry-summary">This version is a minor bug fix release addressing issues found in Vert.x 3.8.4. We would like to thank you all for reporting these issues.</p><span class="read-more-link"><a href="/blog/eclipse-vert-x-3-8-5/"> 阅读更多</a></span></div></div></div><div class="blog-post-related"><h5>Related posts</h5><div class="blog-post-related-posts"><div class="blog-entry"><div class="blog-entry-meta"><div class="blog-entry-meta-left"><span class="blog-entry-date">1 October 2020</span>​<a class="blog-entry-category" href="/blog/category/guides/">guides</a></div><div class="blog-entry-meta-right"></div></div><h3><a href="/blog/jwt-authorization-for-vert-x-with-keycloak/">JWT Authorization for Vert.x with Keycloak</a></h3><span class="blog-entry-authors"><ul><li class=""><img src="https://github.com/thomasdarimont.png?size=50"/><a href="https://github.com/thomasdarimont" target="_blank" rel="noopener noreferrer">Thomas Darimont</a></li></ul></span><p class="blog-entry-summary">In this blog post, you&#x27;ll learn about JWT foundations, protect routes with JWT Authorization, JWT encoded tokens, and RBAC with Keycloak</p><span class="read-more-link"><a href="/blog/jwt-authorization-for-vert-x-with-keycloak/"> 阅读更多</a></span></div><div class="blog-entry"><div class="blog-entry-meta"><div class="blog-entry-meta-left"><span class="blog-entry-date">27 July 2015</span>​<a class="blog-entry-category" href="/blog/category/guides/">guides</a></div><div class="blog-entry-meta-right"></div></div><h3><a href="/blog/some-rest-with-vert-x/">Some Rest with Vert.x</a></h3><span class="blog-entry-authors"><ul><li class=""><img src="https://github.com/cescoffier.png?size=50"/><a href="https://github.com/cescoffier" target="_blank" rel="noopener noreferrer">Clement Escoffier</a></li></ul></span><p class="blog-entry-summary">This post is part of the Introduction to Vert.x series. Let’s go a bit further this time and develop a CRUD-ish application</p><span class="read-more-link"><a href="/blog/some-rest-with-vert-x/"> 阅读更多</a></span></div><div class="blog-entry"><div class="blog-entry-meta"><div class="blog-entry-meta-left"><span class="blog-entry-date">15 January 2016</span>​<a class="blog-entry-category" href="/blog/category/guides/">guides</a></div><div class="blog-entry-meta-right"></div></div><h3><a href="/blog/real-time-bidding-with-websockets-and-vert-x/">Real-time bidding with Websockets and Vert.x</a></h3><span class="blog-entry-authors"><ul><li class=""><img src="https://github.com/mwarc.png?size=50"/><a href="https://github.com/mwarc" target="_blank" rel="noopener noreferrer">Marcin Warczyglowa</a></li></ul></span><p class="blog-entry-summary">The expectations of users for interactivity with web applications have changed over the past few years.
    Users during bidding in auction no longer want to press the refresh button.</p><span class="read-more-link"><a href="/blog/real-time-bidding-with-websockets-and-vert-x/"> 阅读更多</a></span></div></div></div></div></div></div><footer><div class="container"><div class="footer-nav-section"><div class="footer-nav-list footer-logo"><a href="/"><img src="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjAiIHk9IjAiIHZpZXdCb3g9IjAgMCAxMTI1LjYgMzE1LjIiIHhtbDpzcGFjZT0icHJlc2VydmUiPjxzdHlsZT4uc3Qwe2ZpbGw6Izc4MmE5MX08L3N0eWxlPjxwYXRoIGQ9Ik0xMjAuOSAyMTQuMkwxOTAuNSAwaDUyLjNsLTk4LjUgMjczLjhIOTguMkwwIDBoNTIuMWw2OC44IDIxNC4yem0yOTEuMi02Mi42SDI5OS42djg0LjJINDMxdjM4SDI1MlYwaDE3Ny43djM4LjRIMjk5LjZWMTE0aDExMi41djM3LjZ6bTgzLjctMTEzLjJINTQ2YzE2LjUuMyAyOSA0LjQgMzcuMyAxMi40IDguMyA4IDEyLjUgMTkuNCAxMi41IDM0IDAgMTQtNC41IDI1LjEtMTMuNSAzMy4yLTkgOC4xLTIxLjYgMTIuMS0zNy42IDEyLjFoLTI3LjF2MjQuMmw4Ni4xIDExOS41aDUxdi0yLjRsLTc3LjItMTA2LjdjMjQuOS01LjUgNDMuMy0yMS43IDUyLjYtMzUuOSA4LjItMTIuNiAxMy4zLTI3LjcgMTMuMy00NiAwLTI2LjgtOC42LTQ3LjQtMjUuOC02MS41QzYwMC41IDcuMSA1NzYuMSAwIDU0NC41IDBoLTk2LjN2MjczLjhoNDcuNiIvPjxwYXRoIGNsYXNzPSJzdDAiIGQ9Ik0xMDUyLjMgMTU3LjdsLTQxLjUgNjIuNyAyOS43IDUzLjRoODUuMXoiLz48Y2lyY2xlIGNsYXNzPSJzdDAiIGN4PSI4MjcuOSIgY3k9IjI3NC43IiByPSI0MC41Ii8+PHBhdGggY2xhc3M9InN0MCIgZD0iTTEwMzcgMGwtNDcuNiA3NC4yTDk0OSAwaC04NGw4NS4zIDEzNS44LTY3LjEgMTA1LjdjNS43IDkuNSA5LjEgMjAuNSA5LjIgMzIuNGg1MC4xTDExMjEuMyAwSDEwMzd6Ii8+PHBhdGggZD0iTTc2My41IDI3My44Yy4xLTkuOSAyLjUtMTkuMiA2LjYtMjcuNVYzOC40aDg1LjRWMEg2MzguMnYzOC40aDg0LjZ2MjM1LjRoNDAuN3oiLz48L3N2Zz4=" alt="Vert.x Logo"/></a></div><div class="footer-nav-list"><h5>Eclipse Vert.x</h5><ul class=""><li><a class="navbar-menu-item" href="/docs/">文档</a></li><li><a href="/download/">下载</a></li><li><a href="/blog/">博客</a></li><li><a href="/community/">社区</a></li><li><a href="/translation/">翻译团队</a></li><li><a href="https://github.com/eclipse-vertx/vert.x">GitHub</a></li><li><a href="https://github.com/vertx-china/vertx-web-site">翻译GitHub</a></li></ul></div><div class="footer-nav-list"><h5>资源</h5><ul class=""><li><a href="/faq/">答疑</a></li><li><a href="/channels/">Channels</a></li><li><a href="https://how-to.vertx.io/">How-To’s</a></li><li><a href="https://start.vertx.io/">App Generator</a></li></ul></div><div class="footer-nav-list"><h5>Eclipse</h5><ul class=""><li><a href="https://www.eclipse.org/">Eclipse Foundation</a></li><li><a href="https://www.eclipse.org/legal/privacy.php">Privacy Policy</a></li><li><a href="https://www.eclipse.org/legal/termsofuse.php">Terms of Use</a></li><li><a href="https://www.eclipse.org/legal/copyright.php">Copyright Agent</a></li><li><a href="https://www.eclipse.org/legal/">Legal Resources</a></li></ul></div></div><div class="footer-copyright"><div class="footer-copyright-remarks">© <!-- -->2021<!-- --> Eclipse Vert.x<br/>Eclipse Vert.x is open source and dual-licensed under the <a href="https://creativecommons.org/licenses/by-sa/3.0/" target="_blank" rel="noopener noreferrer">Eclipse Public License 2.0</a> and the <a href="https://www.apache.org/licenses/LICENSE-2.0.html" target="_blank" rel="noopener noreferrer">Apache License 2.0</a>. <br class="footer-copyright-break"/>Website design by <a href="https://michelkraemer.com" target="_blank" rel="noopener noreferrer">Michel Krämer</a>.</div><div class="footer-copyright-eclipse-logo"><a href="https://www.eclipse.org/" target="_blank" rel="noopener noreferrer"><img src="data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHg9IjAiIHk9IjAiIHZpZXdCb3g9IjAgMCAyODEuMyA5MS4xIiB4bWw6c3BhY2U9InByZXNlcnZlIj48c3R5bGU+LnN0MHtmaWxsOiNmNzk0MjJ9LnN0MXtmaWxsOiMzZDNjM2J9PC9zdHlsZT48ZyBpZD0iTGF5ZXJfMV8xXyI+PHBhdGggY2xhc3M9InN0MCIgZD0iTTI2NS43IDg0TDI1NyA3M2gtMi43djE3LjdoMy4zdi0xMmw5LjMgMTJoMi4xVjczaC0zLjN2MTF6bS0zMi40LTguM2M0LjIgMCA1LjggMy4zIDUuOCA2LjNzLTEuNiA2LTUuOCA2LTUuNy0zLjEtNS44LTYgMS43LTYuMyA1LjgtNi4zem0wLTNjLTYuMSAwLTkuMSA0LjctOS4xIDkuMyAwIDQuNyAyLjkgOS4xIDkuMSA5LjFzOS00LjYgOS4xLTkuMi0zLTkuMi05LjEtOS4yem0tMjEuMiAxOFY3M2gtMy4zdjE3LjdoMy4zem0tMjMuNiAwaDMuM1Y3Nmg1LjZ2LTNoLTE0LjZ2M2g1LjZsLjEgMTQuN3ptLTE4LjktNi41SDE2M2wzLjMtNy42IDMuMyA3LjZ6bTIuOCA2LjVoMy42TDE2OC4yIDczaC0zLjZsLTggMTcuN2gzLjZsMS41LTMuM2g5LjNsMS40IDMuM3ptLTM4LTE0LjZoMy42YzMuOSAwIDUuNSAyLjggNS41IDUuNS4xIDIuOC0xLjUgNS44LTUuNSA1LjhoLTMuNlY3Ni4xem0zLjctMy4xaC02Ljl2MTcuN2g2LjljNi4yIDAgOC45LTQuNSA4LjktOXMtMi44LTguNy04LjktOC43em0tMjIuNCAxMUwxMDcgNzNoLTIuN3YxNy43aDMuM3YtMTJsOS4zIDEyaDIuMVY3M2gtMy4zdjExek04OC4yIDczdjEwLjJjMCAzLTEuNiA0LjktNC4zIDQuOXMtNC42LTEuNy00LjYtNC45VjczSDc2djEwLjFjMCA1LjMgMy42IDcuOSA3LjkgNy45IDQuNCAwIDcuNy0yLjcgNy43LTcuOVY3M2gtMy40em0tMzMgMi43YzQuMiAwIDUuOCAzLjMgNS44IDYuM3MtMS42IDYtNS44IDYtNS43LTMuMS01LjgtNiAxLjctNi4zIDUuOC02LjN6bTAtM2MtNi4xIDAtOS4xIDQuNy05LjEgOS4zczIuOSA5LjEgOS4xIDkuMSA5LTQuNiA5LjEtOS4yLTMtOS4yLTkuMS05LjJ6bS0yOS43IDE4di02LjVoOC45di0zLjFoLTguOXYtNC44aDkuNFY3M0gyMi4ydjE3LjZoMy4zeiIvPjxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0yNjkuNCA1NC40aC0yMi4ydi04LjloMjEuNHYtNi45aC0yMS40di05LjFoMjIuMnYtNy4yaC0yOS42djM5LjVoMjkuNnYtNy40em0tNDAtMjUuNmMtMy02LjEtOS40LTcuOC0xNS41LTcuOC03LjMgMC0xNS4zIDMuNC0xNS4zIDExLjUgMCA4LjkgNy40IDExIDE1LjUgMTIgNS4yLjYgOS4xIDIuMSA5LjEgNS44IDAgNC4zLTQuNCA1LjktOS4xIDUuOXMtOS40LTEuOS0xMS4xLTYuM2wtNi4yIDMuMmMyLjkgNy4yIDkuMSA5LjcgMTcuMiA5LjcgOC44IDAgMTYuNi0zLjggMTYuNi0xMi42IDAtOS40LTcuNy0xMS42LTE1LjktMTIuNi00LjctLjYtOC44LTEuNS04LjgtNSAwLTIuOSAyLjYtNS4yIDguMi01LjIgNC4zIDAgOCAyLjIgOS40IDQuNGw1LjktM3pNMTc2IDIyLjJjLTYuMi0uMS0xMi40IDAtMTguNiAwdjM5LjVoNy40VjUwLjFIMTc2YzE5LjQgMCAxOS40LTI3LjkgMC0yNy45em0tMTEuMSA3LjFIMTc2YzkuNSAwIDkuNSAxNCAwIDE0aC0xMS4ybC4xLTE0em0tMTggMzIuNVYyMi4yaC03LjR2MzkuNWw3LjQuMXptLTQ0LTM5LjZ2MzkuNWgyNy43di02LjloLTIwLjNWMjIuMmgtNy40ek05MC43IDUxLjdjLTIuNyAyLjUtNi4yIDQtOS45IDQtOS44IDAtMTMuNS02LjgtMTMuNi0xMy40czQuMS0xMy43IDEzLjYtMTMuN2MzLjUtLjEgNyAxLjMgOS41IDMuN2w1LTQuOGMtMy44LTMuOS05LjEtNi0xNC41LTYtMTQuMyAwLTIxIDEwLjUtMjAuOSAyMC44czYuMyAyMC4zIDIwLjkgMjAuM2M1LjYuMSAxMS0yIDE1LTUuOWwtNS4xLTV6bS0zOSAyLjdIMjkuNXYtOC45aDIxLjR2LTYuOUgyOS41di05LjFoMjIuMnYtNy4ySDIyLjJ2MzkuNWgyOS42bC0uMS03LjR6Ii8+PHBhdGggY2xhc3M9InN0MCIgZD0iTTkuOCAxOC4yQzE4LjggNC4xIDM2LjktLjggNTIuMSA2bC0xLS43QzM1LjctNC42IDE1LjItLjEgNS4zIDE1LjNzLTUuNCAzNS45IDEwIDQ1LjhsMS4xLjZDMy44IDUwLjguOCAzMi4zIDkuOCAxOC4yeiIvPjxwYXRoIGNsYXNzPSJzdDEiIGQ9Ik0yNzIuMiAyNi4xYzAtMi41IDIuMS00LjYgNC42LTQuNiAyLjUgMCA0LjYgMi4xIDQuNiA0LjYgMCAyLjUtMi4xIDQuNi00LjYgNC42LTIuNiAwLTQuNi0yLjEtNC42LTQuNnptOC42IDBjMC0yLjItMS44LTQuMS00LTQuMXMtNC4xIDEuOC00LjEgNC4xYzAgMi4yIDEuNyA0IDMuOSA0LjFoLjFjMi4zIDAgNC4xLTEuOCA0LjEtNC4xem0tNi0yLjVoMi4zYzEuMSAwIDEuOS41IDEuOSAxLjYgMCAuNy0uNCAxLjMtMS4xIDEuNWwxLjIgMS43aC0xLjRsLTEtMS41aC0uN3YxLjVoLTEuMWwtLjEtNC44em0yLjIgMi4zYy41IDAgLjgtLjMuOC0uN3MtLjMtLjctLjgtLjdoLTF2MS4zbDEgLjF6Ii8+PC9nPjwvc3ZnPg==" alt="Eclipse foundation Logo"/></a></div></div></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"categories":["releases","guides","news"],"post":{"meta":{"title":"Easy SSO for Vert.x with Keycloak","category":"guides","authors":[{"name":"Thomas Darimont","github_id":"thomasdarimont"}],"summary":"In this blog post, you'll learn how to implement Single Sign-on with OpenID Connect and how to use Keycloak together with Eclipse Vert.x."},"date":"2020-03-16","slug":"easy-sso-for-vert-x-with-keycloak","readingTime":{"text":"11 min read","minutes":10.11,"time":606599.9999999999,"words":2022},"content":{"compiledSource":"\"use strict\";\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i \u003c arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i \u003c sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) \u003e= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i \u003c sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) \u003e= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar layoutProps = {};\nvar MDXLayout = \"wrapper\";\n\nfunction MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, mdx(\"strong\", {\n    parentName: \"p\"\n  }, \"TL;DR:\")), mdx(\"p\", null, \"In this blog post you\\u2019ll learn:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to im\\xADple\\xADment Sin\\xADgle Sign-\\u200Bon with OpenID Con\\xADnect\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to use Key\\xADcloak\\u2019s OpenID Dis\\xADcov\\xADery to infer OpenID provider con\\xADfig\\xADu\\xADra\\xADtion\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to ob\\xADtain user in\\xADfor\\xADma\\xADtion\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to check for au\\xADtho\\xADriza\\xADtion\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to call a Bearer pro\\xADtected ser\\xADvice with an Ac\\xADcess Token\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"How to im\\xADple\\xADment a form based lo\\xADgout\")), mdx(\"h2\", {\n    \"id\": \"hello-blog\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#hello-blog\"\n  })), \"Hello Blog\"), mdx(\"p\", null, \"This is my first post in the Vert.x Blog and I must admit that up until now I have never used Vert.x in a real project.\\n\\u201CWhy are you here?\\u201D, you might ask\\u2026 Well I cur\\xADrently have two main hob\\xADbies, learn\\xADing new things and se\\xADcur\\xADing apps with \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.keycloak.org/\"\n  }), \"Key\\xADcloak\"), \".\\nSo a few days ago, I stum\\xADbled upon the \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.youtube.com/watch?v=LsaXy7SRXMY\u0026list=PLkeCJDaCC2ZsnySdg04Aq9D9FpAZY6K5D\"\n  }), \"In\\xADtro\\xADduc\\xADtion to Vert.x video se\\xADries on youtube\"), \" by \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://twitter.com/infosec812\"\n  }), \"Deven Phillips\"), \" and I was im\\xADme\\xADdi\\xADately hooked. Vert.x was a new thing for me, so the next log\\xADi\\xADcal step was to fig\\xADure out how to se\\xADcure a Vert.x app with Key\\xADcloak.\"), mdx(\"p\", null, \"For this ex\\xADam\\xADple I build a small web app with Vert.x that shows how to im\\xADple\\xADment Sin\\xADgle Sign-\\u200Bon (SSO) with Key\\xADcloak\\nand OpenID Con\\xADnect, ob\\xADtain in\\xADfor\\xADma\\xADtion about the cur\\xADrent user, check for roles, call bearer pro\\xADtected ser\\xADvices and prop\\xADerly han\\xADdling lo\\xADgout.\"), mdx(\"h2\", {\n    \"id\": \"keycloak\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#keycloak\"\n  })), \"Keycloak\"), mdx(\"p\", null, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.keycloak.org/\"\n  }), \"Key\\xADcloak\"), \" is a Open Source Iden\\xADtity and Ac\\xADcess Man\\xADage\\xADment so\\xADlu\\xADtion which pro\\xADvides sup\\xADport for OpenID Con\\xADnect\\nbased Singe-\\u200BSign on, among many other things. I briefly looked for ways to se\\xADcur\\xADing a Vert.x app with Key\\xADcloak\\nand quickly found an \", mdx(Link, {\n    href: \"/blog/vertx-3-and-keycloak-tutorial/\",\n    passHref: true,\n    mdxType: \"Link\"\n  }, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"\"\n  }), \"older Vert.x Key\\xADcloak in\\xADte\\xADgra\\xADtion ex\\xADam\\xADple\")), \" in this very blog.\\nWhilst this is a good start for be\\xADgin\\xADners, the ex\\xADam\\xADple con\\xADtains a few is\\xADsues, e.g.:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"It uses hard\\xADcoded OpenID provider con\\xADfig\\xADu\\xADra\\xADtion\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"Fea\\xADtures a very sim\\xADplis\\xADtic in\\xADte\\xADgra\\xADtion (for the sake of sim\\xADplic\\xADity)\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"No user in\\xADfor\\xADma\\xADtion used\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, \"No lo\\xADgout func\\xADtion\\xADal\\xADity is shown\")), mdx(\"p\", null, \"That some\\xADhow nerd\\xADsniped me a bit and so it came that, after a long day of con\\xADsult\\xADing work, I sat down to cre\\xADate an ex\\xADam\\xADple for a com\\xADplete Key\\xADcloak in\\xADte\\xADgra\\xADtion based on \", mdx(Link, {\n    href: \"/docs/vertx-auth-oauth2/java/\",\n    passHref: true,\n    mdxType: \"Link\"\n  }, mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"\"\n  }), \"Vert.x OpenID Con\\xADnect / OAuth2 Sup\\xADport\")), \".\"), mdx(\"p\", null, \"So let\\u2019s get started!\"), mdx(\"h3\", {\n    \"id\": \"keycloak-setup\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#keycloak-setup\"\n  })), \"Keycloak Setup\"), mdx(\"p\", null, \"To se\\xADcure a Vert.x app with Key\\xADcloak we of course need a Key\\xADcloak in\\xADstance. Al\\xADthough \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.keycloak.org/docs/latest/getting_started/\"\n  }), \"Key\\xADcloak has a great get\\xADting started guide\"), \" I wanted to make it a bit eas\\xADier to put every\\xADthing to\\xADgether, there\\xADfore I pre\\xADpared a local Key\\xADcloak docker con\\xADtainer \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx#start-keycloak-with-the-vertx-realm\"\n  }), \"as de\\xADscribed here\"), \" that you can start eas\\xADily, which comes with all the re\\xADquired con\\xADfig\\xADu\\xADra\\xADtion in place.\"), mdx(\"p\", null, \"The pre\\xADcon\\xADfig\\xADured Key\\xADcloak realm named \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"vertx\"), \" con\\xADtains a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"demo-client\"), \" for our Vert.x web app and a set\\nof users for test\\xADing.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-haml\"\n  }), \"docker run \\\\\\n  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"it \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"-name vertx-keycloak \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"-rm \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"e KEYCLOAK_USER=admin \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"e KEYCLOAK_PASSWORD=admin \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"e KEYCLOAK_IMPORT=\", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-regexp\"\n  }), \"/tmp/vertx\"), \"-realm.json \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"v $PWD/vertx-realm.\", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-symbol\"\n  }), \"json:\"), \"/tmp/vertx-realm.json \\\\\\n\"), \"  -\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"ruby\"\n  }), \"p \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"8080\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-symbol\"\n  }), \":\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"8080\"), \" \\\\\\n\"), \"  quay.io/keycloak/keycloak:9.0.0\\n\")), mdx(\"h2\", {\n    \"id\": \"vertx-web-app\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#vertx-web-app\"\n  })), \"Vert.x Web App\"), mdx(\"p\", null, \"The sim\\xADple web app con\\xADsists of a sin\\xADgle \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Verticle\"), \", runs on \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http://localhost:8090\"), \" and pro\\xADvides a few routes with pro\\xADtected re\\xADsources. \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/thomasdarimont/vertx-playground/blob/master/keycloak-vertx/src/main/java/demo/MainVerticle.java\"\n  }), \"You can find the com\\xADplete ex\\xADam\\xADple here\"), \".\"), mdx(\"p\", null, \"The web app con\\xADtains the fol\\xADlow\\xADing routes with han\\xADdlers:\"), mdx(\"ul\", null, mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/\"), \" - The un\\xADpro\\xADtected index page\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/protected\"), \" - The pro\\xADtected page, which shows a greet\\xADing mes\\xADsage, users need to login to ac\\xADcess pages be\\xADneath this path.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/protected/user\"), \" - The pro\\xADtected user page, which shows some in\\xADfor\\xADma\\xADtion about the user.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/protected/admin\"), \" - The pro\\xADtected admin page, which shows some in\\xADfor\\xADma\\xADtion about the admin, only users with role \", mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"admin\"), \" can ac\\xADcess this page.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/protected/userinfo\"), \" - The pro\\xADtected user\\xADinfo page, ob\\xADtains user in\\xADfor\\xADma\\xADtion from the bearer token pro\\xADtected user\\xADinfo end\\xADpoint in Key\\xADcloak.\"), mdx(\"li\", {\n    parentName: \"ul\"\n  }, mdx(\"inlineCode\", {\n    parentName: \"li\"\n  }, \"/logout\"), \" - The pro\\xADtected lo\\xADgout re\\xADsource, which trig\\xADgers the user lo\\xADgout.\")), mdx(\"h3\", {\n    \"id\": \"running-the-app\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#running-the-app\"\n  })), \"Running the app\"), mdx(\"p\", null, \"To run the app, we need to build our app via:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-bash\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-built_in\"\n  }), \"cd\"), \" keycloak-vertx\\nmvn clean package\\n\")), mdx(\"p\", null, \"This cre\\xADates a runnable jar, which we can run via:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-bash\"\n  }), \"java -jar target/*.jar\\n\")), mdx(\"p\", null, \"Note, that you need to start Key\\xADcloak, since our app will try to fetch con\\xADfig\\xADu\\xADra\\xADtion from Key\\xADcloak.\"), mdx(\"p\", null, \"If the ap\\xADpli\\xADca\\xADtion is run\\xADning, just browse to: \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"http://localhost:8090/\"), \".\"), mdx(\"p\", null, \"An ex\\xADam\\xADple in\\xADter\\xADac\\xADtion with the app can be seen in the fol\\xADlow\\xADing gif:\"), mdx(\"p\", null, mdx(\"img\", _extends({\n    parentName: \"p\"\n  }, {\n    \"src\": \"/images/blog/vertx-keycloak-integration/2020-03-07-vertx-keycloak-integration.gif\",\n    \"alt\": \"Vert.x Keycloak Integration Demo\"\n  }))), mdx(\"h3\", {\n    \"id\": \"router-sessionstore-and-csrf-protection\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#router-sessionstore-and-csrf-protection\"\n  })), \"Router, SessionStore and CSRF Protection\"), mdx(\"p\", null, \"We start the con\\xADfig\\xADu\\xADra\\xADtion of our web app by cre\\xADat\\xADing a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Router\"), \" where we can add cus\\xADtom han\\xADdler func\\xADtions for our routes.\\nTo prop\\xADerly han\\xADdle the au\\xADthen\\xADti\\xADca\\xADtion state we need to cre\\xADate a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SessionStore\"), \" and at\\xADtach it to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Router\"), \".\\nThe \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SessionStore\"), \" is used by our OAuth2/OpenID Con\\xADnect in\\xADfra\\xADstruc\\xADture to as\\xADso\\xADciate au\\xADthen\\xADti\\xADca\\xADtion in\\xADfor\\xADma\\xADtion with a ses\\xADsion.\\nBy the way, the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SessionStore\"), \" can also be clus\\xADtered if you need to dis\\xADtrib\\xADute the server-\\u200Bside state.\"), mdx(\"p\", null, \"Note that if you want to keep your server state\\xADless but still want to sup\\xADport clus\\xADter\\xADing,\\nthen you could pro\\xADvide your own im\\xADple\\xADmen\\xADta\\xADtion of a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"SessionStore\"), \" which stores the ses\\xADsion in\\xADfor\\xADma\\xADtion\\nas an en\\xADcrypted cookie on the Client.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), \"Router router = Router.router(vertx);\\n\\n\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// Store session information on the server side\"), \"\\nSessionStore sessionStore = LocalSessionStore.create(vertx);\\nSessionHandler sessionHandler = SessionHandler.create(sessionStore);\\nrouter.route().handler(sessionHandler);\\n\")), mdx(\"p\", null, \"In order to pro\\xADtected against CSRF at\\xADtacks it is good prac\\xADtice to pro\\xADtect HTML forms with a CSRF token.\\nWe need this for our lo\\xADgout form that we\\u2019ll see later.\"), mdx(\"p\", null, \"To do this we con\\xADfig\\xADure a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CSRFHandler\"), \" and add it to our \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Router\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// CSRF handler setup required for logout form\"), \"\\nString csrfSecret = \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"zwiebelfische\\\"\"), \";\\nCSRFHandler csrfHandler = CSRFHandler.create(csrfSecret);\\nrouter.route().handler(ctx -\u003e {\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// Ensures that the csrf token request parameter is available for the CsrfHandler\"), \"\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// after the logout form was submitted.\"), \"\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// See \\\"Handling HTML forms\\\" https://vertx.io/docs/vertx-core/java/#_handling_requests\"), \"\\n            ctx.request().setExpectMultipart(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"true\"), \");\\n            ctx.request().endHandler(v -\u003e csrfHandler.handle(ctx));\\n        }\\n);\\n\")), mdx(\"h3\", {\n    \"id\": \"keycloak-setup-via-openid-connect-discovery\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#keycloak-setup-via-openid-connect-discovery\"\n  })), \"Keycloak Setup via OpenID Connect Discovery\"), mdx(\"p\", null, \"Our app is reg\\xADis\\xADtered as a con\\xADfi\\xADden\\xADtial OpenID Con\\xADnect client with Au\\xADtho\\xADriza\\xADtion Code Flow in Key\\xADcloak,\\nthus we need to con\\xADfig\\xADure \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client_id\"), \" and \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client_secret\"), \". Con\\xADfi\\xADden\\xADtial clients are typ\\xADi\\xADcally used\\nfor server-\\u200Bside web ap\\xADpli\\xADca\\xADtions, where one can se\\xADcurely store the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client_secret\"), \". You can find out more\\nabout\", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://www.keycloak.org/docs/latest/server_admin/index.html#_access-type\"\n  }), \"The dif\\xADfer\\xADent Client Ac\\xADcess Types\"), \" in the Key\\xADcloak doc\\xADu\\xADmen\\xADta\\xADtion.\"), mdx(\"p\", null, \"Since we don\\u2019t want to con\\xADfig\\xADure things like OAuth2 / OpenID Con\\xADnect End\\xADpoints our\\xADselves, we use Key\\xADcloak\\u2019s OpenID Con\\xADnect dis\\xADcov\\xADery end\\xADpoint to infer the nec\\xADes\\xADsary Oauth2 / OpenID Con\\xADnect end\\xADpoint URLs.\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), \"String hostname = System.getProperty(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"http.host\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"localhost\\\"\"), \");\\n\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"int\"), \" port = Integer.getInteger(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"http.port\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"8090\"), \");\\nString baseUrl = String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"http://%s:%d\\\"\"), \", hostname, port);\\nString oauthCallbackPath = \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/callback\\\"\"), \";\\n\\nOAuth2ClientOptions clientOptions = \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"new\"), \" OAuth2ClientOptions()\\n    .setFlow(OAuth2FlowType.AUTH_CODE)\\n    .setSite(System.getProperty(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"oauth2.issuer\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"http://localhost:8080/auth/realms/vertx\\\"\"), \"))\\n    .setClientID(System.getProperty(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"oauth2.client_id\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"demo-client\\\"\"), \"))\\n    .setClientSecret(System.getProperty(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"oauth2.client_secret\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"1f88bd14-7e7f-45e7-be27-d680da6e48d8\\\"\"), \"));\\n\\nKeycloakAuth.discover(vertx, clientOptions, asyncResult -\u003e {\\n\\n    OAuth2Auth oauth2Auth = asyncResult.result();\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"if\"), \" (oauth2Auth == \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"null\"), \") {\\n        \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"throw\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"new\"), \" RuntimeException(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"Could not configure Keycloak integration via OpenID Connect Discovery Endpoint. Is Keycloak running?\\\"\"), \");\\n    }\\n\\n    AuthHandler oauth2 = OAuth2AuthHandler.create(oauth2Auth, baseUrl + oauthCallbackPath)\\n        .setupCallback(router.get(oauthCallbackPath))\\n        \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// Additional scopes: openid for OpenID Connect\"), \"\\n        .addAuthority(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"openid\\\"\"), \");\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// session handler needs access to the authenticated user, otherwise we get an infinite redirect loop\"), \"\\n    sessionHandler.setAuthProvider(oauth2Auth);\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// protect resources beneath /protected/* with oauth2 handler\"), \"\\n    router.route(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected/*\\\"\"), \").handler(oauth2);\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// configure route handlers\"), \"\\n    configureRoutes(router, webClient, oauth2Auth);\\n});\\n\\ngetVertx().createHttpServer().requestHandler(router).listen(port);\\n\")), mdx(\"h3\", {\n    \"id\": \"route-handlers\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#route-handlers\"\n  })), \"Route handlers\"), mdx(\"p\", null, \"We con\\xADfig\\xADure our route han\\xADdlers via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"configureRoutes\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"configureRoutes\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(Router router, WebClient webClient, OAuth2Auth oauth2Auth)\"), \" \"), \"{\\n\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleIndex);\\n\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleGreet);\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected/user\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleUserPage);\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected/admin\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleAdminPage);\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// extract discovered userinfo endpoint url\"), \"\\n    String userInfoUrl =  ((OAuth2AuthProviderImpl)oauth2Auth).getConfig().getUserInfoPath();\\n    router.get(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/protected/userinfo\\\"\"), \").handler(createUserInfoHandler(webClient, userInfoUrl));\\n\\n    router.post(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/logout\\\"\"), \").handler(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"this\"), \"::handleLogout);\\n}\\n\")), mdx(\"p\", null, \"The index han\\xADdler ex\\xADposes an un\\xADpro\\xADtected re\\xADsource:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleIndex\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n    respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003ch1\u003eWelcome to Vert.x Keycloak Example\u003c/h1\u003e\u003cbr\u003e\u003ca href=\\\\\\\"/protected\\\\\\\"\u003eProtected\u003c/a\u003e\\\"\"), \");\\n}\\n\")), mdx(\"h3\", {\n    \"id\": \"extract-user-information-from-the-openid-connect-id-token\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#extract-user-information-from-the-openid-connect-id-token\"\n  })), \"Extract User Information from the OpenID Connect ID Token\"), mdx(\"p\", null, \"Our app ex\\xADposes a sim\\xADple greet\\xADing page which shows some in\\xADfor\\xADma\\xADtion about the user and pro\\xADvides links to other pages.\"), mdx(\"p\", null, \"The user greet\\xADing han\\xADdler is pro\\xADtected by the Key\\xADcloak OAuth2 / OpenID Con\\xADnect in\\xADte\\xADgra\\xADtion. To show in\\xADfor\\xADma\\xADtion about\\nthe cur\\xADrent user, we first need to call the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ctx.user()\"), \" method to get an user ob\\xADject we can work with.\\nTo ac\\xADcess the OAuth2 token in\\xADfor\\xADma\\xADtion, we need to cast it to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"OAuth2TokenImpl\"), \".\"), mdx(\"p\", null, \"We can ex\\xADtract the user in\\xADfor\\xADma\\xADtion like the user\\xADname from the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"IDToken\"), \" ex\\xADposed by the user ob\\xADject via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"user.idToken().getString(\\\"preferred_username\\\")\"), \".\\nNote, there are many more claims like (name, email, give\\xADnanme, fam\\xADi\\xADly\\xADname etc.) avail\\xADable. The \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://openid.net/specs/openid-connect-core-1_0.html#Claims\"\n  }), \"OpenID Con\\xADnect Core Spec\\xADi\\xADfi\\xADca\\xADtion\"), \" con\\xADtains a list of avail\\xADable claims.\"), mdx(\"p\", null, \"We also gen\\xADer\\xADate a list with links to the other pages which are sup\\xADported:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleGreet\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();\\n\\n    String username = oAuth2Token.idToken().getString(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"preferred_username\\\"\"), \");\\n\\n    String greeting = String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003ch1\u003eHi %s @%s\u003c/h1\u003e\u003cul\u003e\\\"\"), \" +\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003cli\u003e\u003ca href=\\\\\\\"/protected/user\\\\\\\"\u003eUser Area\u003c/a\u003e\u003c/li\u003e\\\"\"), \" +\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003cli\u003e\u003ca href=\\\\\\\"/protected/admin\\\\\\\"\u003eAdmin Area\u003c/a\u003e\u003c/li\u003e\\\"\"), \" +\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003cli\u003e\u003ca href=\\\\\\\"/protected/userinfo\\\\\\\"\u003eUser Info (Remote Call)\u003c/a\u003e\u003c/li\u003e\\\"\"), \" +\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003c/ul\u003e\\\"\"), \", username, Instant.now());\\n\\n    String logoutForm = createLogoutForm(ctx);\\n\\n    respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", greeting + logoutForm);\\n}\\n\")), mdx(\"p\", null, \"The user page han\\xADdler shows in\\xADfor\\xADma\\xADtion about the cur\\xADrent user:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleUserPage\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\\n\\n    String username = user.idToken().getString(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"preferred_username\\\"\"), \");\\n    String displayName = oAuth2Token.idToken().getString(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"name\\\"\"), \");\\n\\n    String content = String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003ch1\u003eUser Page: %s (%s) @%s\u003c/h1\u003e\u003ca href=\\\\\\\"/protected\\\\\\\"\u003eProtected Area\u003c/a\u003e\\\"\"), \",\\n                                   username, displayName, Instant.now());\\n    respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", content);\\n}\\n\")), mdx(\"h3\", {\n    \"id\": \"authorization-checking-for-required-roles\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#authorization-checking-for-required-roles\"\n  })), \"Authorization: Checking for Required Roles\"), mdx(\"p\", null, \"Our app ex\\xADposes a sim\\xADple admin page which shows some in\\xADfor\\xADma\\xADtion for ad\\xADmins, which should only be vis\\xADi\\xADble for ad\\xADmins. Thus we re\\xADquire that users must have the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"admin\"), \" realm role in Key\\xADcloak to be able to ac\\xADcess the admin page.\"), mdx(\"p\", null, \"This is done via a call to \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"user.isAuthorized(\\\"realm:admin\\\", cb)\"), \". The han\\xADdler func\\xADtion \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"cb\"), \" ex\\xADposes\\nthe re\\xADsult of the au\\xADtho\\xADriza\\xADtion check via the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AsyncResult\u003cBoolean\u003e res\"), \". If the cur\\xADrent user has the\\n\", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"admin\"), \" role then the re\\xADsult is \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"true\"), \" oth\\xADer\\xADwise \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"false\"), \":\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleAdminPage\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// check for realm-role \\\"admin\\\"\"), \"\\n    user.isAuthorized(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"realm:admin\\\"\"), \", res -\u003e {\\n\\n        \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"if\"), \" (!res.succeeded() || !res.result()) {\\n            respondWith(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"403\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003ch1\u003eForbidden\u003c/h1\u003e\\\"\"), \");\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \";\\n        }\\n\\n        String username = user.idToken().getString(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"preferred_username\\\"\"), \");\\n\\n        String content = String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003ch1\u003eAdmin Page: %s @%s\u003c/h1\u003e\u003ca href=\\\\\\\"/protected\\\\\\\"\u003eProtected Area\u003c/a\u003e\\\"\"), \",\\n                                        username, Instant.now());\\n        respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", content);\\n    });\\n}\\n\")), mdx(\"h4\", {\n    \"id\": \"call-services-protected-with-bearer-token\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h4\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#call-services-protected-with-bearer-token\"\n  })), \"Call Services protected with Bearer Token\"), mdx(\"p\", null, \"Often we need to call other ser\\xADvices from our web app that are pro\\xADtected via Bearer Au\\xADthen\\xADti\\xADca\\xADtion. This means\\nthat we need a valid \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"access token\"), \" to ac\\xADcess a re\\xADsource pro\\xADvided on an\\xADother server.\"), mdx(\"p\", null, \"To demon\\xADstrate this we use Key\\xADcloak\\u2019s \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/userinfo\"), \" end\\xADpoint as a straw man to demon\\xADstrate back\\xADend calls with a bearer token.\"), mdx(\"p\", null, \"We can ob\\xADtain the cur\\xADrent valid \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"access token\"), \" via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"user.opaqueAccessToken()\"), \".\\nSince we use a \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"WebClient\"), \" to call the pro\\xADtected end\\xADpoint, we need to pass the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"access token\"), \"\\nvia the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"Authorization\"), \" header by call\\xADing \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"bearerTokenAuthentication(user.opaqueAccessToken())\"), \"\\nin the cur\\xADrent \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"HttpRequest\"), \" ob\\xADject:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" Handler\u003cRoutingContext\u003e \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"createUserInfoHandler\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(WebClient webClient, String userInfoUrl)\"), \" \"), \"{\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \" (RoutingContext ctx) -\u003e {\\n\\n        OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\\n\\n        URI userInfoEndpointUri = URI.create(userInfoUrl);\\n        webClient\\n            .get(userInfoEndpointUri.getPort(), userInfoEndpointUri.getHost(), userInfoEndpointUri.getPath())\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// use the access token for calls to other services protected via JWT Bearer authentication\"), \"\\n            .bearerTokenAuthentication(user.opaqueAccessToken())\\n            .as(BodyCodec.jsonObject())\\n            .send(ar -\u003e {\\n\\n                \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"if\"), \" (!ar.succeeded()) {\\n                    respondWith(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"500\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"application/json\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"{}\\\"\"), \");\\n                    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \";\\n                }\\n\\n                JsonObject body = ar.result().body();\\n                respondWithOk(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"application/json\\\"\"), \", body.encode());\\n            });\\n    };\\n}\\n\")), mdx(\"h3\", {\n    \"id\": \"handle-logout\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h3\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#handle-logout\"\n  })), \"Handle logout\"), mdx(\"p\", null, \"Now that we got a work\\xADing SSO login with au\\xADtho\\xADriza\\xADtion, it would be great if we would allow users to lo\\xADgout again.\\nTo do this we can lever\\xADage the built-\\u200Bin OpenID Con\\xADnect lo\\xADgout func\\xADtion\\xADal\\xADity which can be called via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"oAuth2Token.logout(cb)\"), \".\"), mdx(\"p\", null, \"The han\\xADdler func\\xADtion \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"cb\"), \" ex\\xADposes the re\\xADsult of the lo\\xADgout ac\\xADtion via the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"AsyncResult\u003cVoid\u003e res\"), \".\\nIf the lo\\xADgout was suc\\xADcess\\xADfull we destory our ses\\xADsion via \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"ctx.session().destroy()\"), \" and redi\\xADrect the user to the index page.\"), mdx(\"p\", null, \"The lo\\xADgout form is gen\\xADer\\xADated via the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"createLogoutForm\"), \" method.\"), mdx(\"p\", null, \"As men\\xADtioned ear\\xADlier, we need to pro\\xADtect our lo\\xADgout form with a CSRF token to pre\\xADvent \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://owasp.org/www-community/attacks/csrf\"\n  }), \"CSRF at\\xADtacks\"), \".\"), mdx(\"p\", null, \"Note: If we had end\\xADpoints that would ac\\xADcept data sent to the server, then we\\u2019d need to guard those end\\xADpoints with an CSRF token as well.\"), mdx(\"p\", null, \"We need to ob\\xADtain the gen\\xADer\\xADated \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"CSRFToken\"), \" and ren\\xADder it into a hid\\xADden form input field that\\u2019s trans\\xADfered via HTTP POST when the lo\\xADgout form is sub\\xADmit\\xADted:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"handleLogout\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();\\n    oAuth2Token.logout(res -\u003e {\\n\\n        \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"if\"), \" (!res.succeeded()) {\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"// the user might not have been logged out, to know why:\"), \"\\n            respondWith(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"500\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"text/html\\\"\"), \", String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003ch1\u003eLogout failed %s\u003c/h1\u003e\\\"\"), \", res.cause()));\\n            \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \";\\n        }\\n\\n        ctx.session().destroy();\\n        ctx.response().putHeader(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"location\\\"\"), \", \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"/?logout=true\\\"\"), \").setStatusCode(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"302\"), \").end();\\n    });\\n}\\n\\n\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" String \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"createLogoutForm\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx)\"), \" \"), \"{\\n\\n    String csrfToken = ctx.get(CSRFHandler.DEFAULT_HEADER_NAME);\\n\\n    \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"return\"), \" \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003cform action=\\\\\\\"/logout\\\\\\\" method=\\\\\\\"post\\\\\\\"\u003e\\\"\"), \"\\n            + String.format(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003cinput type=\\\\\\\"hidden\\\\\\\" name=\\\\\\\"%s\\\\\\\" value=\\\\\\\"%s\\\\\\\"\u003e\\\"\"), \", CSRFHandler.DEFAULT_HEADER_NAME, csrfToken)\\n            + \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"\u003cbutton\u003eLogout\u003c/button\u003e\u003c/form\u003e\\\"\"), \";\\n}\\n\")), mdx(\"p\", null, \"Some ad\\xADdi\\xADtional plumb\\xADing:\"), mdx(\"pre\", null, mdx(\"code\", _extends({\n    parentName: \"pre\"\n  }, {\n    \"className\": \"hljs language-java\"\n  }), mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"respondWithOk\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx, String contentType, String content)\"), \" \"), \"{\\n    respondWith(ctx, \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-number\"\n  }), \"200\"), \", contentType, content);\\n}\\n\\n\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-function\"\n  }), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"private\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"void\"), \" \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-title\"\n  }), \"respondWith\"), mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-params\"\n  }), \"(RoutingContext ctx, \", mdx(\"span\", _extends({\n    parentName: \"span\"\n  }, {\n    \"className\": \"hljs-keyword\"\n  }), \"int\"), \" statusCode, String contentType, String content)\"), \" \"), \"{\\n    ctx.request().response() \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"//\"), \"\\n            .putHeader(\", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-string\"\n  }), \"\\\"content-type\\\"\"), \", contentType) \", mdx(\"span\", _extends({\n    parentName: \"code\"\n  }, {\n    \"className\": \"hljs-comment\"\n  }), \"//\"), \"\\n            .setStatusCode(statusCode)\\n            .end(content);\\n}\\n\")), mdx(\"h2\", {\n    \"id\": \"more-examples\"\n  }, mdx(\"a\", _extends({\n    parentName: \"h2\"\n  }, {\n    \"aria-hidden\": true,\n    \"tabIndex\": -1,\n    \"className\": \"heading-anchor\",\n    \"href\": \"#more-examples\"\n  })), \"More examples\"), mdx(\"p\", null, \"This con\\xADcludes the Key\\xADcloak in\\xADte\\xADgra\\xADtion ex\\xADam\\xADple.\"), mdx(\"p\", null, \"Check out the com\\xADplete ex\\xADam\\xADple in \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx\"\n  }), \"keycloak-\\u200Bvertx Ex\\xADam\\xADples Repo\"), \".\"), mdx(\"p\", null, \"Thank you for your time, stay tuned for more up\\xADdates! If you want to learn more about Key\\xADcloak, feel free to reach out to me. You can find me via \", mdx(\"a\", _extends({\n    parentName: \"p\"\n  }, {\n    \"href\": \"https://twitter.com/thomasdarimont\"\n  }), \"thomas\\xADda\\xADri\\xADmont on twit\\xADter\"), \".\"), mdx(\"p\", null, \"Happy Hack\\xADing!\"));\n}\n\n;\nMDXContent.isMDXComponent = true;","renderedOutput":"\u003cp\u003e\u003cstrong\u003eTL;DR:\u003c/strong\u003e\u003c/p\u003e\u003cp\u003eIn this blog post you’ll learn:\u003c/p\u003e\u003cul\u003e\u003cli\u003eHow to im­ple­ment Sin­gle Sign-​on with OpenID Con­nect\u003c/li\u003e\u003cli\u003eHow to use Key­cloak’s OpenID Dis­cov­ery to infer OpenID provider con­fig­u­ra­tion\u003c/li\u003e\u003cli\u003eHow to ob­tain user in­for­ma­tion\u003c/li\u003e\u003cli\u003eHow to check for au­tho­riza­tion\u003c/li\u003e\u003cli\u003eHow to call a Bearer pro­tected ser­vice with an Ac­cess Token\u003c/li\u003e\u003cli\u003eHow to im­ple­ment a form based lo­gout\u003c/li\u003e\u003c/ul\u003e\u003ch2 id=\"hello-blog\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#hello-blog\"\u003e\u003c/a\u003eHello Blog\u003c/h2\u003e\u003cp\u003eThis is my first post in the Vert.x Blog and I must admit that up until now I have never used Vert.x in a real project.\n“Why are you here?”, you might ask… Well I cur­rently have two main hob­bies, learn­ing new things and se­cur­ing apps with \u003ca href=\"https://www.keycloak.org/\"\u003eKey­cloak\u003c/a\u003e.\nSo a few days ago, I stum­bled upon the \u003ca href=\"https://www.youtube.com/watch?v=LsaXy7SRXMY\u0026amp;list=PLkeCJDaCC2ZsnySdg04Aq9D9FpAZY6K5D\"\u003eIn­tro­duc­tion to Vert.x video se­ries on youtube\u003c/a\u003e by \u003ca href=\"https://twitter.com/infosec812\"\u003eDeven Phillips\u003c/a\u003e and I was im­me­di­ately hooked. Vert.x was a new thing for me, so the next log­i­cal step was to fig­ure out how to se­cure a Vert.x app with Key­cloak.\u003c/p\u003e\u003cp\u003eFor this ex­am­ple I build a small web app with Vert.x that shows how to im­ple­ment Sin­gle Sign-​on (SSO) with Key­cloak\nand OpenID Con­nect, ob­tain in­for­ma­tion about the cur­rent user, check for roles, call bearer pro­tected ser­vices and prop­erly han­dling lo­gout.\u003c/p\u003e\u003ch2 id=\"keycloak\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#keycloak\"\u003e\u003c/a\u003eKeycloak\u003c/h2\u003e\u003cp\u003e\u003ca href=\"https://www.keycloak.org/\"\u003eKey­cloak\u003c/a\u003e is a Open Source Iden­tity and Ac­cess Man­age­ment so­lu­tion which pro­vides sup­port for OpenID Con­nect\nbased Singe-​Sign on, among many other things. I briefly looked for ways to se­cur­ing a Vert.x app with Key­cloak\nand quickly found an \u003ca href=\"/blog/vertx-3-and-keycloak-tutorial/\"\u003eolder Vert.x Key­cloak in­te­gra­tion ex­am­ple\u003c/a\u003e in this very blog.\nWhilst this is a good start for be­gin­ners, the ex­am­ple con­tains a few is­sues, e.g.:\u003c/p\u003e\u003cul\u003e\u003cli\u003eIt uses hard­coded OpenID provider con­fig­u­ra­tion\u003c/li\u003e\u003cli\u003eFea­tures a very sim­plis­tic in­te­gra­tion (for the sake of sim­plic­ity)\u003c/li\u003e\u003cli\u003eNo user in­for­ma­tion used\u003c/li\u003e\u003cli\u003eNo lo­gout func­tion­al­ity is shown\u003c/li\u003e\u003c/ul\u003e\u003cp\u003eThat some­how nerd­sniped me a bit and so it came that, after a long day of con­sult­ing work, I sat down to cre­ate an ex­am­ple for a com­plete Key­cloak in­te­gra­tion based on \u003ca href=\"/docs/vertx-auth-oauth2/java/\"\u003eVert.x OpenID Con­nect / OAuth2 Sup­port\u003c/a\u003e.\u003c/p\u003e\u003cp\u003eSo let’s get started!\u003c/p\u003e\u003ch3 id=\"keycloak-setup\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#keycloak-setup\"\u003e\u003c/a\u003eKeycloak Setup\u003c/h3\u003e\u003cp\u003eTo se­cure a Vert.x app with Key­cloak we of course need a Key­cloak in­stance. Al­though \u003ca href=\"https://www.keycloak.org/docs/latest/getting_started/\"\u003eKey­cloak has a great get­ting started guide\u003c/a\u003e I wanted to make it a bit eas­ier to put every­thing to­gether, there­fore I pre­pared a local Key­cloak docker con­tainer \u003ca href=\"https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx#start-keycloak-with-the-vertx-realm\"\u003eas de­scribed here\u003c/a\u003e that you can start eas­ily, which comes with all the re­quired con­fig­u­ra­tion in place.\u003c/p\u003e\u003cp\u003eThe pre­con­fig­ured Key­cloak realm named \u003ccode\u003evertx\u003c/code\u003e con­tains a \u003ccode\u003edemo-client\u003c/code\u003e for our Vert.x web app and a set\nof users for test­ing.\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-haml\"\u003edocker run \\\n  -\u003cspan class=\"ruby\"\u003eit \\\n\u003c/span\u003e  -\u003cspan class=\"ruby\"\u003e-name vertx-keycloak \\\n\u003c/span\u003e  -\u003cspan class=\"ruby\"\u003e-rm \\\n\u003c/span\u003e  -\u003cspan class=\"ruby\"\u003ee KEYCLOAK_USER=admin \\\n\u003c/span\u003e  -\u003cspan class=\"ruby\"\u003ee KEYCLOAK_PASSWORD=admin \\\n\u003c/span\u003e  -\u003cspan class=\"ruby\"\u003ee KEYCLOAK_IMPORT=\u003cspan class=\"hljs-regexp\"\u003e/tmp/vertx\u003c/span\u003e-realm.json \\\n\u003c/span\u003e  -\u003cspan class=\"ruby\"\u003ev $PWD/vertx-realm.\u003cspan class=\"hljs-symbol\"\u003ejson:\u003c/span\u003e/tmp/vertx-realm.json \\\n\u003c/span\u003e  -\u003cspan class=\"ruby\"\u003ep \u003cspan class=\"hljs-number\"\u003e8080\u003c/span\u003e\u003cspan class=\"hljs-symbol\"\u003e:\u003c/span\u003e\u003cspan class=\"hljs-number\"\u003e8080\u003c/span\u003e \\\n\u003c/span\u003e  quay.io/keycloak/keycloak:9.0.0\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"vertx-web-app\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#vertx-web-app\"\u003e\u003c/a\u003eVert.x Web App\u003c/h2\u003e\u003cp\u003eThe sim­ple web app con­sists of a sin­gle \u003ccode\u003eVerticle\u003c/code\u003e, runs on \u003ccode\u003ehttp://localhost:8090\u003c/code\u003e and pro­vides a few routes with pro­tected re­sources. \u003ca href=\"https://github.com/thomasdarimont/vertx-playground/blob/master/keycloak-vertx/src/main/java/demo/MainVerticle.java\"\u003eYou can find the com­plete ex­am­ple here\u003c/a\u003e.\u003c/p\u003e\u003cp\u003eThe web app con­tains the fol­low­ing routes with han­dlers:\u003c/p\u003e\u003cul\u003e\u003cli\u003e\u003ccode\u003e/\u003c/code\u003e - The un­pro­tected index page\u003c/li\u003e\u003cli\u003e\u003ccode\u003e/protected\u003c/code\u003e - The pro­tected page, which shows a greet­ing mes­sage, users need to login to ac­cess pages be­neath this path.\u003c/li\u003e\u003cli\u003e\u003ccode\u003e/protected/user\u003c/code\u003e - The pro­tected user page, which shows some in­for­ma­tion about the user.\u003c/li\u003e\u003cli\u003e\u003ccode\u003e/protected/admin\u003c/code\u003e - The pro­tected admin page, which shows some in­for­ma­tion about the admin, only users with role \u003ccode\u003eadmin\u003c/code\u003e can ac­cess this page.\u003c/li\u003e\u003cli\u003e\u003ccode\u003e/protected/userinfo\u003c/code\u003e - The pro­tected user­info page, ob­tains user in­for­ma­tion from the bearer token pro­tected user­info end­point in Key­cloak.\u003c/li\u003e\u003cli\u003e\u003ccode\u003e/logout\u003c/code\u003e - The pro­tected lo­gout re­source, which trig­gers the user lo­gout.\u003c/li\u003e\u003c/ul\u003e\u003ch3 id=\"running-the-app\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#running-the-app\"\u003e\u003c/a\u003eRunning the app\u003c/h3\u003e\u003cp\u003eTo run the app, we need to build our app via:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003e\u003cspan class=\"hljs-built_in\"\u003ecd\u003c/span\u003e keycloak-vertx\nmvn clean package\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThis cre­ates a runnable jar, which we can run via:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-bash\"\u003ejava -jar target/*.jar\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eNote, that you need to start Key­cloak, since our app will try to fetch con­fig­u­ra­tion from Key­cloak.\u003c/p\u003e\u003cp\u003eIf the ap­pli­ca­tion is run­ning, just browse to: \u003ccode\u003ehttp://localhost:8090/\u003c/code\u003e.\u003c/p\u003e\u003cp\u003eAn ex­am­ple in­ter­ac­tion with the app can be seen in the fol­low­ing gif:\u003c/p\u003e\u003cp\u003e\u003cimg src=\"/images/blog/vertx-keycloak-integration/2020-03-07-vertx-keycloak-integration.gif\" alt=\"Vert.x Keycloak Integration Demo\"/\u003e\u003c/p\u003e\u003ch3 id=\"router-sessionstore-and-csrf-protection\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#router-sessionstore-and-csrf-protection\"\u003e\u003c/a\u003eRouter, SessionStore and CSRF Protection\u003c/h3\u003e\u003cp\u003eWe start the con­fig­u­ra­tion of our web app by cre­at­ing a \u003ccode\u003eRouter\u003c/code\u003e where we can add cus­tom han­dler func­tions for our routes.\nTo prop­erly han­dle the au­then­ti­ca­tion state we need to cre­ate a \u003ccode\u003eSessionStore\u003c/code\u003e and at­tach it to the \u003ccode\u003eRouter\u003c/code\u003e.\nThe \u003ccode\u003eSessionStore\u003c/code\u003e is used by our OAuth2/OpenID Con­nect in­fra­struc­ture to as­so­ciate au­then­ti­ca­tion in­for­ma­tion with a ses­sion.\nBy the way, the \u003ccode\u003eSessionStore\u003c/code\u003e can also be clus­tered if you need to dis­trib­ute the server-​side state.\u003c/p\u003e\u003cp\u003eNote that if you want to keep your server state­less but still want to sup­port clus­ter­ing,\nthen you could pro­vide your own im­ple­men­ta­tion of a \u003ccode\u003eSessionStore\u003c/code\u003e which stores the ses­sion in­for­ma­tion\nas an en­crypted cookie on the Client.\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003eRouter router = Router.router(vertx);\n\n\u003cspan class=\"hljs-comment\"\u003e// Store session information on the server side\u003c/span\u003e\nSessionStore sessionStore = LocalSessionStore.create(vertx);\nSessionHandler sessionHandler = SessionHandler.create(sessionStore);\nrouter.route().handler(sessionHandler);\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eIn order to pro­tected against CSRF at­tacks it is good prac­tice to pro­tect HTML forms with a CSRF token.\nWe need this for our lo­gout form that we’ll see later.\u003c/p\u003e\u003cp\u003eTo do this we con­fig­ure a \u003ccode\u003eCSRFHandler\u003c/code\u003e and add it to our \u003ccode\u003eRouter\u003c/code\u003e:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-comment\"\u003e// CSRF handler setup required for logout form\u003c/span\u003e\nString csrfSecret = \u003cspan class=\"hljs-string\"\u003e\u0026quot;zwiebelfische\u0026quot;\u003c/span\u003e;\nCSRFHandler csrfHandler = CSRFHandler.create(csrfSecret);\nrouter.route().handler(ctx -\u0026gt; {\n            \u003cspan class=\"hljs-comment\"\u003e// Ensures that the csrf token request parameter is available for the CsrfHandler\u003c/span\u003e\n            \u003cspan class=\"hljs-comment\"\u003e// after the logout form was submitted.\u003c/span\u003e\n            \u003cspan class=\"hljs-comment\"\u003e// See \u0026quot;Handling HTML forms\u0026quot; https://vertx.io/docs/vertx-core/java/#_handling_requests\u003c/span\u003e\n            ctx.request().setExpectMultipart(\u003cspan class=\"hljs-keyword\"\u003etrue\u003c/span\u003e);\n            ctx.request().endHandler(v -\u0026gt; csrfHandler.handle(ctx));\n        }\n);\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"keycloak-setup-via-openid-connect-discovery\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#keycloak-setup-via-openid-connect-discovery\"\u003e\u003c/a\u003eKeycloak Setup via OpenID Connect Discovery\u003c/h3\u003e\u003cp\u003eOur app is reg­is­tered as a con­fi­den­tial OpenID Con­nect client with Au­tho­riza­tion Code Flow in Key­cloak,\nthus we need to con­fig­ure \u003ccode\u003eclient_id\u003c/code\u003e and \u003ccode\u003eclient_secret\u003c/code\u003e. Con­fi­den­tial clients are typ­i­cally used\nfor server-​side web ap­pli­ca­tions, where one can se­curely store the \u003ccode\u003eclient_secret\u003c/code\u003e. You can find out more\nabout\u003ca href=\"https://www.keycloak.org/docs/latest/server_admin/index.html#_access-type\"\u003eThe dif­fer­ent Client Ac­cess Types\u003c/a\u003e in the Key­cloak doc­u­men­ta­tion.\u003c/p\u003e\u003cp\u003eSince we don’t want to con­fig­ure things like OAuth2 / OpenID Con­nect End­points our­selves, we use Key­cloak’s OpenID Con­nect dis­cov­ery end­point to infer the nec­es­sary Oauth2 / OpenID Con­nect end­point URLs.\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003eString hostname = System.getProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;http.host\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;localhost\u0026quot;\u003c/span\u003e);\n\u003cspan class=\"hljs-keyword\"\u003eint\u003c/span\u003e port = Integer.getInteger(\u003cspan class=\"hljs-string\"\u003e\u0026quot;http.port\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-number\"\u003e8090\u003c/span\u003e);\nString baseUrl = String.format(\u003cspan class=\"hljs-string\"\u003e\u0026quot;http://%s:%d\u0026quot;\u003c/span\u003e, hostname, port);\nString oauthCallbackPath = \u003cspan class=\"hljs-string\"\u003e\u0026quot;/callback\u0026quot;\u003c/span\u003e;\n\nOAuth2ClientOptions clientOptions = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e OAuth2ClientOptions()\n    .setFlow(OAuth2FlowType.AUTH_CODE)\n    .setSite(System.getProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;oauth2.issuer\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;http://localhost:8080/auth/realms/vertx\u0026quot;\u003c/span\u003e))\n    .setClientID(System.getProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;oauth2.client_id\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;demo-client\u0026quot;\u003c/span\u003e))\n    .setClientSecret(System.getProperty(\u003cspan class=\"hljs-string\"\u003e\u0026quot;oauth2.client_secret\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;1f88bd14-7e7f-45e7-be27-d680da6e48d8\u0026quot;\u003c/span\u003e));\n\nKeycloakAuth.discover(vertx, clientOptions, asyncResult -\u0026gt; {\n\n    OAuth2Auth oauth2Auth = asyncResult.result();\n\n    \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (oauth2Auth == \u003cspan class=\"hljs-keyword\"\u003enull\u003c/span\u003e) {\n        \u003cspan class=\"hljs-keyword\"\u003ethrow\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e RuntimeException(\u003cspan class=\"hljs-string\"\u003e\u0026quot;Could not configure Keycloak integration via OpenID Connect Discovery Endpoint. Is Keycloak running?\u0026quot;\u003c/span\u003e);\n    }\n\n    AuthHandler oauth2 = OAuth2AuthHandler.create(oauth2Auth, baseUrl + oauthCallbackPath)\n        .setupCallback(router.get(oauthCallbackPath))\n        \u003cspan class=\"hljs-comment\"\u003e// Additional scopes: openid for OpenID Connect\u003c/span\u003e\n        .addAuthority(\u003cspan class=\"hljs-string\"\u003e\u0026quot;openid\u0026quot;\u003c/span\u003e);\n\n    \u003cspan class=\"hljs-comment\"\u003e// session handler needs access to the authenticated user, otherwise we get an infinite redirect loop\u003c/span\u003e\n    sessionHandler.setAuthProvider(oauth2Auth);\n\n    \u003cspan class=\"hljs-comment\"\u003e// protect resources beneath /protected/* with oauth2 handler\u003c/span\u003e\n    router.route(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/protected/*\u0026quot;\u003c/span\u003e).handler(oauth2);\n\n    \u003cspan class=\"hljs-comment\"\u003e// configure route handlers\u003c/span\u003e\n    configureRoutes(router, webClient, oauth2Auth);\n});\n\ngetVertx().createHttpServer().requestHandler(router).listen(port);\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"route-handlers\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#route-handlers\"\u003e\u003c/a\u003eRoute handlers\u003c/h3\u003e\u003cp\u003eWe con­fig­ure our route han­dlers via \u003ccode\u003econfigureRoutes\u003c/code\u003e:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003econfigureRoutes\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(Router router, WebClient webClient, OAuth2Auth oauth2Auth)\u003c/span\u003e \u003c/span\u003e{\n\n    router.get(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/\u0026quot;\u003c/span\u003e).handler(\u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e::handleIndex);\n\n    router.get(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/protected\u0026quot;\u003c/span\u003e).handler(\u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e::handleGreet);\n    router.get(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/protected/user\u0026quot;\u003c/span\u003e).handler(\u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e::handleUserPage);\n    router.get(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/protected/admin\u0026quot;\u003c/span\u003e).handler(\u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e::handleAdminPage);\n\n    \u003cspan class=\"hljs-comment\"\u003e// extract discovered userinfo endpoint url\u003c/span\u003e\n    String userInfoUrl =  ((OAuth2AuthProviderImpl)oauth2Auth).getConfig().getUserInfoPath();\n    router.get(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/protected/userinfo\u0026quot;\u003c/span\u003e).handler(createUserInfoHandler(webClient, userInfoUrl));\n\n    router.post(\u003cspan class=\"hljs-string\"\u003e\u0026quot;/logout\u0026quot;\u003c/span\u003e).handler(\u003cspan class=\"hljs-keyword\"\u003ethis\u003c/span\u003e::handleLogout);\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThe index han­dler ex­poses an un­pro­tected re­source:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ehandleIndex\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(RoutingContext ctx)\u003c/span\u003e \u003c/span\u003e{\n    respondWithOk(ctx, \u003cspan class=\"hljs-string\"\u003e\u0026quot;text/html\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;h1\u0026gt;Welcome to Vert.x Keycloak Example\u0026lt;/h1\u0026gt;\u0026lt;br\u0026gt;\u0026lt;a href=\\\u0026quot;/protected\\\u0026quot;\u0026gt;Protected\u0026lt;/a\u0026gt;\u0026quot;\u003c/span\u003e);\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"extract-user-information-from-the-openid-connect-id-token\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#extract-user-information-from-the-openid-connect-id-token\"\u003e\u003c/a\u003eExtract User Information from the OpenID Connect ID Token\u003c/h3\u003e\u003cp\u003eOur app ex­poses a sim­ple greet­ing page which shows some in­for­ma­tion about the user and pro­vides links to other pages.\u003c/p\u003e\u003cp\u003eThe user greet­ing han­dler is pro­tected by the Key­cloak OAuth2 / OpenID Con­nect in­te­gra­tion. To show in­for­ma­tion about\nthe cur­rent user, we first need to call the \u003ccode\u003ectx.user()\u003c/code\u003e method to get an user ob­ject we can work with.\nTo ac­cess the OAuth2 token in­for­ma­tion, we need to cast it to \u003ccode\u003eOAuth2TokenImpl\u003c/code\u003e.\u003c/p\u003e\u003cp\u003eWe can ex­tract the user in­for­ma­tion like the user­name from the \u003ccode\u003eIDToken\u003c/code\u003e ex­posed by the user ob­ject via \u003ccode\u003euser.idToken().getString(\u0026quot;preferred_username\u0026quot;)\u003c/code\u003e.\nNote, there are many more claims like (name, email, give­nanme, fam­i­ly­name etc.) avail­able. The \u003ca href=\"https://openid.net/specs/openid-connect-core-1_0.html#Claims\"\u003eOpenID Con­nect Core Spec­i­fi­ca­tion\u003c/a\u003e con­tains a list of avail­able claims.\u003c/p\u003e\u003cp\u003eWe also gen­er­ate a list with links to the other pages which are sup­ported:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ehandleGreet\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(RoutingContext ctx)\u003c/span\u003e \u003c/span\u003e{\n\n    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();\n\n    String username = oAuth2Token.idToken().getString(\u003cspan class=\"hljs-string\"\u003e\u0026quot;preferred_username\u0026quot;\u003c/span\u003e);\n\n    String greeting = String.format(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;h1\u0026gt;Hi %s @%s\u0026lt;/h1\u0026gt;\u0026lt;ul\u0026gt;\u0026quot;\u003c/span\u003e +\n            \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;li\u0026gt;\u0026lt;a href=\\\u0026quot;/protected/user\\\u0026quot;\u0026gt;User Area\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\u0026quot;\u003c/span\u003e +\n            \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;li\u0026gt;\u0026lt;a href=\\\u0026quot;/protected/admin\\\u0026quot;\u0026gt;Admin Area\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\u0026quot;\u003c/span\u003e +\n            \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;li\u0026gt;\u0026lt;a href=\\\u0026quot;/protected/userinfo\\\u0026quot;\u0026gt;User Info (Remote Call)\u0026lt;/a\u0026gt;\u0026lt;/li\u0026gt;\u0026quot;\u003c/span\u003e +\n            \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;/ul\u0026gt;\u0026quot;\u003c/span\u003e, username, Instant.now());\n\n    String logoutForm = createLogoutForm(ctx);\n\n    respondWithOk(ctx, \u003cspan class=\"hljs-string\"\u003e\u0026quot;text/html\u0026quot;\u003c/span\u003e, greeting + logoutForm);\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eThe user page han­dler shows in­for­ma­tion about the cur­rent user:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ehandleUserPage\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(RoutingContext ctx)\u003c/span\u003e \u003c/span\u003e{\n\n    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\n\n    String username = user.idToken().getString(\u003cspan class=\"hljs-string\"\u003e\u0026quot;preferred_username\u0026quot;\u003c/span\u003e);\n    String displayName = oAuth2Token.idToken().getString(\u003cspan class=\"hljs-string\"\u003e\u0026quot;name\u0026quot;\u003c/span\u003e);\n\n    String content = String.format(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;h1\u0026gt;User Page: %s (%s) @%s\u0026lt;/h1\u0026gt;\u0026lt;a href=\\\u0026quot;/protected\\\u0026quot;\u0026gt;Protected Area\u0026lt;/a\u0026gt;\u0026quot;\u003c/span\u003e,\n                                   username, displayName, Instant.now());\n    respondWithOk(ctx, \u003cspan class=\"hljs-string\"\u003e\u0026quot;text/html\u0026quot;\u003c/span\u003e, content);\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"authorization-checking-for-required-roles\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#authorization-checking-for-required-roles\"\u003e\u003c/a\u003eAuthorization: Checking for Required Roles\u003c/h3\u003e\u003cp\u003eOur app ex­poses a sim­ple admin page which shows some in­for­ma­tion for ad­mins, which should only be vis­i­ble for ad­mins. Thus we re­quire that users must have the \u003ccode\u003eadmin\u003c/code\u003e realm role in Key­cloak to be able to ac­cess the admin page.\u003c/p\u003e\u003cp\u003eThis is done via a call to \u003ccode\u003euser.isAuthorized(\u0026quot;realm:admin\u0026quot;, cb)\u003c/code\u003e. The han­dler func­tion \u003ccode\u003ecb\u003c/code\u003e ex­poses\nthe re­sult of the au­tho­riza­tion check via the \u003ccode\u003eAsyncResult\u0026lt;Boolean\u0026gt; res\u003c/code\u003e. If the cur­rent user has the\n\u003ccode\u003eadmin\u003c/code\u003e role then the re­sult is \u003ccode\u003etrue\u003c/code\u003e oth­er­wise \u003ccode\u003efalse\u003c/code\u003e:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ehandleAdminPage\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(RoutingContext ctx)\u003c/span\u003e \u003c/span\u003e{\n\n    OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\n\n    \u003cspan class=\"hljs-comment\"\u003e// check for realm-role \u0026quot;admin\u0026quot;\u003c/span\u003e\n    user.isAuthorized(\u003cspan class=\"hljs-string\"\u003e\u0026quot;realm:admin\u0026quot;\u003c/span\u003e, res -\u0026gt; {\n\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!res.succeeded() || !res.result()) {\n            respondWith(ctx, \u003cspan class=\"hljs-number\"\u003e403\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;text/html\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;h1\u0026gt;Forbidden\u0026lt;/h1\u0026gt;\u0026quot;\u003c/span\u003e);\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n        }\n\n        String username = user.idToken().getString(\u003cspan class=\"hljs-string\"\u003e\u0026quot;preferred_username\u0026quot;\u003c/span\u003e);\n\n        String content = String.format(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;h1\u0026gt;Admin Page: %s @%s\u0026lt;/h1\u0026gt;\u0026lt;a href=\\\u0026quot;/protected\\\u0026quot;\u0026gt;Protected Area\u0026lt;/a\u0026gt;\u0026quot;\u003c/span\u003e,\n                                        username, Instant.now());\n        respondWithOk(ctx, \u003cspan class=\"hljs-string\"\u003e\u0026quot;text/html\u0026quot;\u003c/span\u003e, content);\n    });\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch4 id=\"call-services-protected-with-bearer-token\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#call-services-protected-with-bearer-token\"\u003e\u003c/a\u003eCall Services protected with Bearer Token\u003c/h4\u003e\u003cp\u003eOften we need to call other ser­vices from our web app that are pro­tected via Bearer Au­then­ti­ca­tion. This means\nthat we need a valid \u003ccode\u003eaccess token\u003c/code\u003e to ac­cess a re­source pro­vided on an­other server.\u003c/p\u003e\u003cp\u003eTo demon­strate this we use Key­cloak’s \u003ccode\u003e/userinfo\u003c/code\u003e end­point as a straw man to demon­strate back­end calls with a bearer token.\u003c/p\u003e\u003cp\u003eWe can ob­tain the cur­rent valid \u003ccode\u003eaccess token\u003c/code\u003e via \u003ccode\u003euser.opaqueAccessToken()\u003c/code\u003e.\nSince we use a \u003ccode\u003eWebClient\u003c/code\u003e to call the pro­tected end­point, we need to pass the \u003ccode\u003eaccess token\u003c/code\u003e\nvia the \u003ccode\u003eAuthorization\u003c/code\u003e header by call­ing \u003ccode\u003ebearerTokenAuthentication(user.opaqueAccessToken())\u003c/code\u003e\nin the cur­rent \u003ccode\u003eHttpRequest\u003c/code\u003e ob­ject:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e Handler\u0026lt;RoutingContext\u0026gt; \u003cspan class=\"hljs-title\"\u003ecreateUserInfoHandler\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(WebClient webClient, String userInfoUrl)\u003c/span\u003e \u003c/span\u003e{\n\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e (RoutingContext ctx) -\u0026gt; {\n\n        OAuth2TokenImpl user = (OAuth2TokenImpl) ctx.user();\n\n        URI userInfoEndpointUri = URI.create(userInfoUrl);\n        webClient\n            .get(userInfoEndpointUri.getPort(), userInfoEndpointUri.getHost(), userInfoEndpointUri.getPath())\n            \u003cspan class=\"hljs-comment\"\u003e// use the access token for calls to other services protected via JWT Bearer authentication\u003c/span\u003e\n            .bearerTokenAuthentication(user.opaqueAccessToken())\n            .as(BodyCodec.jsonObject())\n            .send(ar -\u0026gt; {\n\n                \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!ar.succeeded()) {\n                    respondWith(ctx, \u003cspan class=\"hljs-number\"\u003e500\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;application/json\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;{}\u0026quot;\u003c/span\u003e);\n                    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n                }\n\n                JsonObject body = ar.result().body();\n                respondWithOk(ctx, \u003cspan class=\"hljs-string\"\u003e\u0026quot;application/json\u0026quot;\u003c/span\u003e, body.encode());\n            });\n    };\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch3 id=\"handle-logout\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#handle-logout\"\u003e\u003c/a\u003eHandle logout\u003c/h3\u003e\u003cp\u003eNow that we got a work­ing SSO login with au­tho­riza­tion, it would be great if we would allow users to lo­gout again.\nTo do this we can lever­age the built-​in OpenID Con­nect lo­gout func­tion­al­ity which can be called via \u003ccode\u003eoAuth2Token.logout(cb)\u003c/code\u003e.\u003c/p\u003e\u003cp\u003eThe han­dler func­tion \u003ccode\u003ecb\u003c/code\u003e ex­poses the re­sult of the lo­gout ac­tion via the \u003ccode\u003eAsyncResult\u0026lt;Void\u0026gt; res\u003c/code\u003e.\nIf the lo­gout was suc­cess­full we destory our ses­sion via \u003ccode\u003ectx.session().destroy()\u003c/code\u003e and redi­rect the user to the index page.\u003c/p\u003e\u003cp\u003eThe lo­gout form is gen­er­ated via the \u003ccode\u003ecreateLogoutForm\u003c/code\u003e method.\u003c/p\u003e\u003cp\u003eAs men­tioned ear­lier, we need to pro­tect our lo­gout form with a CSRF token to pre­vent \u003ca href=\"https://owasp.org/www-community/attacks/csrf\"\u003eCSRF at­tacks\u003c/a\u003e.\u003c/p\u003e\u003cp\u003eNote: If we had end­points that would ac­cept data sent to the server, then we’d need to guard those end­points with an CSRF token as well.\u003c/p\u003e\u003cp\u003eWe need to ob­tain the gen­er­ated \u003ccode\u003eCSRFToken\u003c/code\u003e and ren­der it into a hid­den form input field that’s trans­fered via HTTP POST when the lo­gout form is sub­mit­ted:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003ehandleLogout\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(RoutingContext ctx)\u003c/span\u003e \u003c/span\u003e{\n\n    OAuth2TokenImpl oAuth2Token = (OAuth2TokenImpl) ctx.user();\n    oAuth2Token.logout(res -\u0026gt; {\n\n        \u003cspan class=\"hljs-keyword\"\u003eif\u003c/span\u003e (!res.succeeded()) {\n            \u003cspan class=\"hljs-comment\"\u003e// the user might not have been logged out, to know why:\u003c/span\u003e\n            respondWith(ctx, \u003cspan class=\"hljs-number\"\u003e500\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;text/html\u0026quot;\u003c/span\u003e, String.format(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;h1\u0026gt;Logout failed %s\u0026lt;/h1\u0026gt;\u0026quot;\u003c/span\u003e, res.cause()));\n            \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e;\n        }\n\n        ctx.session().destroy();\n        ctx.response().putHeader(\u003cspan class=\"hljs-string\"\u003e\u0026quot;location\u0026quot;\u003c/span\u003e, \u003cspan class=\"hljs-string\"\u003e\u0026quot;/?logout=true\u0026quot;\u003c/span\u003e).setStatusCode(\u003cspan class=\"hljs-number\"\u003e302\u003c/span\u003e).end();\n    });\n}\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e String \u003cspan class=\"hljs-title\"\u003ecreateLogoutForm\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(RoutingContext ctx)\u003c/span\u003e \u003c/span\u003e{\n\n    String csrfToken = ctx.get(CSRFHandler.DEFAULT_HEADER_NAME);\n\n    \u003cspan class=\"hljs-keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;form action=\\\u0026quot;/logout\\\u0026quot; method=\\\u0026quot;post\\\u0026quot;\u0026gt;\u0026quot;\u003c/span\u003e\n            + String.format(\u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;input type=\\\u0026quot;hidden\\\u0026quot; name=\\\u0026quot;%s\\\u0026quot; value=\\\u0026quot;%s\\\u0026quot;\u0026gt;\u0026quot;\u003c/span\u003e, CSRFHandler.DEFAULT_HEADER_NAME, csrfToken)\n            + \u003cspan class=\"hljs-string\"\u003e\u0026quot;\u0026lt;button\u0026gt;Logout\u0026lt;/button\u0026gt;\u0026lt;/form\u0026gt;\u0026quot;\u003c/span\u003e;\n}\n\u003c/code\u003e\u003c/pre\u003e\u003cp\u003eSome ad­di­tional plumb­ing:\u003c/p\u003e\u003cpre\u003e\u003ccode class=\"hljs language-java\"\u003e\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003erespondWithOk\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(RoutingContext ctx, String contentType, String content)\u003c/span\u003e \u003c/span\u003e{\n    respondWith(ctx, \u003cspan class=\"hljs-number\"\u003e200\u003c/span\u003e, contentType, content);\n}\n\n\u003cspan class=\"hljs-function\"\u003e\u003cspan class=\"hljs-keyword\"\u003eprivate\u003c/span\u003e \u003cspan class=\"hljs-keyword\"\u003evoid\u003c/span\u003e \u003cspan class=\"hljs-title\"\u003erespondWith\u003c/span\u003e\u003cspan class=\"hljs-params\"\u003e(RoutingContext ctx, \u003cspan class=\"hljs-keyword\"\u003eint\u003c/span\u003e statusCode, String contentType, String content)\u003c/span\u003e \u003c/span\u003e{\n    ctx.request().response() \u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\n            .putHeader(\u003cspan class=\"hljs-string\"\u003e\u0026quot;content-type\u0026quot;\u003c/span\u003e, contentType) \u003cspan class=\"hljs-comment\"\u003e//\u003c/span\u003e\n            .setStatusCode(statusCode)\n            .end(content);\n}\n\u003c/code\u003e\u003c/pre\u003e\u003ch2 id=\"more-examples\"\u003e\u003ca aria-hidden=\"true\" tabindex=\"-1\" class=\"heading-anchor\" href=\"#more-examples\"\u003e\u003c/a\u003eMore examples\u003c/h2\u003e\u003cp\u003eThis con­cludes the Key­cloak in­te­gra­tion ex­am­ple.\u003c/p\u003e\u003cp\u003eCheck out the com­plete ex­am­ple in \u003ca href=\"https://github.com/thomasdarimont/vertx-playground/tree/master/keycloak-vertx\"\u003ekeycloak-​vertx Ex­am­ples Repo\u003c/a\u003e.\u003c/p\u003e\u003cp\u003eThank you for your time, stay tuned for more up­dates! If you want to learn more about Key­cloak, feel free to reach out to me. You can find me via \u003ca href=\"https://twitter.com/thomasdarimont\"\u003ethomas­da­ri­mont on twit­ter\u003c/a\u003e.\u003c/p\u003e\u003cp\u003eHappy Hack­ing!\u003c/p\u003e","scope":{}}},"prevPost":{"meta":{"title":"Eclipse Vert.x 3.9.0 released!","category":"releases","authors":[{"name":"Julien Viet","github_id":"vietj"}],"summary":"New features include fluent queries in SQL clients, a new Redis client, an updated Kafka client, an improved Future API, and many more things."},"date":"2020-04-02","slug":"eclipse-vert-x-3-9-0-released"},"nextPost":{"meta":{"title":"Eclipse Vert.x 3.8.5","category":"releases","authors":[{"name":"Julien Viet","github_id":"vietj"}],"summary":"This version is a minor bug fix release addressing issues found in Vert.x 3.8.4. We would like to thank you all for reporting these issues."},"date":"2020-01-24","slug":"eclipse-vert-x-3-8-5"},"relatedPosts":[{"meta":{"title":"JWT Authorization for Vert.x with Keycloak","category":"guides","authors":[{"name":"Thomas Darimont","github_id":"thomasdarimont"}],"summary":"In this blog post, you'll learn about JWT foundations, protect routes with JWT Authorization, JWT encoded tokens, and RBAC with Keycloak"},"date":"2020-10-01","slug":"jwt-authorization-for-vert-x-with-keycloak"},{"meta":{"title":"Some Rest with Vert.x","category":"guides","authors":[{"name":"Clement Escoffier","github_id":"cescoffier"}],"summary":"This post is part of the Introduction to Vert.x series. Let’s go a bit further this time and develop a CRUD-ish application"},"date":"2015-07-27","slug":"some-rest-with-vert-x"},{"meta":{"title":"Real-time bidding with Websockets and Vert.x","category":"guides","authors":[{"name":"Marcin Warczyglowa","github_id":"mwarc"}],"summary":"The expectations of users for interactivity with web applications have changed over the past few years.\n    Users during bidding in auction no longer want to press the refresh button."},"date":"2016-01-15","slug":"real-time-bidding-with-websockets-and-vert-x"}]},"__N_SSG":true},"page":"/blog/[[...slug]]","query":{"slug":["easy-sso-for-vert-x-with-keycloak"]},"buildId":"ECgwwQLLt62Nn6gway29D","nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="/_next/static/chunks/polyfills-9a5c89434732593ca2fd.js"></script><script src="/_next/static/chunks/main-b6e20584df76f29b6f35.js" async=""></script><script src="/_next/static/chunks/webpack-d7b2fb72fb7257504a38.js" async=""></script><script src="/_next/static/chunks/framework.fcef98db13e2318579fb.js" async=""></script><script src="/_next/static/chunks/commons.5b8771ac6e8a338f82f1.js" async=""></script><script src="/_next/static/chunks/styles.7064a0f84b2a7c13404a.js" async=""></script><script src="/_next/static/chunks/pages/_app-3dbbc9c041333077c167.js" async=""></script><script src="/_next/static/chunks/5df0631eea625b022d3730b3f1bf573e1b8deb37.3b9874ba65db13e7d868.js" async=""></script><script src="/_next/static/chunks/pages/blog/%5B%5B...slug%5D%5D-c36bc482402d8ffe42a5.js" async=""></script><script src="/_next/static/ECgwwQLLt62Nn6gway29D/_buildManifest.js" async=""></script><script src="/_next/static/ECgwwQLLt62Nn6gway29D/_ssgManifest.js" async=""></script></body></html>