{"pageProps":{"slug":"vertx-health-check/java","title":"Vert.x Health Checks","fallbackGitHubStars":null,"toc":"<div id=\"toc\" class=\"toc\">\n<div id=\"toctitle\">Table of Contents</div>\n<ul class=\"sectlevel1\">\n<li><a href=\"#_using_vert_x_health_checks\">Using Vert.x Health Checks</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_creating_the_health_check_object\">Creating the health check object.</a></li>\n<li><a href=\"#_registering_the_vert_x_web_handler\">Registering the Vert.x Web handler</a></li>\n</ul>\n</li>\n<li><a href=\"#_procedures\">Procedures</a></li>\n<li><a href=\"#_http_responses_and_json_output\">HTTP responses and JSON Output</a></li>\n<li><a href=\"#_examples_of_procedures\">Examples of procedures</a>\n<ul class=\"sectlevel2\">\n<li><a href=\"#_sql_client\">SQL client</a></li>\n<li><a href=\"#_service_availability\">Service availability</a></li>\n<li><a href=\"#_event_bus\">Event bus</a></li>\n</ul>\n</li>\n<li><a href=\"#_authentication\">Authentication</a></li>\n<li><a href=\"#_exposing_health_checks_on_the_event_bus\">Exposing health checks on the event bus</a></li>\n</ul>\n</div>","contents":"<h1>Vert.x Health Checks</h1>\n\n<div id=\"preamble\">\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>This component provides a simple way to expose health checks. Health checks are used to express the current state\nof the application in very simple terms: <em>UP</em> or <em>DOWN</em>. The health checks can be used individually, or in\ncombination to Vert.x Web or the event bus.</p>\n</div>\n<div class=\"paragraph\">\n<p>This component provides a Vert.x Web handler on which you\ncan register procedure testing the health of the application. The handler computes the final state and returns the\nresult as JSON.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_using_vert_x_health_checks\"><a class=\"anchor\" href=\"#_using_vert_x_health_checks\"></a>Using Vert.x Health Checks</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>Notice that you generally need Vert.x Web to use this component. In addition add the following dependency:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Maven (in your <code>pom.xml</code>):</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-xml\" data-lang=\"xml\"><span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">dependency</span>&gt;</span>\n <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">groupId</span>&gt;</span>io.vertx<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">groupId</span>&gt;</span>\n <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">artifactId</span>&gt;</span>vertx-health-check<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">artifactId</span>&gt;</span>\n <span class=\"hljs-tag\">&lt;<span class=\"hljs-name\">version</span>&gt;</span>4.0.2<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">version</span>&gt;</span>\n<span class=\"hljs-tag\">&lt;/<span class=\"hljs-name\">dependency</span>&gt;</span></code></pre>\n</div>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>Gradle (in your <code>build.gradle</code> file):</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-groovy\" data-lang=\"groovy\">compile <span class=\"hljs-string\">'io.vertx:vertx-health-check:4.0.2'</span></code></pre>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_creating_the_health_check_object\"><a class=\"anchor\" href=\"#_creating_the_health_check_object\"></a>Creating the health check object.</h3>\n<div class=\"paragraph\">\n<p>The central object is <code><a href=\"../../apidocs/io/vertx/ext/healthchecks/HealthChecks.html\">HealthChecks</a></code>. You can create a new instance using:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">HealthChecks hc = HealthChecks.create(vertx);\n\nhc.register(\n  <span class=\"hljs-string\">\"my-procedure\"</span>,\n  promise -&gt; promise.complete(Status.OK()));\n\n<span class=\"hljs-comment\">// Register with a timeout. The check fails if it does not complete in time.</span>\n<span class=\"hljs-comment\">// The timeout is given in ms.</span>\nhc.register(\n  <span class=\"hljs-string\">\"my-procedure\"</span>,\n  <span class=\"hljs-number\">2000</span>,\n  promise -&gt; promise.complete(Status.OK()));</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Once you have created this object you can register and unregister procedures. See more about this below.</p>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_registering_the_vert_x_web_handler\"><a class=\"anchor\" href=\"#_registering_the_vert_x_web_handler\"></a>Registering the Vert.x Web handler</h3>\n<div class=\"paragraph\">\n<p>To create the Vert.x Web handler managing your health check you can either:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>using an existing instance of <code><a href=\"../../apidocs/io/vertx/ext/healthchecks/HealthChecks.html\">HealthChecks</a></code></p>\n</li>\n<li>\n<p>let the handler create one instance for you.</p>\n</li>\n</ul>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">HealthCheckHandler healthCheckHandler1 = HealthCheckHandler.create(vertx);\n\nHealthCheckHandler healthCheckHandler2 = HealthCheckHandler\n  .createWithHealthChecks(HealthChecks.create(vertx));\n\nRouter router = Router.router(vertx);\n<span class=\"hljs-comment\">// Populate the router with routes...</span>\n<span class=\"hljs-comment\">// Register the health check handler</span>\nrouter.get(<span class=\"hljs-string\">\"/health*\"</span>).handler(healthCheckHandler1);\n<span class=\"hljs-comment\">// Or</span>\nrouter.get(<span class=\"hljs-string\">\"/ping*\"</span>).handler(healthCheckHandler2);</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Procedure registration can be directly made on the <code><a href=\"../../apidocs/io/vertx/ext/healthchecks/HealthCheckHandler.html\">HealthCheckHandler</a></code>\ninstance. Alternatively, if you have created the <code><a href=\"../../apidocs/io/vertx/ext/healthchecks/HealthChecks.html\">HealthChecks</a></code> instance\nbeforehand, you can register the procedure on this object directly. Registrations and unregistrations can be done at\nanytime, even after the route registration:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">HealthCheckHandler healthCheckHandler = HealthCheckHandler.create(vertx);\n\n<span class=\"hljs-comment\">// Register procedures</span>\n<span class=\"hljs-comment\">// It can be done after the route registration, or even at runtime</span>\nhealthCheckHandler.register(<span class=\"hljs-string\">\"my-procedure-name\"</span>, promise -&gt; {\n  <span class=\"hljs-comment\">// Do the check ....</span>\n  <span class=\"hljs-comment\">// Upon success do</span>\n  promise.complete(Status.OK());\n  <span class=\"hljs-comment\">// In case of failure do:</span>\n  promise.complete(Status.KO());\n});\n\n<span class=\"hljs-comment\">// Register another procedure with a timeout (2s). If the procedure does not complete in</span>\n<span class=\"hljs-comment\">// the given time, the check fails.</span>\nhealthCheckHandler.register(\n  <span class=\"hljs-string\">\"my-procedure-name-with-timeout\"</span>,\n  <span class=\"hljs-number\">2000</span>,\n  promise -&gt; {\n    <span class=\"hljs-comment\">// Do the check ....</span>\n    <span class=\"hljs-comment\">// Upon success do</span>\n    promise.complete(Status.OK());\n    <span class=\"hljs-comment\">// In case of failure do:</span>\n    promise.complete(Status.KO());\n  });\n\nrouter.get(<span class=\"hljs-string\">\"/health\"</span>).handler(healthCheckHandler);</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_procedures\"><a class=\"anchor\" href=\"#_procedures\"></a>Procedures</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>A procedure is a function checking some aspect of the system to deduce the current health. It reports a\n<code><a href=\"../../apidocs/io/vertx/ext/healthchecks/Status.html\">Status</a></code> indicating whether or not the test has passed or failed. This function\nmust not block and report to the given <code><a href=\"../../apidocs/io/vertx/core/Promise.html\">Promise</a></code> whether or not it succeed.</p>\n</div>\n<div class=\"paragraph\">\n<p>When you register a procedure, you give a name, and the function (handler) executing the check.</p>\n</div>\n<div class=\"paragraph\">\n<p>Rules deducing the status are the following</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>if the promise is mark as failed, the check is considered as <em>KO</em></p>\n</li>\n<li>\n<p>if the promise is completed successfully but without a <code><a href=\"../../apidocs/io/vertx/ext/healthchecks/Status.html\">Status</a></code>, the check\nis considered as <em>OK</em>.</p>\n</li>\n<li>\n<p>if the promise is completed successfully with a <code><a href=\"../../apidocs/io/vertx/ext/healthchecks/Status.html\">Status</a></code> marked as <em>OK</em>,\nthe check is considered as <em>OK</em>.</p>\n</li>\n<li>\n<p>if the promise is completed successfully with a <code><a href=\"../../apidocs/io/vertx/ext/healthchecks/Status.html\">Status</a></code> marked as <em>KO</em>,\nthe check is considered as <em>KO</em>.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p><code><a href=\"../../apidocs/io/vertx/ext/healthchecks/Status.html\">Status</a></code> can also provide additional data:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">HealthCheckHandler healthCheckHandler = HealthCheckHandler.create(vertx);\n\n<span class=\"hljs-comment\">// Status can provide addition data provided as JSON</span>\nhealthCheckHandler.register(<span class=\"hljs-string\">\"my-procedure-name\"</span>, promise -&gt; {\n  promise.complete(Status.OK(<span class=\"hljs-keyword\">new</span> JsonObject().put(<span class=\"hljs-string\">\"available-memory\"</span>, <span class=\"hljs-string\">\"2mb\"</span>)));\n});\n\nhealthCheckHandler.register(<span class=\"hljs-string\">\"my-second-procedure-name\"</span>, promise -&gt; {\n  promise.complete(Status.KO(<span class=\"hljs-keyword\">new</span> JsonObject().put(<span class=\"hljs-string\">\"load\"</span>, <span class=\"hljs-number\">99</span>)));\n});\n\nrouter.get(<span class=\"hljs-string\">\"/health\"</span>).handler(healthCheckHandler);</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>Procedures can be organised by groups. The procedure name indicates the group. The procedures are organized as a\ntree and the structure is mapped to HTTP urls (see below).</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">HealthCheckHandler healthCheckHandler = HealthCheckHandler.create(vertx);\n\n<span class=\"hljs-comment\">// Register procedures</span>\n<span class=\"hljs-comment\">// Procedure can be grouped. The group is deduced using a name with \"/\".</span>\n<span class=\"hljs-comment\">// Groups can contains other group</span>\nhealthCheckHandler.register(\n  <span class=\"hljs-string\">\"a-group/my-procedure-name\"</span>,\n  promise -&gt; {\n    <span class=\"hljs-comment\">//....</span>\n  });\nhealthCheckHandler.register(\n  <span class=\"hljs-string\">\"a-group/a-second-group/my-second-procedure-name\"</span>,\n  promise -&gt; {\n    <span class=\"hljs-comment\">//....</span>\n  });\n\nrouter.get(<span class=\"hljs-string\">\"/health\"</span>).handler(healthCheckHandler);</code></pre>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_http_responses_and_json_output\"><a class=\"anchor\" href=\"#_http_responses_and_json_output\"></a>HTTP responses and JSON Output</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>When using the Vert.x web handler, the overall health check is retrieved using a HTTP GET or POST (depending on\nthe route you registered) on the route given when exposing the\n<code><a href=\"../../apidocs/io/vertx/ext/healthchecks/HealthCheckHandler.html\">HealthCheckHandler</a></code>.</p>\n</div>\n<div class=\"paragraph\">\n<p>If no procedure are registered, the response is <code>204 - NO CONTENT</code>, indicating that the system is <em>UP</em> but no\nprocedures has been executed. The response does not contain a payload.</p>\n</div>\n<div class=\"paragraph\">\n<p>If there is at least one procedure registered, this procedure is executed and the outcome status is computed. The\nresponse would use the following status code:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p><code>200</code> : Everything is fine</p>\n</li>\n<li>\n<p><code>503</code> : At least one procedure has reported a non-healthy state</p>\n</li>\n<li>\n<p><code>500</code> : One procedure has thrown an error or has not reported a status in time</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>The content is a JSON document indicating the overall result (<code>outcome</code>). It&#8217;s either <code>UP</code> or <code>DOWN</code>. A <code>checks</code>\narray is also given indicating the result of the different executed procedures. If the procedure has reported\nadditional data, the data is also given:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code>{\n\"checks\" : [\n{\n  \"id\" : \"A\",\n  \"status\" : \"UP\"\n},\n{\n  \"id\" : \"B\",\n  \"status\" : \"DOWN\",\n  \"data\" : {\n    \"some-data\" : \"some-value\"\n  }\n}\n],\n\"outcome\" : \"DOWN\"\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>In case of groups/ hierarchy, the <code>checks</code> array depicts this structure:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code>{\n\"checks\" : [\n{\n  \"id\" : \"my-group\",\n  \"status\" : \"UP\",\n  \"checks\" : [\n  {\n    \"id\" : \"check-2\",\n    \"status\" : \"UP\",\n  },\n  {\n    \"id\" : \"check-1\",\n    \"status\" : \"UP\"\n  }]\n}],\n\"outcome\" : \"UP\"\n}</code></pre>\n</div>\n</div>\n<div class=\"paragraph\">\n<p>If a procedure throws an error, reports a failure (exception), the JSON document provides the <code>cause</code> in the\n<code>data</code> section. If a procedure does not report back before a timeout, the indicated cause is <code>Timeout</code>.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_examples_of_procedures\"><a class=\"anchor\" href=\"#_examples_of_procedures\"></a>Examples of procedures</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>This section provides example of common health checks.</p>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_sql_client\"><a class=\"anchor\" href=\"#_sql_client\"></a>SQL client</h3>\n<div class=\"paragraph\">\n<p>This check reports whether a connection to the database can be established:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">handler.register(<span class=\"hljs-string\">\"database\"</span>,\n  promise -&gt; pool.getConnection(connection -&gt; {\n    <span class=\"hljs-keyword\">if</span> (connection.failed()) {\n      promise.fail(connection.cause());\n    } <span class=\"hljs-keyword\">else</span> {\n      connection.result().close();\n      promise.complete(Status.OK());\n    }\n  }));</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_service_availability\"><a class=\"anchor\" href=\"#_service_availability\"></a>Service availability</h3>\n<div class=\"paragraph\">\n<p>This check reports whether or not a service (here a HTTP endpoint) is available in the service discovery:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">handler.register(<span class=\"hljs-string\">\"my-service\"</span>,\n  promise -&gt;\n    HttpEndpoint.getClient(discovery, rec -&gt; <span class=\"hljs-string\">\"my-service\"</span>.equals(rec.getName()),\n      client -&gt; {\n        <span class=\"hljs-keyword\">if</span> (client.failed()) {\n          promise.fail(client.cause());\n        } <span class=\"hljs-keyword\">else</span> {\n          client.result().close();\n          promise.complete(Status.OK());\n        }\n      }));</code></pre>\n</div>\n</div>\n</div>\n<div class=\"sect2\">\n<h3 id=\"_event_bus\"><a class=\"anchor\" href=\"#_event_bus\"></a>Event bus</h3>\n<div class=\"paragraph\">\n<p>This check reports whether a consumer is ready on the event bus. The protocol, in this example, is a simple\nping/pong, but it can be more sophisticated. This check can be used to check whether or not a verticle is ready\nif it&#8217;s listening on a specific event address.</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">handler.register(<span class=\"hljs-string\">\"receiver\"</span>,\n  promise -&gt;\n    vertx.eventBus().request(<span class=\"hljs-string\">\"health\"</span>, <span class=\"hljs-string\">\"ping\"</span>)\n      .onSuccess(msg -&gt; {\n        promise.complete(Status.OK());\n      })\n      .onFailure(err -&gt; {\n        promise.complete(Status.KO());\n      }));</code></pre>\n</div>\n</div>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_authentication\"><a class=\"anchor\" href=\"#_authentication\"></a>Authentication</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>When using the Vert.x web handler, you can pass a <code><a href=\"../../apidocs/io/vertx/ext/auth/authentication/AuthenticationProvider.html\">AuthenticationProvider</a></code> use to authenticate the\nrequest. Check &lt;a href=\"http://vertx.io/docs/#authentication_and_authorisation\"&gt;Vert.x Auth&lt;/a&gt; for more details\nabout available authentication providers.</p>\n</div>\n<div class=\"paragraph\">\n<p>The Vert.x Web handler creates a JSON object containing:</p>\n</div>\n<div class=\"ulist\">\n<ul>\n<li>\n<p>the request headers</p>\n</li>\n<li>\n<p>the request params</p>\n</li>\n<li>\n<p>the form param if any</p>\n</li>\n<li>\n<p>the content as JSON if any and if the request set the content type to <code>application/json</code>.</p>\n</li>\n</ul>\n</div>\n<div class=\"paragraph\">\n<p>The resulting object is passed to the auth provider to authenticate the request. If the authentication failed, it\nreturns a <code>403 - FORBIDDEN</code> response.</p>\n</div>\n</div>\n</div>\n<div class=\"sect1\">\n<h2 id=\"_exposing_health_checks_on_the_event_bus\"><a class=\"anchor\" href=\"#_exposing_health_checks_on_the_event_bus\"></a>Exposing health checks on the event bus</h2>\n<div class=\"sectionbody\">\n<div class=\"paragraph\">\n<p>While exposing the health checks using HTTP with the Vert.x web handler is convenient, it can be useful\nto expose the data differently. This section gives an example to expose the data on the event bus:</p>\n</div>\n<div class=\"listingblock\">\n<div class=\"content\">\n<pre class=\"highlight\"><code class=\"language-java\" data-lang=\"java\">vertx.eventBus().consumer(<span class=\"hljs-string\">\"health\"</span>,\n  message -&gt; healthChecks.checkStatus()\n    .onSuccess(message::reply)\n    .onFailure(err -&gt; message.fail(<span class=\"hljs-number\">0</span>, err.getMessage())));</code></pre>\n</div>\n</div>\n</div>\n</div>"},"__N_SSG":true}