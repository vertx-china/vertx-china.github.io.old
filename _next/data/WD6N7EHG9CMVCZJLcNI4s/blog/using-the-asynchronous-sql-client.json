{"pageProps":{"categories":["releases","guides","news"],"post":{"meta":{"title":"Using the asynchronous SQL client","category":"guides","authors":[{"name":"Clement Escoffier","github_id":"cescoffier"}],"summary":"Finally, back... This post is the fifth post of the introduction to vert.x blog series, after a not-that-small break. In this post we are going to see how we can use JDBC in a vert.x application."},"date":"2015-10-19","slug":"using-the-asynchronous-sql-client","readingTime":{"text":"10 min read","minutes":9.02,"time":541200,"words":1804},"content":{"compiledSource":"var d=Object.defineProperty,h=Object.defineProperties;var m=Object.getOwnPropertyDescriptors;var o=Object.getOwnPropertySymbols;var i=Object.prototype.hasOwnProperty,r=Object.prototype.propertyIsEnumerable;var p=(a,n,s)=>n in a?d(a,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):a[n]=s,e=(a,n)=>{for(var s in n||(n={}))i.call(n,s)&&p(a,s,n[s]);if(o)for(var s of o(n))r.call(n,s)&&p(a,s,n[s]);return a},l=(a,n)=>h(a,m(n));var c=(a,n)=>{var s={};for(var t in a)i.call(a,t)&&n.indexOf(t)<0&&(s[t]=a[t]);if(a!=null&&o)for(var t of o(a))n.indexOf(t)<0&&r.call(a,t)&&(s[t]=a[t]);return s};const makeShortcode=a=>function(s){return console.warn(\"Component \"+a+\" was not imported, exported, or provided by MDXProvider as global scope\"),mdx(\"div\",e({},s))},Link=makeShortcode(\"Link\"),Alert=makeShortcode(\"Alert\"),layoutProps={},MDXLayout=\"wrapper\";function MDXContent(s){var t=s,{components:a}=t,n=c(t,[\"components\"]);return mdx(MDXLayout,l(e(e({},layoutProps),n),{components:a,mdxType:\"MDXLayout\"}),mdx(\"p\",null,\"Fi\\xADnally, back\\u2026 This post is the fifth post of the in\\xADtro\\xADduc\\xADtion to vert.x blog se\\xADries, after a not-\\u200Bthat-small break. In this post we are going to see how we can use JDBC in a vert.x ap\\xADpli\\xADca\\xADtion, and this, using the asyn\\xADchro\\xADnous API pro\\xADvided by the \",mdx(Link,{href:\"/docs/vertx-jdbc-client/java/\",passHref:!0,mdxType:\"Link\"},mdx(\"a\",e({parentName:\"p\"},{href:\"\"}),\"vertx-\\u200Bjdbc-client\")),\".\"),mdx(\"h2\",e({},{id:\"previously-in-the-introduction-to-vertx-series\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#previously-in-the-introduction-to-vertx-series\"})),\"Previously in the introduction to vert.x series\"),mdx(\"p\",null,\"As it was quite some time since the last post, let\\u2019s start by re\\xADfresh\\xADing our mind about the four pre\\xADvi\\xADous posts:\"),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},\"The \",mdx(Link,{href:\"/blog/my-first-vert-x-3-application/\",passHref:!0,mdxType:\"Link\"},mdx(\"a\",e({parentName:\"li\"},{href:\"\"}),\"first post\")),\" has de\\xADscribed how to build a vert.x ap\\xADpli\\xADca\\xADtion with Maven and ex\\xADe\\xADcute unit tests.\"),mdx(\"li\",{parentName:\"ol\"},\"The \",mdx(Link,{href:\"/blog/vert-x-application-configuration/\",passHref:!0,mdxType:\"Link\"},mdx(\"a\",e({parentName:\"li\"},{href:\"\"}),\"sec\\xADond post\")),\" has de\\xADscribed how this ap\\xADpli\\xADca\\xADtion can be\\xADcome con\\xADfig\\xADurable.\"),mdx(\"li\",{parentName:\"ol\"},\"The \",mdx(Link,{href:\"/blog/some-rest-with-vert-x/\",passHref:!0,mdxType:\"Link\"},mdx(\"a\",e({parentName:\"li\"},{href:\"\"}),\"third post\")),\" has in\\xADtro\\xADduced \",mdx(Link,{href:\"/docs/vertx-web/java/\",passHref:!0,mdxType:\"Link\"},mdx(\"a\",e({parentName:\"li\"},{href:\"\"}),\"vertx-\\u200Bweb\")),\", and a small col\\xADlec\\xADtion man\\xADage\\xADment ap\\xADpli\\xADca\\xADtion has been de\\xADvel\\xADoped. This ap\\xADpli\\xADca\\xADtion of\\xADfers a REST API used by a HTML/JavaScript fron\\xADtend.\"),mdx(\"li\",{parentName:\"ol\"},\"The \",mdx(Link,{href:\"/blog/unit-and-integration-tests/\",passHref:!0,mdxType:\"Link\"},mdx(\"a\",e({parentName:\"li\"},{href:\"\"}),\"pre\\xADvi\\xADous post\")),\" has pre\\xADsented how you can run in\\xADte\\xADgra\\xADtion tests to en\\xADsure the be\\xADhav\\xADior of your ap\\xADpli\\xADca\\xADtion.\")),mdx(\"p\",null,\"In this post, back to code. The cur\\xADrent ap\\xADpli\\xADca\\xADtion uses an in-\\u200Bmemory map to store the prod\\xADucts. It\\u2019s time to use a data\\xADbase. In this post we are going to use \",mdx(\"a\",e({parentName:\"p\"},{href:\"http://hsqldb.org/\"}),\"HSQL\"),\", but you can use any data\\xADbase pro\\xADvid\\xADing a JDBC dri\\xADver. In\\xADter\\xADac\\xADtions with the data\\xADbase will be asyn\\xADchro\\xADnous and made using the \",mdx(Link,{href:\"/docs/vertx-jdbc-client/java/\",passHref:!0,mdxType:\"Link\"},mdx(\"a\",e({parentName:\"p\"},{href:\"\"}),\"vertx-\\u200Bjdbc-client\")),\".\"),mdx(\"p\",null,\"The code of this post are avail\\xADable on this Github \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/cescoffier/my-vertx-first-app\"}),\"project\"),\", in the \",mdx(\"a\",e({parentName:\"p\"},{href:\"https://github.com/cescoffier/my-vertx-first-app/tree/post-5\"}),\"post-5 branch\"),\" branch.\"),mdx(\"h2\",e({},{id:\"asynchronous\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#asynchronous\"})),\"Asynchronous?\"),mdx(\"p\",null,\"One of the vert.x char\\xADac\\xADter\\xADis\\xADtics is being asyn\\xADchro\\xADnous. With an asyn\\xADchro\\xADnous API, you don\\u2019t wait for a re\\xADsult, but you are no\\xADti\\xADfied when this re\\xADsult is ready. Just to il\\xADlus\\xADtrate this, let\\u2019s take a very sim\\xADple ex\\xADam\\xADple.\"),mdx(\"p\",null,\"Let\\u2019s imag\\xADine an \",mdx(\"inlineCode\",{parentName:\"p\"},\"add\"),\" method. Tra\\xADdi\\xADtion\\xADally, you would use it like this: \",mdx(\"inlineCode\",{parentName:\"p\"},\"int r = add(1, 1)\"),\". This is a syn\\xADchro\\xADnous API as you are wait\\xADing for the re\\xADsult. An asyn\\xADchro\\xADnous ver\\xADsion of this API would be: \",mdx(\"inlineCode\",{parentName:\"p\"},\"add(1, 1, r -> { /* do something with the result */ })\"),\". In this ver\\xADsion, you pass a \",mdx(\"inlineCode\",{parentName:\"p\"},\"Handler\"),\" called when the re\\xADsult has been com\\xADputed. The method does not re\\xADturn any\\xADthing, and could be im\\xADple\\xADmented as:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"public\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"void\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-title\"}),\"add\"),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-params\"}),\"(\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"int\"),\" a, \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"int\"),\" b, Handler<Integer> resultHandler)\"),\" \"),`{\n    `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"int\"),` r = a + b;\n    resultHandler.handle(r);\n}\n`)),mdx(\"p\",null,\"Just to avoid mis\\xADcon\\xADcep\\xADtions, asyn\\xADchro\\xADnous API are not about threads. As we can see in the \",mdx(\"inlineCode\",{parentName:\"p\"},\"add\"),\" ex\\xADam\\xADple, there are no threads in\\xADvolved.\"),mdx(\"h2\",e({},{id:\"jdbc-yes-but-asynchronous\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#jdbc-yes-but-asynchronous\"})),\"JDBC yes, but asynchronous\"),mdx(\"p\",null,\"So, now that we have seen some ba\\xADsics about asyn\\xADchro\\xADnous API, let\\u2019s have a look to the vertx-\\u200Bjdbc-client. This com\\xADpo\\xADnent lets us in\\xADter\\xADact with a data\\xADbase through a JDBC dri\\xADver. These in\\xADter\\xADac\\xADtions are asyn\\xADchro\\xADnous, so when you were doing:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),\"String sql = \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"SELECT * FROM Products\"'),`;\nResultSet rs = stmt.executeQuery(sql);\n`)),mdx(\"p\",null,\"it will be:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),\"connection.query(\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"SELECT * FROM Products\"'),`, result -> {\n        `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-comment\"}),\"// do something with the result\"),`\n});\n`)),mdx(\"p\",null,\"This model is more ef\\xADfi\\xADcient as it avoids wait\\xADing for the re\\xADsult. You are no\\xADti\\xADfied when the re\\xADsult is avail\\xADable.\"),mdx(\"p\",null,\"Let\\u2019s now mod\\xADify our ap\\xADpli\\xADca\\xADtion to use a data\\xADbase to store our prod\\xADucts.\"),mdx(\"h2\",e({},{id:\"some-maven-dependencies\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#some-maven-dependencies\"})),\"Some maven dependencies\"),mdx(\"p\",null,\"The first things we need to do it to de\\xADclare two new Maven de\\xADpen\\xADden\\xADcies in our \",mdx(\"inlineCode\",{parentName:\"p\"},\"pom.xml\"),\" file:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-xml\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"<\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"dependency\"),\">\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"<\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"groupId\"),\">\"),\"io.vertx\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"</\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"groupId\"),\">\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"<\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"artifactId\"),\">\"),\"vertx-jdbc-client\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"</\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"artifactId\"),\">\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"<\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"version\"),\">\"),\"3.1.0\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"</\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"version\"),\">\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"</\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"dependency\"),\">\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"<\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"dependency\"),\">\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"<\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"groupId\"),\">\"),\"org.hsqldb\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"</\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"groupId\"),\">\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"<\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"artifactId\"),\">\"),\"hsqldb\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"</\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"artifactId\"),\">\"),`\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"<\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"version\"),\">\"),\"2.3.3\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"</\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"version\"),\">\"),`\n`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-tag\"}),\"</\",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-name\"}),\"dependency\"),\">\"),`\n`)),mdx(\"p\",null,\"The first de\\xADpen\\xADdency pro\\xADvides the vertx-\\u200Bjdbc-client, while the sec\\xADond one pro\\xADvide the HSQL JDBC dri\\xADver. If you want to use an\\xADother data\\xADbase, change this de\\xADpen\\xADdency. You will also need to change the JDBC url and JDBC dri\\xADver class name later.\"),mdx(\"h2\",e({},{id:\"initializing-the-jdbc-client\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#initializing-the-jdbc-client\"})),\"Initializing the JDBC client\"),mdx(\"p\",null,\"Now that we have added these de\\xADpen\\xADden\\xADcies, it\\u2019s time to cre\\xADate our JDBC client:\"),mdx(\"p\",null,\"In the \",mdx(\"inlineCode\",{parentName:\"p\"},\"MyFirstVerticle\"),\" class, de\\xADclare a new field \",mdx(\"inlineCode\",{parentName:\"p\"},\"JDBCClient jdbc;\"),\", and add the fol\\xADlow\\xADing line at the be\\xADgin\\xADning of the \",mdx(\"inlineCode\",{parentName:\"p\"},\"start\"),\" method:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),\"jdbc = JDBCClient.createShared(vertx, config(), \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"My-Whisky-Collection\"'),`);\n`)),mdx(\"p\",null,\"This cre\\xADates an in\\xADstance of JDBC client, con\\xADfig\\xADured with the con\\xADfig\\xADu\\xADra\\xADtion pro\\xADvided to the ver\\xADti\\xADcle. To work cor\\xADrectly this con\\xADfig\\xADu\\xADra\\xADtion needs to pro\\xADvide:\"),mdx(\"ul\",null,mdx(\"li\",{parentName:\"ul\"},mdx(\"em\",{parentName:\"li\"},\"url\"),\" - the JDBC url such as \",mdx(\"inlineCode\",{parentName:\"li\"},\"jdbc:hsqldb:mem:db?shutdown=true\")),mdx(\"li\",{parentName:\"ul\"},mdx(\"em\",{parentName:\"li\"},\"dri\\xADver_class\"),\" - the JDBC dri\\xADver class such as \",mdx(\"inlineCode\",{parentName:\"li\"},\"org.hsqldb.jdbcDriver\"))),mdx(\"p\",null,\"Ok, we have the client, we need a con\\xADnec\\xADtion to the data\\xADbase. This is achieved using the \",mdx(\"inlineCode\",{parentName:\"p\"},\"jdbc.getConnection\"),\" that take a \",mdx(\"inlineCode\",{parentName:\"p\"},\"Handler<AsyncResult<SQLConnection>>\"),\" as pa\\xADra\\xADme\\xADter. Let\\u2019s have a deeper look to this type. It\\u2019s a \",mdx(\"inlineCode\",{parentName:\"p\"},\"Handler\"),\", so it is called when the re\\xADsult is ready. This re\\xADsult is an in\\xADstance of \",mdx(\"inlineCode\",{parentName:\"p\"},\"AsyncResult<SQLConnection>\"),\". \",mdx(\"inlineCode\",{parentName:\"p\"},\"AsyncResult\"),\" is a struc\\xADture pro\\xADvided by vert.x that lets us know if the op\\xADer\\xADa\\xADtion was com\\xADpleted suc\\xADcess\\xADfully or failed. In case of suc\\xADcess, it pro\\xADvides the re\\xADsult, here an in\\xADstance of \",mdx(\"inlineCode\",{parentName:\"p\"},\"SQLConnection\"),\".\"),mdx(\"p\",null,\"When you re\\xADceive an in\\xADstance of \",mdx(\"inlineCode\",{parentName:\"p\"},\"AsyncResult\"),\", your code gen\\xADer\\xADally looks like:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),` (ar.failed()) {\n  System.err.println(`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"The operation has failed...: \"'),`\n      + ar.cause().getMessage());\n} `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),` {\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-comment\"}),\"// Use the result:\"),`\n  result = ar.result();\n }\n`)),mdx(\"p\",null,\"So, let\\u2019s go back to our \",mdx(\"inlineCode\",{parentName:\"p\"},\"SQLConnection\"),\". We need to re\\xADtrieve it, and then start the rest of the ap\\xADpli\\xADca\\xADtion. This changes how we start the ap\\xADpli\\xADca\\xADtion, as it will be\\xADcome asyn\\xADchro\\xADnous. So, if we di\\xADvide our startup se\\xADquence into small chunks it would be some\\xADthing like:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),`startBackend(\n (connection) -> createSomeData(connection,\n     (nothing) -> startWebApp(\n         (http) -> completeStartup(http, fut)\n     ), fut\n ), fut);\n`)),mdx(\"p\",null,\"with:\"),mdx(\"ol\",null,mdx(\"li\",{parentName:\"ol\"},mdx(\"inlineCode\",{parentName:\"li\"},\"startBackend\"),\" - re\\xADtrieves a \",mdx(\"inlineCode\",{parentName:\"li\"},\"SQLConnection\"),\" and then calls the next step\"),mdx(\"li\",{parentName:\"ol\"},mdx(\"inlineCode\",{parentName:\"li\"},\"createSomeData\"),\" - ini\\xADtial\\xADizes the data\\xADbase and in\\xADserts some data. When done, it calls the next step\"),mdx(\"li\",{parentName:\"ol\"},mdx(\"inlineCode\",{parentName:\"li\"},\"startWebApp\"),\" - starts our web ap\\xADpli\\xADca\\xADtion\"),mdx(\"li\",{parentName:\"ol\"},mdx(\"inlineCode\",{parentName:\"li\"},\"completeStartup\"),\" - fi\\xADnal\\xADizes our start se\\xADquence\")),mdx(\"p\",null,mdx(\"inlineCode\",{parentName:\"p\"},\"fut\"),\" is the com\\xADple\\xADtion fu\\xADture passed by vert.x that let us re\\xADport when we are started, or if an issue has been en\\xADcoun\\xADtered while start\\xADing.\"),mdx(\"p\",null,\"Let\\u2019s have a look to \",mdx(\"inlineCode\",{parentName:\"p\"},\"startBackend\"),\":\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"private\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"void\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-title\"}),\"startBackend\"),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-params\"}),\"(Handler<AsyncResult<SQLConnection>> next, Future<Void> fut)\"),\" \"),`{\n  jdbc.getConnection(ar -> {\n    `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),` (ar.failed()) {\n      fut.fail(ar.cause());\n    } `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),` {\n      next.handle(Future.succeededFuture(ar.result()));\n    }\n  });\n}\n`)),mdx(\"p\",null,\"This method re\\xADtrieves a \",mdx(\"inlineCode\",{parentName:\"p\"},\"SQLConnection\"),\", check whether this op\\xADer\\xADa\\xADtion suc\\xADceeded. If so, it calls the next step. In case of fail\\xADure, it re\\xADports it.\"),mdx(\"p\",null,\"The other meth\\xADods fol\\xADlow the same pat\\xADtern: 1) check if the last op\\xADer\\xADa\\xADtion has suc\\xADceeded, 2) do the task, 3) call the next step.\"),mdx(\"h3\",e({},{id:\"a-bit-of-sql\"}),mdx(\"a\",e({parentName:\"h3\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#a-bit-of-sql\"})),\"A bit of SQL\\u2026\"),mdx(\"p\",null,\"Our client is ready, let\\u2019s now write some SQL state\\xADments. Let\\u2019s start by the \",mdx(\"inlineCode\",{parentName:\"p\"},\"createSomeData\"),\" method that is part of the startup se\\xADquence:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"private\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"void\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-title\"}),\"createSomeData\"),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-params\"}),`(AsyncResult<SQLConnection> result,\n    Handler<AsyncResult<Void>> next, Future<Void> fut)`),\" \"),`{\n    `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),` (result.failed()) {\n      fut.fail(result.cause());\n    } `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),` {\n      SQLConnection connection = result.result();\n      connection.execute(\n          `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"CREATE TABLE IF NOT EXISTS Whisky (id INTEGER IDENTITY, name varchar(100), \"'),` +\n          `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"origin varchar(100))\"'),`,\n          ar -> {\n            `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),` (ar.failed()) {\n              fut.fail(ar.cause());\n              connection.close();\n              `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),`;\n            }\n            connection.query(`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"SELECT * FROM Whisky\"'),`, select -> {\n              `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),` (select.failed()) {\n                fut.fail(ar.cause());\n                connection.close();\n                `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),`;\n              }\n              `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),\" (select.result().getNumRows() == \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`) {\n                insert(\n                    `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"new\"),\" Whisky(\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"Bowmore 15 Years Laimrig\"'),\", \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"Scotland, Islay\"'),`),\n                    connection,\n                    (v) -> insert(`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"new\"),\" Whisky(\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"Talisker 57\\xB0 North\"'),\", \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"Scotland, Island\"'),`),\n                        connection,\n                        (r) -> {\n                          next.handle(Future.<Void>succeededFuture());\n                          connection.close();\n                        }));                                                    \n              } `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"else\"),` {\n                next.handle(Future.<Void>succeededFuture());\n                connection.close();\n              }\n            });\n          });\n    }\n  }\n`)),mdx(\"p\",null,\"This method checks that the \",mdx(\"inlineCode\",{parentName:\"p\"},\"SQLConnection\"),\" is avail\\xADable and then start ex\\xADe\\xADcut\\xADing some SQL state\\xADments. First, it cre\\xADates the ta\\xADbles if there are not there yet. As you can see, the method called is struc\\xADtured as fol\\xADlows:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),`connection.execute(\n    SQL statement,\n    handler called when the statement has been executed\n)\n`)),mdx(\"p\",null,\"The han\\xADdler re\\xADceives an \",mdx(\"inlineCode\",{parentName:\"p\"},\"AsyncResult<Void>\"),\", \",mdx(\"em\",{parentName:\"p\"},\"i.e.\"),\" a no\\xADti\\xADfi\\xADca\\xADtion of the com\\xADple\\xADtion with\\xADout an ac\\xADtual re\\xADsult.\"),mdx(Alert,{info:!0,title:\"Closing connection\",mdxType:\"Alert\"},mdx(\"p\",null,\"Don\\u2019t for\\xADget to close the SQL con\\xADnec\\xADtion when you are done. The con\\xADnec\\xADtion will be given back to the con\\xADnec\\xADtion pool and be reused.\")),mdx(\"p\",null,\"In the code of this han\\xADdler, we check whether or not the state\\xADment has been ex\\xADe\\xADcuted cor\\xADrectly, and if so we check to see if the table al\\xADready con\\xADtains some data, if not, it in\\xADserts data using the \",mdx(\"inlineCode\",{parentName:\"p\"},\"insert\"),\" method:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"private\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"void\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-title\"}),\"insert\"),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-params\"}),\"(Whisky whisky, SQLConnection connection, Handler<AsyncResult<Whisky>> next)\"),\" \"),`{\n  String sql = `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"INSERT INTO Whisky (name, origin) VALUES ?, ?\"'),`;\n  connection.updateWithParams(sql,\n      `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"new\"),` JsonArray().add(whisky.getName()).add(whisky.getOrigin()),\n      (ar) -> {\n        `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"if\"),` (ar.failed()) {\n          next.handle(Future.failedFuture(ar.cause()));\n          `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"return\"),`;\n        }\n        UpdateResult result = ar.result();\n        `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-comment\"}),\"// Build a new whisky instance with the generated id.\"),`\n        Whisky w = `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"new\"),\" Whisky(result.getKeys().getInteger(\",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-number\"}),\"0\"),`), whisky.getName(), whisky.getOrigin());\n        next.handle(Future.succeededFuture(w));\n      });\n}\n`)),mdx(\"p\",null,\"This method uses the \",mdx(\"inlineCode\",{parentName:\"p\"},\"updateWithParams\"),\" method with an \",mdx(\"em\",{parentName:\"p\"},\"IN\\xADSERT\"),\" state\\xADment, and pass val\\xADues. This ap\\xADproach avoids SQL in\\xADjec\\xADtion. Once the the state\\xADment has been ex\\xADe\\xADcuted, we cre\\xADates a new \",mdx(\"inlineCode\",{parentName:\"p\"},\"Whisky\"),\" ob\\xADject with the cre\\xADated (auto-\\u200Bgenerated) id.\"),mdx(\"h2\",e({},{id:\"some-rest-with-a-pinch-of-sql\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#some-rest-with-a-pinch-of-sql\"})),\"Some REST with a pinch of SQL\"),mdx(\"p\",null,\"The method de\\xADscribed  above is part of our start se\\xADquence. But what about the method in\\xADvoked by our REST API. Let\\u2019s have a look to the \",mdx(\"inlineCode\",{parentName:\"p\"},\"getAll\"),\" method. This method is called by the web front-\\u200Bend to re\\xADtrieve all stored prod\\xADucts:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),\" \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-function\"}),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"private\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-keyword\"}),\"void\"),\" \",mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-title\"}),\"getAll\"),mdx(\"span\",e({parentName:\"span\"},{className:\"hljs-params\"}),\"(RoutingContext routingContext)\"),\" \"),`{\n    jdbc.getConnection(ar -> {\n      SQLConnection connection = ar.result();\n      connection.query(`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"SELECT * FROM Whisky\"'),`, result -> {\n        List<Whisky> whiskies = result.result().getRows().stream().map(Whisky::`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"new\"),`).collect(Collectors.toList());\n        routingContext.response()\n            .putHeader(`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"content-type\"'),\", \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"application/json; charset=utf-8\"'),`)\n            .end(Json.encodePrettily(whiskies));\n        connection.close(); `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-comment\"}),\"// Close the connection     \"),`\n      });\n    });\n  }\n`)),mdx(\"p\",null,\"This method gets a \",mdx(\"inlineCode\",{parentName:\"p\"},\"SQLConnection\"),\", and then issue a query. Once the re\\xADsult has been re\\xADtrieved it writes the HTTP re\\xADsponse as be\\xADfore. The \",mdx(\"inlineCode\",{parentName:\"p\"},\"getOne\"),\", \",mdx(\"inlineCode\",{parentName:\"p\"},\"deleteOne\"),\", \",mdx(\"inlineCode\",{parentName:\"p\"},\"updateOne\"),\" and \",mdx(\"inlineCode\",{parentName:\"p\"},\"addOne\"),\" meth\\xADods fol\\xADlow the same pat\\xADtern. No\\xADtice that the con\\xADnec\\xADtion can be closed after the re\\xADsponse has been writ\\xADten.\"),mdx(\"p\",null,\"Let\\u2019s have a look to the re\\xADsult pro\\xADvided to the han\\xADdler passed to the \",mdx(\"inlineCode\",{parentName:\"p\"},\"query\"),\" method. It gets a \",mdx(\"inlineCode\",{parentName:\"p\"},\"ResultSet\"),\", which con\\xADtains the query re\\xADsult. Each row is a \",mdx(\"inlineCode\",{parentName:\"p\"},\"JsonObject\"),\", so if your data ob\\xADject has a con\\xADstruc\\xADtor tak\\xADing a \",mdx(\"inlineCode\",{parentName:\"p\"},\"JsonObject\"),\" as unique ar\\xADgu\\xADment, cre\\xADat\\xADing there ob\\xADjects is straight\\xADfor\\xADward.\"),mdx(\"h2\",e({},{id:\"test-test-and-test-again\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#test-test-and-test-again\"})),\"Test, test, and test again\"),mdx(\"p\",null,\"We need to slightly up\\xADdate our tests to con\\xADfig\\xADure the \",mdx(\"inlineCode\",{parentName:\"p\"},\"JDBCClient\"),\". In the \",mdx(\"inlineCode\",{parentName:\"p\"},\"MyFirstVertilceTest\"),\" class, change the \",mdx(\"inlineCode\",{parentName:\"p\"},\"DeploymentOption\"),\" ob\\xADject cre\\xADated in the \",mdx(\"inlineCode\",{parentName:\"p\"},\"setUp\"),\" method to be:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-java\"}),\"DeploymentOptions options = \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"new\"),` DeploymentOptions()\n    .setConfig(`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-keyword\"}),\"new\"),` JsonObject()\n        .put(`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"http.port\"'),`, port)\n        .put(`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"url\"'),\", \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"jdbc:hsqldb:mem:test?shutdown=true\"'),`)\n        .put(`,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"driver_class\"'),\", \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"org.hsqldb.jdbcDriver\"'),`)\n    );\n`)),mdx(\"p\",null,\"In ad\\xADdi\\xADtion to the \",mdx(\"inlineCode\",{parentName:\"p\"},\"http.port\"),\", we also put the JDBC url and the class of the JDBC dri\\xADver. We use an in-\\u200Bmemory data\\xADbase for tests.\"),mdx(\"p\",null,\"The same mod\\xADi\\xADfi\\xADca\\xADtion needs to be done in the \",mdx(\"inlineCode\",{parentName:\"p\"},\"src/test/resources/my-it-config.json\"),\" file:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-json\"}),`{\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-attr\"}),'\"http.port\"'),\": ${http.port},\\n  \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-attr\"}),'\"url\"'),\": \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"jdbc:hsqldb:mem:it-test?shutdown=true\"'),`,\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-attr\"}),'\"driver_class\"'),\": \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"org.hsqldb.jdbcDriver\"'),`\n}\n`)),mdx(\"p\",null,\"The \",mdx(\"inlineCode\",{parentName:\"p\"},\"src/main/conf/my-application-conf.json\"),\" file also needs to be up\\xADdated, not for the tests, but to run the ap\\xADpli\\xADca\\xADtion:\"),mdx(\"pre\",null,mdx(\"code\",e({parentName:\"pre\"},{className:\"hljs language-json\"}),`{\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-attr\"}),'\"http.port\"'),\" : \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-number\"}),\"8082\"),`,\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-attr\"}),'\"url\"'),\": \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"jdbc:hsqldb:file:db/whiskies\"'),`,\n  `,mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-attr\"}),'\"driver_class\"'),\": \",mdx(\"span\",e({parentName:\"code\"},{className:\"hljs-string\"}),'\"org.hsqldb.jdbcDriver\"'),`\n}\n`)),mdx(\"p\",null,\"The JDBC url is a bit dif\\xADfer\\xADent in this last file, as we store the data\\xADbase on the file sys\\xADtem.\"),mdx(\"h2\",e({},{id:\"show-time\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#show-time\"})),\"Show time!\"),mdx(\"p\",null,\"Let\\u2019s now build our ap\\xADpli\\xADca\\xADtion:\"),mdx(\"p\",null,mdx(\"inlineCode\",{parentName:\"p\"},\"mvn clean package\")),mdx(\"p\",null,\"As we didn\\u2019t change the API (nei\\xADther the pub\\xADlic java one nor the REST), test should run smoothly.\"),mdx(\"p\",null,\"Then launch the ap\\xADpli\\xADca\\xADtion with:\"),mdx(\"p\",null,mdx(\"inlineCode\",{parentName:\"p\"},\"java -jar target/my-first-app-1.0-SNAPSHOT-fat.jar -conf src/main/conf/my-application-conf.json \")),mdx(\"p\",null,\"Open your browser to \",mdx(\"inlineCode\",{parentName:\"p\"},\"http://localhost:8082/assets/index.html\"),\", and you should see the ap\\xADpli\\xADca\\xADtion using the data\\xADbase. This time the prod\\xADucts are stored in a data\\xADbase per\\xADsisted on the file sys\\xADtem. So, if we stop and restart the ap\\xADpli\\xADca\\xADtion, the data is re\\xADstored.\"),mdx(\"h2\",e({},{id:\"conclusion\"}),mdx(\"a\",e({parentName:\"h2\"},{\"aria-hidden\":!0,tabIndex:-1,className:\"heading-anchor\",href:\"#conclusion\"})),\"Conclusion\"),mdx(\"p\",null,\"In this post, we saw how you can use JDBC data\\xADbase with vert.x, and thus with\\xADout too much bur\\xADden. You may have been sur\\xADprised by the asyn\\xADchro\\xADnous de\\xADvel\\xADop\\xADment model, but once you start using it, it\\u2019s hard to come back.\"),mdx(\"p\",null,\"In the \",mdx(Link,{href:\"/blog/combine-vert-x-and-mongo-to-build-a-giant/\",passHref:!0,mdxType:\"Link\"},mdx(\"a\",e({parentName:\"p\"},{href:\"\"}),\"next post\")),\", we see how the same ap\\xADpli\\xADca\\xADtion can use Mon\\xADgoDB in\\xADstead of HSQL.\"),mdx(\"p\",null,\"Stay tuned, and happy cod\\xADing!\"))}MDXContent.isMDXComponent=!0;\n","scope":{}}},"prevPost":{"meta":{"title":"Vert.x ES6 back to the future","category":"guides","authors":[{"name":"Paulo Lopes","github_id":"pmlopes"}],"summary":"On October 21th, 2015 we all rejoiced with the return from the past of Marty McFly with his flying car and so on, however in the Vert.x world we were quite sad about our rather old JavaScript support."},"date":"2015-11-25","slug":"vert-x-es6-back-to-the-future"},"nextPost":{"meta":{"title":"Vert.x 3.1.0 is released!","category":"releases","authors":[{"name":"Tim Fox","github_id":"purplefox"}],"summary":"I'm pleased to announce the release of Vert.x 3.1!"},"date":"2015-10-08","slug":"vert-x-3-1-0-is-released"},"relatedPosts":[{"meta":{"title":"Unit and Integration Tests","category":"guides","authors":[{"name":"Clement Escoffier","github_id":"cescoffier"}],"summary":"Let’s refresh our mind about what we developed so far in the introduction to vert.x series. We forgot an important task. We didn’t test the API."},"date":"2015-08-03","slug":"unit-and-integration-tests"},{"meta":{"title":"Combine vert.x and mongo to build a giant","category":"guides","authors":[{"name":"Clement Escoffier","github_id":"cescoffier"}],"summary":"This blog post is part of the introduction to Vert.x series. We are now going to replace this JDBC client by the vertx-mongo-client, and thus connect to a Mongo database."},"date":"2015-11-30","slug":"combine-vert-x-and-mongo-to-build-a-giant"},{"meta":{"title":"My first Vert.x 3 Application","category":"guides","authors":[{"name":"Clement Escoffier","github_id":"cescoffier"}],"summary":"Let's say, you heard someone saying that Vert.x is awesome. Ok great, but you may want to try it by yourself. Well, the next natural question is “where do I start ?”"},"date":"2015-07-14","slug":"my-first-vert-x-3-application"}]},"__N_SSG":true}